#{File.read('/static/_bib_public_template.html')}
#{require_user_who_can_manage_bib!}
<div class='container bg-white' style="padding-top: 15px;">
    <h2 class="display_name"></h2>
    <!-- <div id='book_list' class="w-full grid grid-cols-12 gap-4 mb-4"></div> -->
    <hr />
    <h3>Ausgeliehene Medien</h3>
    <div id='book_table'></div>
    <button id='bu_checkout' class='btn btn-success'>Buch an <span class="display_name"></span> ausleihen</button>
    <div id='hint_no_verein' class='mt-3 alert alert-warning' style='display: none;'>Es können keine Bücher ausgeliehen werden, weil <span class="display_name"></span> nicht im Lehrmittelverein ist.</div>
    <div id='check_out_div' style='display: none; margin-top: 15px;'>
        <div class='row'>
            <div class="col-lg-6 col-md-6 col-sm-4">
                <p>
                    Bitte scanne alle Bücher, die ausgeliehen werden sollen.
                </p>
            </div>
            <div id='barcode_widget' class='col-12 col-sm-8 col-md-6 col-lg-6'>
            </div>
        </div>
    </div>
</div>
<script>
    var email = decodeURIComponent(window.location.pathname.replace('/bib_user/', ''));
    var table = null;
    var lehrmittelverein_state_cache = #{@@lehrmittelverein_state_cache.to_json};

    function row_clicked(stem) {
        window.location = `/bib_book/${stem}`;
        console.log(data);
    }

    function on_scan(barcode) {
        let parts = fix_scanned_book_barcode(barcode);
        if (parts === null) return;
        console.log(parts);
        let data = {
            email: email,
            stem: parts.stem,
            bnr: parts.bnr
        };
        if (parts.checksum) data.checksum = parts.checksum;
        console.log(data);
        bib_api_call('/jwt/checkout_exemplar_for_user', data, function (data) {
            console.log(data);
            if (data.success) {
                if (table) {
                    table.add_row([
                        data.b.stem,
                        $('<td>').text(`${data.b.stem}-${data.e.bnr}`).data('sort_value', data.b.stem * 1000000 + data.b.bnr),
                        $('<td>').css('max-width', '300px').text(data.b.title),
                        $('<td>').css('max-width', '200px').text(data.b.author),
                        $('<td>').text(`${moment.unix(data.r.ts_checked_out).format('L')}`).data('sort_value', data.r.ts_checked_out),
                        data.r.ts_confirmed
                            ? $('<td>').text(moment.unix(data.r.ts_confirmed).format('L')).data('sort_value', data.r.ts_confirmed)
                            : $('<td>').html("<i class='text-stone-400 fa fa-exclamation-triangle'></i>&nbsp;&nbsp;(noch nicht bestätigt)").data('sort_value', NaN)
                    ]);
                }
            }
        });
    }

    window.addEventListener('load', function () {
        $('.display_name').text((db_user_info[email] || {}).display_name || email)
        bib_api_call('/jwt/get_checked_out_books_for_email', { email: email }, function (data) {
            if (data.success) {
                let div = $('<div>').appendTo($('#book_table'));
                table = new SortableTable({
                    element: div,
                    xs: true,
                    headers: ['Signatur', 'Titel', 'Autor', 'Ausgeliehen', 'Bestätigt'].map(function (x) {
                        let th = $('<th>').text(x);
                        if (['Signatur', 'Ausgeliehen', 'Bestätigt'].indexOf(x) >= 0) th.data('type', 'int');
                        return th;
                    }),
                    rows: data.exemplare.map(function (entry) {
                        return [
                            entry.book.stem,
                            $('<td>').text(`${entry.book.stem}-${entry.exemplar.bnr}`).data('sort_value', entry.book.stem * 1000000 + entry.exemplar.bnr),
                            $('<td>').css('max-width', '300px').text(entry.book.title),
                            $('<td>').css('max-width', '200px').text(entry.book.author),
                            $('<td>').text(`${moment.unix(entry.r.ts_checked_out).format('L')}`).data('sort_value', entry.r.ts_checked_out),
                            entry.r.ts_confirmed
                                ? $('<td>').text(moment.unix(entry.r.ts_confirmed).format('L')).data('sort_value', entry.r.ts_confirmed)
                                : $('<td>').html("<i class='text-stone-400 fa fa-exclamation-triangle'></i>&nbsp;&nbsp;(noch nicht bestätigt)").data('sort_value', NaN)
                        ];
                    }),
                    clickable_rows: true,
                    clickable_row_callback: row_clicked
                });
                table.sort_rows(3, false);
            }
        });
        $('#bu_checkout').click(function(e) {
            $('#bu_checkout').prop('disabled', true);
            new BarcodeWidget({
                element: $('#barcode_widget'),
                on_scan: on_scan
            });
            $('#check_out_div').slideDown();
        });
        if (!lehrmittelverein_state_cache[email]) {
            $('#bu_checkout').prop('disabled', true);
            $('#hint_no_verein').show();
        }
    });
</script>