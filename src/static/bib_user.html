#{File.read('/static/_bib_public_template.html')}
#{require_user_who_can_manage_bib!}
<div class='container bg-white' style="padding-top: 15px;">
    <h2 id="display_name"></h2>
    <!-- <div id='book_list' class="w-full grid grid-cols-12 gap-4 mb-4"></div> -->
    <hr />
    <h3>Ausgeliehene Medien</h3>
    <div id='book_table'></div>
</div>
<script>
    function row_clicked(data) {
        console.log(data);
    }

    window.addEventListener('load', function () {
        let email = decodeURIComponent(window.location.pathname.replace('/bib_user/', ''));
        $('#display_name').text((db_user_info[email] || {}).display_name || email)
        bib_api_call('/jwt/get_checked_out_books_for_email', { email: email }, function (data) {
            if (data.success) {
                let div = $('<div>').appendTo($('#book_table'));
                let table = new SortableTable({
                    element: div,
                    xs: true,
                    headers: ['Signatur', 'Titel', 'Autor', 'Ausgeliehen', 'Bestätigt'].map(function (x) {
                        let th = $('<th>').text(x);
                        if (['Signatur', 'Ausgeliehen', 'Bestätigt'].indexOf(x) >= 0) th.data('type', 'int');
                        return th;
                    }),
                    rows: data.exemplare.map(function (entry) {
                        return [
                            entry,
                            $('<td>').text(`${entry.book.stem}-${entry.exemplar.bnr}`).data('sort_value', entry.book.stem * 1000000 + entry.exemplar.bnr),
                            $('<td>').css('max-width', '300px').text(entry.book.title),
                            $('<td>').css('max-width', '200px').text(entry.book.author),
                            $('<td>').text(`${moment.unix(entry.r.ts_checked_out).format('L')}`).data('sort_value', entry.r.ts_checked_out),
                            entry.r.ts_confirmed
                                ? $('<td>').text(moment.unix(entry.r.ts_confirmed).format('L')).data('sort_value', entry.r.ts_confirmed)
                                : $('<td>').html("<i class='text-stone-400 fa fa-exclamation-triangle'></i>&nbsp;&nbsp;(noch nicht bestätigt)").data('sort_value', NaN)
                            // entry.email,
                            // create_user_td_span(entry.email),
                            // $('<td>').html((db_user_info[entry.email] || {}).klasse || '&ndash;').data('sort_value', (db_user_info[entry.email] || {}).klassen_order),
                            // $('<td>').html(`${entry.ausleih_count === 0 ? '&ndash;' : entry.ausleih_count}`).data('sort_value', entry.ausleih_count || 0)
                        ];
                    }),
                    clickable_rows: true,
                    clickable_row_callback: row_clicked
                });
                table.sort_rows(3, false);
                // for (let row of data.exemplare) {
                //     let div = create_book_div(row.book, null, {
                //         exemplar: row.exemplar, clickable: true, callback: function (book) {
                //             window.location.href = `/bib_book/${book.stem}`;
                //         }
                //     }).data('book', row.book);
                //     $('#book_list').append(div);
                // }
            }
        });
    });
</script>