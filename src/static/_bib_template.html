<style>
    .api_messages {
        position: absolute;
        top: 60px;
        width: 60%;
        left: 20%;
        display: none;
    }

    body {
        background: none;
        background-color: white;
    }

    .api_messages {
        position: fixed;
        z-index: 101;
    }

    .submenu a {
        white-space: nowrap;
    }

    .submenu {
        overflow-x: auto;
    }

    @tailwind base;
    @tailwind components;
    @tailwind utilities;
</style>
<div class='api_messages'></div>
<script>
    var KLASSEN_TR = #{ KLASSEN_TR.to_json };
    var USER_INFO = #{@@user_info.map { | email, info | [email, {:first_name => info[:first_name], :last_name => info[:last_name], :display_name => info[:display_name], :nc_login => info[:nc_login], :klasse => info[:klasse] }]}.to_h.to_json };
    var KLASSEN_ORDER = #{@@klassen_order.to_json};
    var SCHUELER_FOR_KLASSE = #{@@schueler_for_klasse.to_json};

    function create_book_div(book, options = {}) {
        let cover_path = `${BIB_HOST}/gen/covers/${book.stem}-200.jpg`;
        let hover_classes = '';
        if (options.clickable) {
            hover_classes = 'hover:outline hover:outline-1 hover:shadow-lg hover:outline-gray-400 cursor-pointer ';
        }
        let div = $(`<div class="${hover_classes} book border overflow-hidden col-span-12 md:col-span-6 xl:col-span-4 shadow-md bg-white shadow-md rounded" style="overflow-wrap: break-word; position: relative;">`);
        let bib_entry = $(`<div class="text-sm px-2 bg-stone-700 text-stone-300 py-1" style='border-bottom: 1px solid #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;'>`);
        if (!(options.preview))
            bib_entry.text(book.bib_entry);
        else
            bib_entry.html('&nbsp;');
        div.append(bib_entry);
        let cover = $(`<div class='bg-stone-800 shadow shadow-md mr-3 border-r-2' style="float: left; height: 200px; width: 145px; background-position: center center; background-size: contain; background-repeat: no-repeat; border-right: 1px solid #ddd; height: 200px; "></div>`);
        if (!(options.preview))
            cover.css('background-image', `url(${cover_path})`);
        div.append(cover);
        if (!(options.preview)) {
            let details = $(`<div class="w-full p-2" style="height: 200px;">`);
            let title_div = $(`<div style="max-height: 60px; overflow: hidden;">`);
            title_div.append($(`<span class="font-bold text-xl">`).text(book.title));
            if (book.subtitle)
                title_div.append($(`<span class='text-lg'>`).text(` â€“ ${book.subtitle}`));
            details.append(title_div);
            if (book.author)
                details.append($(`<div class="font-italic truncate">`).text(book.author));
            let parts = [];
            if (book.verlag)
                parts.push(book.verlag);
            if (book.published)
                parts.push(book.published);
            if (book.page_count)
                parts.push(`${book.page_count} Seiten`);
            if (parts.length > 0)
                details.append($(`<div>`).text(parts.join(', ')));
            let stem = $(`<span class='bg-amber-200 px-2 py-1 rounded mr-2 font-bold'>`).text(book.stem);
            let available_count = $(`<span class='bg-sky-800 px-2 py-1 rounded mr-2 font-bold'>`).text(`${book.bib_available} / ${book.bib_count}`);
            let ausleih_count = $(`<span class='bg-bamboo-800 px-2 py-1 rounded mr-2 font-bold'>`).text(book.ausleih_count);
            let isbn = $(`<span>`).text(`ISBN: ${book.isbn}`);
            let count_div = $('<span>').append(available_count).append(ausleih_count);
            if (book.ausleih_count != book.bib_count - book.bib_available)
                count_div.addClass('bg-red-500 px-1 py-2 rounded');
            details.append($(`<div>`).append(stem).append(count_div));
            details.append($(`<div>`).append(isbn));
            if (book.description) {
                details.append($(`<hr class='my-2'>`));
                details.append($(`<div class="font-italic" style='overflow: hidden; text-overflow: ellipsis;'>`).text(book.description));
            }
            else if (book.text_snippet) {
                details.append($(`<hr class='my-2'>`));
                details.append($(`<div class="font-italic" style='overflow: hidden; text-overflow: ellipsis;'>`).text(book.text_snippet));
            }
            div.append(details);
        }
        if (options.clickable) {
            div.click(function(e) {
                bib_api_call('/jwt/get_book', {stem: book.stem}, function (data) {
                    if (data.success) {
                        console.log(data);
                        let book = data.book;
                        $('#book_modal .modal-title').text(book.title);
                        let table = $('<table>').addClass('table table-sm table-striped');
                        $('#book_modal .modal-body').empty();
                        for (let exemplar of data.exemplare) {
                            let row = $('<tr>')
                            // console.log(exemplar);
                            let email = exemplar.u.email;
                            let user_info = USER_INFO[email] || {};
                            nc_login = user_info.nc_login;
                            row.append($('<td>').text(exemplar.e.signature));
                            row.append($('<td>').text(exemplar.r.datum));
                            row.append($('<td>').append($('<div>').css('background-image', `url(#{NEXTCLOUD_URL}/index.php/avatar/${nc_login}/128), url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mO88h8AAq0B1REmZuEAAAAASUVORK5CYII=)`).addClass('avatar-md')));
                            row.append($('<td>').text(user_info.display_name || email));
                            row.append($('<td>').html(`${KLASSEN_TR[user_info.klasse || ''] || user_info.klasse || '&ndash;'}`));
                            table.append(row);
                        }
                        $('#book_modal .modal-body').append(table);
                        $('#book_modal').modal('show');
                    }
                });
            });
        }
        return div;
    }
    window.addEventListener('load', function () {
        for (let x of $('.submenu a')) {
            let href = $(x).attr('href');
            if (window.location.pathname === href) {
                $(x).removeClass('bg-white').addClass('font-bold shadow-md outline outline-1 outline-blue-500 bg-white');
            }
        }
    });
</script>
<div class="modal" id="book_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style='z-index: 200000;'>
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" >
          </h5>
        </div>
        <div class="modal-body">
        </div>
        <div class="modal-footer">
        </div>
      </div>
    </div>
</div>


<div class='container-wide'
    style='padding: 0; padding-top: 60px; display: flex; margin-bottom: 24px;'>
    <section class="p-3 w-full">

        <ul class="submenu flex items-center shadow-md fixed bg-stone-800 px-2.5 py-2" style="border-bottom: 1px solid #ccc; top: 57px; left: 0px; right: 0px; z-index: 100;">
            <li class="mx-1">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3" href="/bib">Medien</a>
            </li>
            <!-- <li class="mx-1">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3" href="/bib_users">Nutzer:innen</a>
            </li> -->
            <li class="mx-1">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3" href="/bib_scan_shelf">Regal scannen</a>
            </li>
            <li class="mx-1">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3" href="/bib_scan">ISBN scannen</a>
            </li>
            <!-- <li style="border-left: 1px solid #ccc; height: 54px; margin: -10px 10px -10px 10px;"></li>
            <li class="mx-1">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Suchbegriff eingeben" style="min-width: 200px;" />
                    <div class="input-group-append">
                      <button class="btn btn-success" type="button">Suchen</button>
                    </div>
                  </div>
            </li> -->
        </ul>
