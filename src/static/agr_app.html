#{this_is_a_page_for_logged_in_teachers}
<style>
    .api_messages {
        position: absolute;
        top: 60px;
        width: 60%;
        left: 20%;
        display: none;
    }

    @tailwind base;
    @tailwind components;
    @tailwind utilities;
</style>
<script>
    var KLASSEN_TR = #{ KLASSEN_TR.to_json };
    var USER_INFO = #{@@user_info.map { | email, info | [email, {:display_name => info[:display_name], :nc_login => info[:nc_login], :klasse => info[:klasse] }]}.to_h.to_json };
    var KLASSEN_ORDER = #{@@klassen_order.to_json};
    var SCHUELER_FOR_KLASSE = #{@@schueler_for_klasse.to_json};
    var ACTIVITY_DURATIONS = [
        ['lavender', '1d', 'in den letzten 24 Stunden'],
        ['persimmon', '7d', 'in den letzten 7 Tagen'],
        ['circus-zest', '28d', 'in den letzten 28 Tagen'],
        ['daisy', 'all', 'jemals']];
</script>
<div class='api_messages'></div>
<div class='container-fluid'
    style='background-color: #fff; padding: 0; position: absolute; bottom: 0; top: 57px; display: flex; overflow-y: auto;'>
    <section class="p-4 w-full">
        <div class="w-full grid grid-cols-4 gap-4 mb-4">
            <div class="col-span-4">
                <h3>Aktivität</h3>
            </div>
        </div>
        <div id="activity_overview" class="w-full grid grid-cols-4 gap-4 mb-4">
        </div>
        <div id="klassen_activity_overview" class="w-full grid grid-cols-11 gap-1 mb-4">
        </div>
        <div class="w-full grid grid-cols-4 gap-4 mb-4">
            <div class="col-span-4">
                <h3>Nutzer:innen</h3>
                <div class='overflow-y-auto' style='max-width: 100%; overflow-x: auto;'>
                    <table id='top_user_table' class='table table-condensed table-striped narrow'
                        style='width: unset; min-width: 100%;'>
                        <thead>
                            <tr>
                                <th style="width: 50px;"></th>
                                <th>Name</th>
                                <th>Klasse</th>
                                <th>Lektion</th>
                                <th>Aufgaben</th>
                                <th>Letzte Aktivität</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
</div>
<script>
    window.addEventListener('load', function () {
        agr_api_call('/jwt/overview_stats', {}, function (data) {
            if (data.success) {
                for (let x of ACTIVITY_DURATIONS) {
                    color = x[0];
                    let border_color = CLING_COLORS[`${color}-600`];
                    let div = $(`<div class="col-span-4 md:col-span-2 xl:col-span-1 bg-gray-100 p-3 rounded-lg border-l-4" style="border-left-color: ${border_color}">`);
                    div.append($(`<h5 class="text-gray-500 italic">${x[2]}</h5>`));
                    div.append($('<hr>'));
                    div.append($(`<h4><span class="inline-block w-20 text-center"><span class="px-2 rounded-md bg-${color}-700 text-${color}-300 v-users-solved-1d font-bold">${data.result[`users_solved_${x[1]}`]}</span></span> Nutzer:innen</h4>`));
                    div.append($(`<h4><span class="inline-block w-20 text-center"><span class="px-2 rounded-md bg-${color}-700 text-${color}-300 v-tasks-solved-1d font-bold">${data.result[`tasks_solved_${x[1]}`]}</span></span> Aufgaben</h4>`));
                    div.append($(`<h5 class="text-slate-700/50"><span class="inline-block w-20 text-center"><span class="px-2 rounded-md bg-${color}-700 text-${color}-300 opacity-75 v-tasks-voc-solved-1d">${data.result[`tasks_voc_solved_${x[1]}`]}</span></span> davon Vokabeln</h5>`));
                    div.append($(`<h5 class="text-slate-700/50"><span class="inline-block w-20 text-center"><span class="px-2 rounded-md bg-${color}-700 text-${color}-300 opacity-75 v-tasks-form-solved-1d">${data.result[`tasks_form_solved_${x[1]}`]}</span></span> davon Formen</h5>`));
                    $('#activity_overview').append(div);
                }
                for (let entry of data.result.user_top_list) {
                    let row = $('<tr>');
                    let nc_login = null;
                    let user_info = USER_INFO[entry.email] || {};
                    nc_login = user_info.nc_login;
                    row.append($('<td>').append($('<div>').css('background-image', `url(#{NEXTCLOUD_URL}/index.php/avatar/${nc_login}/128), url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mO88h8AAq0B1REmZuEAAAAASUVORK5CYII=)`).addClass('avatar-md')));
                    row.append($('<td>').text(user_info.display_name || entry.email));
                    let klasse = user_info.klasse || '–';
                    klasse = KLASSEN_TR[klasse] || klasse;
                    row.append($('<td>').text(klasse));
                    row.append($('<td>').text(`${data.result.unit_for_user[entry.email]}`));
                    let parts = [];
                    for (let x of ACTIVITY_DURATIONS) {
                        parts.push(`<span class='px-1 inline-block w-12 text-center rounded-lg bg-${x[0]}-700 text-${x[0]}-300'>${entry.st['t' + x[1]]}</span>`);
                    }
                    row.append($('<td>').html(`${parts.join(' ')}`));
                    row.append($('<td>').text(`${moment.unix(entry.last_activity / 1000).format('ddd, D.M.Y')}`));
                    $('#top_user_table tbody').append(row);
                }
                for (let klasse of KLASSEN_ORDER) {
                    if (parseInt(klasse) < 8 || klasse.indexOf('WK') >= 0 || klasse.indexOf('e') >= 0)
                        continue;
                    let klassen_label = KLASSEN_TR[klasse] || klasse;
                    let div = $(`<div class='flex justify-center items-center'>`);
                    div.append($(`<div class='text-center absolute text-base md:text-lg'>${klassen_label}</div>`));
                    let canvas = $(`<canvas>`).attr('height', '250');
                    div.append(canvas);
                    let numbers = [0, 0, 0, 0, 0];
                    for (let email of SCHUELER_FOR_KLASSE[klasse]) {
                        let i = 4;
                        if (data.result.last_activity_cat_for_user[email] === 'all')
                            i = 3;
                        else if (data.result.last_activity_cat_for_user[email] === '28d')
                            i = 2;
                        else if (data.result.last_activity_cat_for_user[email] === '7d')
                            i = 1;
                        else if (data.result.last_activity_cat_for_user[email] === '1d')
                            i = 0;
                        numbers[i] += 1;
                    }
                    new Chart(canvas, {
                        type: 'doughnut',
                        data: {
                            datasets: [
                                {
                                    // label: "My First Dataset",
                                    data: numbers,
                                    backgroundColor: [
                                        CLING_COLORS[`${ACTIVITY_DURATIONS[0][0]}-500`],
                                        CLING_COLORS[`${ACTIVITY_DURATIONS[1][0]}-500`],
                                        CLING_COLORS[`${ACTIVITY_DURATIONS[2][0]}-500`],
                                        CLING_COLORS[`${ACTIVITY_DURATIONS[3][0]}-500`],
                                        CLING_COLORS[`slate-900`],
                                    ],
                                    borderWidth: 1,
                                    hoverOffset: 4,
                                },
                            ],
                        },
                        options: {
                            legend: {
                                display: false
                            },
                            tooltips: {
                                enabled: false
                            }
                        }
                    });
                    $('#klassen_activity_overview').append(div);
                }
            }
        });
    });
</script>