#{require_monitor_or_user_who_can_manage_monitors!}
<style>
    .navbar, .foot {
        display: none;
    }

    body {
        padding-top: 0;
        overflow: hidden;
        color: #{color_palette[:contrast]};
        background: none;
        background-color: #{color_scheme[0] == 'd' ? '#080808' : '#fff'};
    }

    .container-fluid {
        padding: 2vw 1vw;
        padding-top: 1vw;
    }

    .main > div {
        width: 24.5vw;
        padding: 0 1vw;
        /* position: absolute; */
    }

    .klasse {
        backdrop-filter: blur(10px);
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 0.7vw;
        box-shadow: 0 0 0.5vw rgba(0, 0, 0, 0.6);
        padding: 1vw 2vw;
        margin: 1vw 0;
        height: 6.2vw;
        position: relative;
        color: #{color_palette[:darker]};
    }

    .klasse.k11, .klasse.k12 {
        height: 20.599vw;
    }

    h3 {
        font-size: 1.5vw;
        font-weight: bold;

        position: relative;
        background-color: #fff;
        display: inline-block;
        width: 3vw;
        height: 3vw;
        border-radius: 3vw;
        left: -3.2vw;
        top: -1.5vw;
        box-shadow: 0 0 0.4vw rgba(0, 0, 0, 0.8);
        text-align: center;
        padding-top: 0.6vw;
    }

    .row {
        margin: 0;
    }

    .ticker {
        position: absolute;
        bottom: -0.5vw;
        font-size: 2.5vw;
        padding: 1vw 1vw;
        overflow-x: hidden;
        white-space: nowrap;
    }

    .ticker-message {
        position: relative;
    }

    .ticker-message span:after {
        content: '+++';
        display: inline-block;
        margin: 0 2vw;
    }

    .ticker-message span.empty:after {
        content: '';
        display: inline-block;
        margin: 0 2vw;
    }

    .attribution {
        position: absolute;
        bottom: 5vw;
        left: 98.45vw;
        color: #{color_palette[:contrast]};
        font-size: 0.9vw;
        text-align: left;
        /* border: 1px solid red; */
        white-space: pre;
        transform-origin: 0 0;
        transform: rotate(-90deg);
    }

    .content {
        position: absolute;
        left: 2vw;
        top: 0vw;
        bottom: 0vw;
        right: 0.5vw;
        overflow: hidden;
        /* border: 1px solid red; */
    }

    .content table {
        width: 100%;
        background: none;
        position: relative;
        margin-top: 0.2vw;
        /* border: 1px solid red; */
    }

    .content table td {
        /* border: 1px solid red; */
        font-size: 1.15vw;
        padding: 0 0.5vw;
    }

    .content table td.vertretungs_text {
        position: relative;
        top: -0.3vw;
    }

    .content table td s {
        margin-right: 0.5vw;
    }

    .embed-responsive-item {
        background-image: url(/gen/bg/bg-#{color_scheme}.svg);
        background-color: #{color_scheme[0] == 'l' ? '#f8f8f8' : '#080808'};
        background-repeat: no-repeat;
        background-size: 100vw;
        background-position: 50% 0%;
    }
</style>

<div class="embed-responsive embed-responsive-16by9">
    <div class='embed-responsive-item'>
        <div class='container-fluid main row'>
        </div>
        <div class='container-fluid ticker row'>
            <div class='ticker-message'></div>
        </div>
        <div class='attribution'><span class='color_scheme'></span><span style='margin: 0 0.5em;'>//</span>Stand: <span class='monitor_timestamp'></span></div>
        
    </div>
</div>

<script>
    var top_delay = 5.0;
    var bottom_delay = 2.0;
    var klassen = #{ KLASSEN_ORDER.to_json };
    var klassen_tr = #{ KLASSEN_TR.to_json };
    var attribution = #{@@color_scheme_info[color_scheme[0, 19]].to_json};
    var klassen_div = {};
    var klassen_animation_config = {};
    var last_timestamp = 0.0;
    var ticker_offset = 0.0;
    var scroll_down_speed = 1.0;
    var scroll_up_speed = 10.0;
    var ticker_speed = 6.0;
    var ticker_div = null;
    var ticker_messages = [];
    var ticker_index = 0;
    var klassen_tr = #{KLASSEN_TR.to_json};
    var server_time_diff = 0;

    var ws = null;
    var ws_timer_id = null;
    var last_vplan_timestamp = null;

    function js_time() {
        return Math.floor(Date.now() / 1000.0) + 999999;
    }

    function server_time() {
        return js_time() + server_time_diff;
    }

    function keep_alive() { 
        var timeout = 20000;
        if (ws.readyState == ws.OPEN) {  
            ws.send('');  
        }  
        (function() {
            ws_timer_id = setTimeout(keep_alive, timeout);  
        })();
    }                  

    function setup_ws(ws)
    {
        ws.onopen = function() {
            console.log('ws.onopen');
            keep_alive();
        }
        
        ws.onclose = function() {
            console.log('ws.onclose');
            clearTimeout(ws_timer_id);
            // try to re-establish connection in 10 seconds
            setTimeout(establish_websocket_connection, 10000);
        }
        
        ws.onmessage = function(msg) {
            data = JSON.parse(msg.data);
            console.log(data.command);
            if (data.command == 'force_reload') {
                /* $('.embed-responsive-item')[0].requestFullscreen(); */
                window.location.reload();
            } else if (data.command == 'update_time') {
                server_time_diff = data.time - js_time();
            } else if (data.command == 'update_monitor_messages') {
                ticker_messages = data.messages;
            } else if (data.command == 'update_vplan') {
                if (data.timestamp !== last_vplan_timestamp) {
                    last_vplan_timestamp = data.timestamp;
                    data = data.data;
                    $('.monitor_timestamp').text(moment(data.timestamp).format('ddd, D.M.Y H:m:s'));
                    console.log(data);
                    for (let klasse of klassen) {
                        let div = klassen_div[klasse];
                        div.empty();
                        if (data.klassen[klasse]) {
                            let table = $('<table>');
                            div.append(table);
                            let first_entry = true;
                            for (let entry of data.klassen[klasse]) {
                                let row = $('<tr>').appendTo(table);
                                if (!first_entry)
                                    row.css('border-top', '1px solid rgba(0,0,0,0.3)')
                                first_entry = false;
                                row.append($('<td>').css('width', '4vw').html(`<b>${entry.stunde_label}</b>`));
                                if (entry.klassen_alt) entry.klassen_alt = entry.klassen_alt.map(function(x) { return klassen_tr[x] || x; });
                                if (entry.klassen_neu) entry.klassen_neu = entry.klassen_neu.map(function(x) { return klassen_tr[x] || x; });
                                row.append($('<td>').html(gen_label_arr(entry.klassen_alt, entry.klassen_neu)));
                                row.append($('<td>').html(gen_label(entry.fach_alt, entry.fach_neu)));
                                row.append($('<td>').html(gen_label_arr(entry.lehrer_alt, entry.lehrer_neu)));
                                row.append($('<td>').css('text-align', 'right').html(gen_label(entry.raum_alt, entry.raum_neu)));
                                if (entry.vertretungs_text) {
                                    let row = $('<tr>').appendTo(table);
                                    row.append($('<td>'));
                                    let cell = $('<td>').addClass('vertretungs_text').attr('colspan', '4');
                                    cell.append($('<span>').text(entry.vertretungs_text));
                                    row.append(cell);
                                }
                            }
                            install_auto_scroller(klasse, div);
                        }
                    }
                }
            }
        }
    }

    function establish_websocket_connection() {
        var ws_uri = (location.protocol == 'http:' ? 'ws://' : 'wss://') + location.host + '/ws_monitor';
        ws = new WebSocket(ws_uri);
        setup_ws(ws);
    }

    function animation_step(timestamp) {
        timestamp *= 0.001;
        let diff = timestamp - last_timestamp;
        for (let klasse in klassen_animation_config) {
            let config = klassen_animation_config[klasse];
            if (config.phase == 0) {
                config.position += diff * scroll_down_speed;
                if (config.position > config.range) {
                    config.position = config.range;
                    config.phase = 1;
                    config.timestamp = timestamp + bottom_delay;
                }
            } else if (config.phase == 1) {
                if (timestamp >= config.timestamp)
                    config.phase = 2;
            } else if (config.phase == 2) {
                config.position -= diff * scroll_up_speed;
                if (config.position < 0.0) {
                    config.position = 0.0;
                    config.phase = 3;
                    config.timestamp = timestamp + top_delay;
                }
            } else if (config.phase == 3) {
                if (timestamp >= config.timestamp)
                    config.phase = 0;
            }
            $(klassen_animation_config[klasse].table).css('top', `-${config.position}vw`);
        }
        if ($('.ticker-message span').length > 0) {
            let message_width = $('.ticker-message span').first().width() * 100.0 / window.innerWidth;
            if (message_width < 1.0)
                message_width = 1.0;
            ticker_offset += diff * ticker_speed;
            while (ticker_offset > message_width && ticker_offset >= 0) {
                $('.ticker-message span').first().remove();
                ticker_offset -= message_width;
            }
            $('.ticker-message').css('left', `-${ticker_offset}vw`);
        }
        while ($('.ticker-message').width() + $('.ticker-message').position().left < window.innerWidth) {
            if (ticker_messages.length > 0) {
                ticker_index %= ticker_messages.length;
                $('<span>').text(ticker_messages[ticker_index]).appendTo($('.ticker-message'));
                ticker_index = (ticker_index + 1) % ticker_messages.length;
            } else {
                $('<span>').addClass('empty').appendTo($('.ticker-message'));
            }
        }

        last_timestamp = timestamp;
        window.requestAnimationFrame(animation_step);
    }

    function gen_label_arr(alt, neu) {
        let label = '';
        if (alt)
            label += `<s>${alt.join(', ')}</s>`;
        if (neu)
            label += `<b>${neu.join(', ')}</b>`;
        return label;
    }

    function gen_label(alt, neu) {
        let label = '';
        if (alt)
            label += `<s>${alt}</s>`;
        if (neu)
            label += `<b>${neu}</b>`;
        return label;
    }

    function install_auto_scroller(klasse, target) {
        target = $(target);
        let table = $(target).find('table');
        let table_height = table.height() * 100.0 / window.innerWidth;
        let target_height = target.height() * 100.0 / window.innerWidth;
        if (table_height > target_height) {
            let diff = table_height - target_height + 0.3;
            klassen_animation_config[klasse] = {
                range: diff,
                phase: 2,
                timestamp: top_delay,
                position: 0,
                table: table[0],
            };
        }
    }

    window.addEventListener('load', function () {
        establish_websocket_connection();
        let a = `<b>»${attribution[0]}«</b>`;
        if (attribution[1])
            a += ` von <b>${attribution[1]}</b>`;
        $('.color_scheme').html(a);
        moment.locale('de');
        let col = null;
        let i = 0;
        for (let klasse of klassen) {
            if (i % 7 == 0) {
                col = $('<div>');
                col.appendTo($('.main'));
            }
            let box = $('<div>');
            let div = $('<div>').addClass('klasse').addClass(`k${klasse}`).appendTo(box);
            div.append($('<h3>').text(`${klassen_tr[klasse] || klasse}`))
            let content = $('<div>').addClass('content').appendTo(div);
            klassen_div[klasse] = content;
            col.append(box);
            i += 1;
        }
        window.requestAnimationFrame(animation_step);
    });
</script>