#{require_user_who_can_manage_bib!}
#{File.read('/static/_bib_template.html')}
<style>
    #barcode_scanner_div {
        border: 1px solid #aaa;
        position: relative;
        width: 100%;
        padding-top: 56%;
        overflow: hidden;
    }
    #barcode_scanner_div video {
        position: absolute;
        top: -25%;
        left: 0;
    }
    #shelf_label {
        position: absolute;
        top: 0;
        left: 0;
        font-size: 48px;
        background-color: rgba(255,255,255,0.5);
        padding: 0 0.2em;
    }
</style>
<button id='bu-reset-shelf' style='margin-bottom: 5px;' class='btn btn-danger' disabled>Bearbeitung des Regals beenden</button>
<div id="barcode_scanner_div">
    <video id="barcode_scanner_video"></video>
    <div id="shelf_label"></div>
</div>
<div id="book_list">
</div>
</section>
</div>

<script type="text/javascript" src="/include/zxing.min.js"></script>
<script>
    var beep0 = new Audio('/beep0.mp3');
    var beep1 = new Audio('/beep1.mp3');

    var last_scanned_barcode = null;
    var last_shelf = null;

    function on_scan(code) {
        if (code === last_scanned_barcode)
            return;
        last_scanned_barcode = code;
        if (code.substring(0, 4) === 'bib:') {
            console.log(`shelf code: ${code}`)
            beep1.play();
            last_shelf = code.replace('bib:', '');
            $('#shelf_label').text(last_shelf);
            $('#bu-reset-shelf').attr('disabled', false);
        } else {
            console.log(`book code: ${code}`)
        }

        if (code.match(/^\d{4}\/\d{3}$/) !== null)
            code = code.replace('/', '-');
        if (code.match(/^\d{4}\/0\d{3}$/) !== null)
            code = code.replace('/0', '-');
        if (code.match(/^\d{4}\-\d{3}$/) !== null) {
            if (last_shelf !== null) {
                let stem = parseInt(code.split('-')[0]);
                console.log(`stem: ${stem}`);
                beep0.play();
                $('#book_list').empty();
                bib_api_call('/jwt/set_shelf_for_book', {stem: stem, shelf: last_shelf}, function(data2) {
                    bib_api_call('/jwt/get_book', {stem: stem}, function (data) {
                        if (data.success) {
                            stem_book = data.book;
                            console.log(data);
                            $('#book_list').append(create_book_div(data.book, data.shelf));
                        }
                    });
                });

            }
        }
    }

    window.addEventListener('load', function () {

        const codeReader = new ZXing.BrowserMultiFormatReader()
        codeReader.decodeFromVideoDevice(null, 'barcode_scanner_video', (result, err) => {
            if (result) on_scan(result.text);
        });

        // setTimeout(function() {
        //     on_scan('bib:13D');
        // }, 0);
        // setTimeout(function() {
        //     on_scan('3792-123');
        // }, 100);

        $('#bu-reset-shelf').click(function() {
            last_shelf = null;
            last_scanned_barcode = null;
            $('#shelf_label').text('');
            $('#bu-reset-shelf').attr('disabled', true);
            $('#book_list').empty();
        });
    });
</script>