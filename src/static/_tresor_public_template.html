#{this_is_a_page_for_logged_in_teachers}
<style>
    .safari_volume_indicator {
        display: block;
        position: fixed;
        right: 4px;
        bottom: 4px;
        width: 45px;
        height: 45px;
        z-index: 100000;
        padding-top: 5px;
        border: 1px solid rgba(0,0,0,0.2);
        border-radius: 100%;
        box-shadow: rgb(0 0 0 / 20%) 0px -1px 10px;
        font-size: 145%;
        text-align: center;
    }

    .api_messages {
        position: absolute;
        top: 60px;
        width: 80%;
        left: 10%;
        display: none;
    }

    body {
        /* background: none; */
        /* background-color: white; */
        /* padding-top: 120px; */
        background-attachment: fixed;
    }

    .api_messages {
        position: fixed;
        z-index: 101;
    }

    #submenu_container {
        position:fixed;
        top: 57px;
        left: 0;
        right: 0;
        z-index: 100;
    }

    #submenu {
        /* position: fixed; */
        border-bottom: 1px solid #bbb;
    }

    .submenu a {
        white-space: nowrap;
    }

    .submenu {
        overflow-x: auto;
        overflow-y: clip;
    }

    .container {
        padding-top: 15px;
    }

    .bib_management_only {
        min-height: 50px;
        border-top: 1px dashed #ddd;
        padding: 10px;
        background: linear-gradient(#eee 0px, #fff 50px);
        margin-left: -15px;
        margin-right: -15px;
        margin-top: 15px;
        padding-top: 30px;
        display: none;
    }

    body {
        #{@session_device ? 'padding-top: 0;' : '' }
    }

    .navbar {
        #{@session_device ? 'display: none;' : '' }
    }

    #device_navbar {
        #{@session_device ? '' : 'display: none;' }
        background-color: white;
        border-radius: 0;
        padding: 10px 15px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        white-space: nowrap;
        overflow-x: auto;
    }

    @media (max-width: 575px) {
        ._barcode_widget > div:first-child {
            height: 120px!important;
        }

        ._barcode_widget {
            border-radius: 0!important;
            margin: 0px -15px 15px -15px!important;
            border: none!important;
            border-bottom: 1px solid #ddd!important;
        }
    }

    .sandbox-hint {
        text-align: center;
        background-color: #fce94f;
        border-radius: 0;
        padding: 5px 15px;
        border-top: 1px solid rgba(0,0,0,0.1);
        border-bottom: 1px solid rgba(0,0,0,0.1);
        white-space: nowrap;
        overflow-x: auto;
    }

    .sandbox-hint::-webkit-scrollbar {
        display: none;
    }

    .sandbox-hint {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .container, .container-lg, .container-md, .container-sm, .container-xl {
        /* max-width: calc(100% - 30px); */
    }

    #bu-refresh-second-factor {
        transition: background 1s ease;
    }
    #bu-refresh-second-factor .fa {
        transition: color 1s ease;
    }

    tr.focused, tr.focused td {
        background-color: #fce98d;
    }
    div.note {
        position: relative;
        /* font-family: 'IBM Plex Sans'; */
        /* font-size: 90%; */
    }
    div.note:after {
        position: absolute;
        width: 1.5em;
        height: 1.5em;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 100%;
        content: '';
        pointer-events: none;
    }
    div.note.empty input {
        background-color: rgba(225, 177, 20, 0.481);
    }
    div.note.marked:after {
        outline: 2px solid #d5291a;
        background-color: rgba(213, 41, 26, 0.1);
    }
    div.note.marked-big {
        position: relative;
        top: 0.5em;
    }
    div.note.marked-big:after {
        outline: 2px solid #d5291a;
        background-color: rgba(213, 41, 26, 0.1);
        padding: 1em;
    }
    div.note.empty_x input {
        color: #888;
    }
    div.note input {
        margin-left: auto;
        margin-right: auto;
    }
    div.note input:disabled {
        background: none;
        border: none;
        padding: 0;
        width: 2em!important;
    }

    .container, .container-lg, .container-md, .container-sm, .container-xl {
        max-width: 1600px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }

    .extra-padding {
        padding-top: 72px;
    }

    .form-control:disabled {
        opacity: 1.0;
    }

    .tresor_table_container td {
        position: relative;
    }

    .tresor_icon {
        position: absolute;
        right: 0;
        top: 0;
    }

    .tresor_table_container .table thead th {
        border-bottom: none;
    }

    .tresor_table_container .table thead {
        transition: box-shadow 0.5s ease-out;
    }

    .tresor_table_container .table thead.shadow {
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }

    @tailwind base;
    @tailwind components;
    @tailwind utilities;
</style>

<div class='api_messages'></div>
<div id="device_navbar" class="container">
    <img src='#{NEXTCLOUD_URL}/index.php/avatar/#{@session_user[:nc_login]}/256}' class='avatar-md'/>
    <span style="display: inline-block; margin-left: 5px; position: relative; top: 2px;">#{@session_user[:display_name]}</span>
    <button id='bu_logout' class="pull-right btn btn-sm btn-danger"><i class='fa fa-sign-out'></i>&nbsp;&nbsp;Abmelden</button>
</div>
<div id='submenu_container'>
<div id='submenu' class='container' style='padding: 0; display: flex; background: white; border-radius: 0; display: #{second_factor_time_left.nil? ? 'none' : 'block'};'>
    <section class="w-full" style="height: 51px; display: #{second_factor_time_left.nil? ? 'none' : 'block'};">
        <ul class="submenu flex bg-white px-2.5 py-2"
            style="border-bottom: 1px solid #eee; left: 0px; right: 0px; z-index: 100;">
            <li class="mx-1">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3"
                    href="/zeugnisuebersicht"><i class='fa fa-dashboard'></i>&nbsp;&nbsp;Übersicht</a>
            </li>
            <li class="mx-1" style="display: #{zeugnis_admin_logged_in? ? 'unset' : 'none'};">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3"
                    href="/zeugnisformulare"><i class='fa fa-file-word-o'></i>&nbsp;&nbsp;Zeugnisformulare</a>
            </li>
            <li class="mx-1">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3"
                    href="/zeugnislisten"><i class='fa fa-table'></i>&nbsp;&nbsp;Zeugnislisten</a>
            </li>
            <li class="mx-1" style="display: #{((!@session_user[:klassenleitung].nil?) || zeugnis_admin_logged_in?) ? 'unset' : 'none'};">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3"
                    href="/zeugnis_angebote_bemerkungen"><i class='fa fa-table'></i>&nbsp;&nbsp;Angebote und Bemerkungen</a>
            </li>
            <li class="mx-1" style="display: #{((!@session_user[:klassenleitung].nil?) || zeugnis_admin_logged_in?) ? 'unset' : 'none'};">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3"
                    href="/zeugnis_fehltage"><i class='fa fa-clock-o'></i>&nbsp;&nbsp;Fehltage</a>
            </li>
            <li class="mx-1" style="display: #{((!@session_user[:klassenleitung].nil?) || zeugnis_admin_logged_in?) ? 'unset' : 'none'};">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3"
                    href="/zeugnisdruck"><i class='fa fa-print'></i>&nbsp;&nbsp;Zeugnisdruck</a>
            </li>
            <li class="mx-1">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3"
                    href="/anlage_sozialverhalten"><i class='fa fa-table'></i>&nbsp;&nbsp;Anlage Sozialverhalten</a>
            </li>
            <li style="border-left: 1px solid #ccc; height: 52px; margin: -10px 10px -10px 10px; margin-left: auto;">
            </li>
            <li class="mx-1">
                <button id='bu-refresh-second-factor' style='white-space: nowrap;' class="inline-block bg-slate-900 border border-blue-500 rounded py-1 px-3"><i class='text-slate-600 fa fa-clock-o'></i>&nbsp;&nbsp;<span style='display: inline-block; width: 3em;' id="sf-time-left"></span></button>
            </li>
            <li class="mx-1">
                <button id='bu-delete-second-factor' style='white-space: nowrap;' class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3"><i class='text-slate-600 fa fa-sign-out'></i>&nbsp;&nbsp;Abmelden</button>
            </li>
        </ul>
    </section>
</div>
<div id='subsubmenu' class='container'
    style='padding: 0; display: flex; background: white; border-radius: 0; display: none;'>
    <section class="w-full" style="height: 51px;">
        <ul class="submenu flex bg-stone-900 px-2.5 py-2"
            style="border-bottom: 1px solid #eee; left: 0px; right: 0px; z-index: 100;">
            <li id='sub_menu_extra' style='margin-left: auto;'></li>
        </ul>
    </section>
</div>
</div>

<script>
var second_factor_expires = Math.round((Date.now() / 1000.0) + #{second_factor_time_left || 0});
var edit_enabled = false;
var FAECHER_SPRACHEN = #{FAECHER_SPRACHEN.to_json};

function update_edit_button() {
    let button = $('#bu_toggle_edit');
    if (edit_enabled) {
        button.html(`<i class='fa fa-unlock'></i>&nbsp;&nbsp;Tabelle für Bearbeitung schließen`);
        button.removeClass('btn-secondary').addClass('btn-success');
    } else {
        button.html(`<i class='fa fa-lock'></i>&nbsp;&nbsp;Tabelle für Bearbeitung öffnen`);
        button.removeClass('btn-success').addClass('btn-secondary');
    }
}

function update_time_left() {
    if ('#{second_factor_time_left.nil?}' === 'true') {
        $('.bg-white').removeClass('extra-padding');
    }
    let seconds_left = Math.round(second_factor_expires - (Date.now() / 1000.0));
    if (seconds_left <= 0 && ('#{second_factor_time_left.nil?}' !== 'true')) {
        window.location.href = '/tresor';
        return;
    }
    let minutes = Math.floor(seconds_left / 60.0);
    let seconds = (seconds_left - minutes * 60);
    $('#sf-time-left').text(`${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);

    if (seconds_left <= 60) {
        $('#bu-refresh-second-factor').removeClass('bg-slate-900 bg-amber-300').addClass('bg-red-400');
        $('#bu-refresh-second-factor .fa').removeClass('text-slate-600 bg-amber-600').addClass('text-red-600');
    } else if (seconds_left <= 120) {
        $('#bu-refresh-second-factor').removeClass('bg-slate-900 bg-red-400').addClass('bg-amber-300');
        $('#bu-refresh-second-factor .fa').removeClass('text-slate-600 text-red-600').addClass('text-amber-600');
    } else {
        $('#bu-refresh-second-factor').removeClass('bg-red-400 bg-amber-300').addClass('bg-slate-900');
        $('#bu-refresh-second-factor .fa').removeClass('text-red-600 text-amber-600').addClass('text-slate-600');
    }
}

window.addEventListener('load', function () {
    $('.bg-white').addClass('extra-padding');
    tresor_api_call_no_jwt('/public/ping', {}, function(data) {
        console.log(data);
        if (!data.success) {
            if (window.location.pathname !== '/tresor')
                window.location.href = '/tresor';
            $('#connection-failed').show();
            $('.api_messages').hide();
            $('#submenu').hide();
            $('#subsubmenu').hide();
            $('.bg-white').removeClass('extra-padding');
        } else {
            $('#connection-established').show();
            if ('#{second_factor_time_left.nil?}' !== 'true') {
                if (window.location.pathname === '/tresor')
                    window.location.href = '/zeugnisuebersicht';
            }
        }
    });
    update_time_left();
    setInterval(function() {
        update_time_left();
    }, 1000);
    $('#bu-refresh-second-factor').click(function(e) {
        api_call('/api/refresh_second_factor', {}, function(data) {
            if (data.success) {
                second_factor_expires = Math.round((Date.now() / 1000.0) + data.time_left);
                update_time_left();
            }
        });
    })
    $('#bu-delete-second-factor').click(function(e) {
        api_call('/api/delete_second_factor', {}, function(data) {
            if (data.success) {
                window.location.href = '/tresor';
                localStorage.setItem('tresor_jwt_token', null);
            }
        });
    })
    for (let x of $('.submenu a')) {
        let href = $(x).attr('href');
        if (window.location.pathname === href) {
            $(x).removeClass('bg-white').addClass('font-bold shadow-md outline outline-1 outline-blue-500 bg-white');
        }
    }
    window.addEventListener('scroll', function(e) {
        let div = $('.tresor_table_container');
        if (div.length > 0) {
            let my = $('.submenu').outerHeight() + $('nav').outerHeight();
            let dy = div.offset().top - $(window).scrollTop() - my;
            if (dy > 0) dy = 0;
            $('.tresor_table_container thead').css('position', 'relative').css('top', `${-dy}px`).css('background-color', '#fff').css('z-index', 101);
            $('.tresor_table_container thead').toggleClass('shadow', dy !== 0);

        }
    });
});

let noten_allowed_values = [
    '1+', '1', '1-',
    '2+', '2', '2-',
    '3+', '3', '3-',
    '4+', '4', '4-',
    '5+', '5', '5-',
    '6', 'n.e.', 'o.B.', 'befr.', '×',
];

let versetzt_allowed_values = [
    'ja', 'nein'
];

let noten_mark = #{NOTEN_MARK.to_json};
// consider_cache is true if any of the marks for a given e-mail address is marked
let consider_cache = {};

function input_note_apply_style_and_fix(input, callback) {
    let value = $(input).val().trim();
    let original_value = `${value}`;
    if (value.toLowerCase().replace(/[\.\s]+/g, '') == 'ne') value = 'n.e.';
    if (value.toLowerCase().replace(/[\.\s]+/g, '') == 'ob') value = 'o.B.';
    if (value.toLowerCase().replace(/[\.\s]+/g, '') == 'befr') value = 'befr.';
    if (value.toLowerCase().replace(/[\.\s]+/g, '') == 'x') value = '×';
    if (noten_allowed_values.indexOf(value) < 0) value = '';
    if (value === '')
        $(input).closest('.note').addClass('empty');
    else
        $(input).closest('.note').removeClass('empty');

    if (original_value !== value) {
        $(input).val(value);
        input_note_apply_style_and_fix($(input), callback);
        return;
    } else {
        if (noten_mark.indexOf(value) >= 0)
            $(input).closest('.note').addClass('marked');
        else
            $(input).closest('.note').removeClass('marked');
        if (value === '×')
            $(input).closest('.note').addClass('empty_x');
        else
            $(input).closest('.note').removeClass('empty_x');

        if (typeof(callback) !== 'undefined') callback(value);
    }
}

function input_versetzt_apply_style_and_fix(input, callback) {
    let value = $(input).val().trim();
    let original_value = `${value}`;
    if (value.toLowerCase().replace(/[\.\s]+/g, '') == 'j') value = 'ja';
    if (value.toLowerCase().replace(/[\.\s]+/g, '') == 'ja') value = 'ja';
    if (value.toLowerCase().replace(/[\.\s]+/g, '') == 'n') value = 'nein';
    if (value.toLowerCase().replace(/[\.\s]+/g, '') == 'nein') value = 'nein';
    if (versetzt_allowed_values.indexOf(value) < 0) value = '';
    if (value === '')
        $(input).closest('.note').addClass('empty');
    else
        $(input).closest('.note').removeClass('empty');

    if (original_value !== value) {
        $(input).val(value);
        input_versetzt_apply_style_and_fix($(input), callback);
        return;
    } else {
        if (value === 'nein')
            $(input).closest('.note').addClass('marked-big');
        else
            $(input).closest('.note').removeClass('marked-big');

        if (typeof(callback) !== 'undefined') callback(value);
    }
}

function input_anzahl_apply_style_and_fix(input, callback) {
    let value = $(input).val().trim();
    let original_value = `${value}`;
    let number = parseInt(value);
    if (isNaN(number)) number = '';
    if (number < 0) number = '';
    if (number === '')
        $(input).closest('.note').addClass('empty');
    else
        $(input).closest('.note').removeClass('empty');
    value = `${number}`;

    if (original_value !== value) {
        $(input).val(value);
        input_anzahl_apply_style_and_fix($(input), callback);
        return;
    } else {
        if (typeof(callback) !== 'undefined') callback(value);
    }
}

function input_tendenz_apply_style_and_fix(input, callback) {
    let value = $(input).val().trim();
    let original_value = `${value}`;
    value = value.toLowerCase();
    if (value == 'O') value = 'o';
    if (value == '0') value = 'o';
    if (value.toLowerCase().replace(/[\.\s]+/g, '') == 'x') value = '×';

    if (!(value === '-' || value === 'o' || value === '+' || value == '++' || value == '×'))
        value = '';
    if (value === '')
        $(input).closest('.note').addClass('empty');
    else
        $(input).closest('.note').removeClass('empty');
    if (original_value !== value) {
        $(input).val(value);
        input_tendenz_apply_style_and_fix($(input), callback);
        return;
    } else {
        if (value === '×')
            $(input).closest('.note').addClass('empty_x');
        else
            $(input).closest('.note').removeClass('empty_x');
        if (typeof(callback) !== 'undefined') callback(value);
    }
}

function style_consider_button(button, flag) {
    if (flag) {
        button.removeClass('btn-outline-secondary').addClass('btn-danger').html(`<i class='fa fa-check'></i>&nbsp;&nbsp;besprechen`);
    } else {
        button.removeClass('btn-danger').addClass('btn-outline-secondary').html(`nicht besprechen`);
    }
}

function load_noten_table(container, klasse, edit_noten) {
    // for (let lesson_key of lesson_keys) {
    //     let info = kurs_info[lesson_key];
    //     console.log(info.fach);
    // }
    let path_arrays = [];
    let path_array = [];
    path_array.push(['Schuljahr', ZEUGNIS_SCHULJAHR]);
    path_array.push(['Halbjahr', ZEUGNIS_HALBJAHR]);
    let liste = zeugnisliste_for_klasse[klasse];
    let faecher = liste.faecher;
    let faecher_for_paths = [];
    for (let fach of faecher) {
        faecher_for_paths.push(fach);
        if (FAECHER_SPRACHEN.indexOf(fach) >= 0) {
            faecher_for_paths.push(`${fach}_AT`);
            faecher_for_paths.push(`${fach}_SL`);
        }
    }
    let emails = liste.schueler.map(function(x) { return x.email; });
    path_array.push(['Fach', faecher_for_paths]);
    path_array.push(['Email', emails]);
    path_arrays.push(path_array);

    let path_array_2 = [];
    path_array_2.push(['Schuljahr', ZEUGNIS_SCHULJAHR]);
    path_array_2.push(['Halbjahr', ZEUGNIS_HALBJAHR]);
    path_array_2.push(['ZK', 'marked']);
    path_array_2.push(['Email', emails]);
    path_arrays.push(path_array_2);

    let t0 = Date.now();
    tresor_api_call('/jwt/get_many', {path_arrays: path_arrays, key: 'Wert'}, function(data) {
        consider_cache = {};
        let t1 = Date.now();
        console.log(`request took ${t1 - t0} ms.`);
        console.log(data);
        if (data.success) {
            container.empty();
            let header_cells = [];
            for (let item of ['Nr.', 'Nachname', 'Vorname', 'Klasse', 'Zeugniskonf.']) {
                let label = `${item}`;
                let th = $('<th>').html(label);
                if (item === 'Nachname') th.addClass('thsticky');
                header_cells.push(th);
            }
            for (let fach of faecher) {
                let fach_label = fach;
                if (liste.wahlfach[fach]) fach_label = `(${fach})`;
                let lehrer_liste = liste.lehrer_for_fach[fach] ?? [];
                if (lehrer_liste.length === 0) lehrer_liste = ['--'];
                let label = `${fach_label}<br /><span style='font-size: 85%; font-weight: normal;'>(${lehrer_liste.join(', ')})</span>`;
                let th = $('<th>').html(label);
                th.css('text-align', 'center');
                header_cells.push(th);
                if (FAECHER_SPRACHEN.indexOf(fach) >= 0) {
                    for (let suffix of ['_AT', '_SL']) {
                        let label = `<span style='font-weight: normal;'>(${suffix.replace('_', '')})</span><br />&nbsp;`;
                        let th = $('<th>').html(label);
                        th.css('text-align', 'center');
                        header_cells.push(th);
                    }
                }
            }
            let table = new SortableTable({
                element: container,
                xs: true,
                headers: header_cells,
                rows: emails.map(function (email, index) {
                    let consider_this = (data.results[1][0][0][0][index] === true);
                    let cells = [
                        email,
                        `<td style='text-align: right;'>${index + 1}.</td>`,
                        `<td class='tdsticky' style='max-width: 10em;'>${liste.schueler[index].last_name}</td>`,
                        `<td style='max-width: 10em;'>${liste.schueler[index].official_first_name}</td>`,
                        // `<td>${moment(liste.schueler[index].geburtstag).format('L')}</td>`,
                        `<td style='text-align: center;'>${klassen_tr[klasse] ?? klasse}</td>`,
                    ];
                    let bu_consider = $(`<button class='btn btn-xs'>`);
                    style_consider_button(bu_consider, false);
                    if (!edit_noten)
                        bu_consider.prop('disabled', true);
                    cells.push($('<td>').append(bu_consider));
                    bu_consider.on('click', function(e) {
                        let path = `Schuljahr:${ZEUGNIS_SCHULJAHR}/Halbjahr:${ZEUGNIS_HALBJAHR}/ZK:marked/Email:${email}`;
                        tresor_api_call('/jwt/toggle', {path: path, key: 'Wert'}, function(data) {
                            console.log(data);
                            if (data.success) {
                                if (data.value === true) {
                                    style_consider_button(bu_consider, true);
                                } else {
                                    style_consider_button(bu_consider, consider_cache[email]);
                                }
                            }
                        });
                    });
                    for (let fi = 0; fi < faecher_for_paths.length; fi++) {
                        let fach = faecher_for_paths[fi];
                        let input = $(`<input placeholder='--' class='form-control' style='width: 3em; text-align: center; height: calc(1.5em + 2px);'>`)
                        if (!edit_noten || ((!my_zeugnisliste[`${klasse}/${fach}`]) && ('#{zeugnis_admin_logged_in?}' === 'false'))) {
                            input.prop('disabled', true);
                        }
                        let value = data.results[0][0][0][fi][index];
                        if (noten_mark.indexOf(value) >= 0) {
                            consider_cache[email] = true;
                            consider_this = true;
                        }
                        input.val(value);
                        input.focus(function(e) {
                            input.select();
                            // input[0].scrollIntoView({behavior: 'instant', block: 'center', inline: 'center'});
                            container.find('tr').removeClass('focused');
                            input.closest('tr').addClass('focused');
                            $(e.target).data('old_value', $(e.target).val());
                        });
                        input.blur(function(e) {
                            container.find('tr').removeClass('focused');
                            let value = $(e.target).val().trim();
                            if (value !== $(e.target).data('old_value')) {
                                let path = `Schuljahr:${ZEUGNIS_SCHULJAHR}/Halbjahr:${ZEUGNIS_HALBJAHR}/Fach:${fach}/Email:${email}`;
                                input_note_apply_style_and_fix($(e.target), function(value) {
                                    input.closest('td').find('i.fa').remove();
                                    tresor_api_call('/jwt/store', {path: path, key: 'Wert', value: value}, function(data) {
                                        if (data.success) {
                                            $(e.target).data('old_value', value);
                                        } else {
                                            $(e.target).val($(e.target).data('old_value'));
                                            input_note_apply_style_and_fix($(e.target), function(value) {
                                                let icon = $(`<i class='fa fa-times tresor_icon text-danger'>`);
                                                icon.appendTo(input.closest('td'));
                                            });
                                        }
                                    });
                                });
                            }
                        });
                        input.keydown(function(e) {
                            if (e.key === 'Enter' || e.key === 'ArrowDown') {
                                e.preventDefault();
                                e.stopPropagation();
                                let row = $(e.target).closest('tr');
                                let this_index = $(e.target).closest('td').index();
                                let next_row = row.next('tr');
                                if (next_row.length === 0) {
                                    next_row = row.closest('tbody').find('tr').first();
                                }
                                next_row.find('td').eq(this_index).find('input').focus().select();
                            }
                            if (e.key === 'ArrowUp') {
                                e.preventDefault();
                                e.stopPropagation();
                                let row = $(e.target).closest('tr');
                                let this_index = $(e.target).closest('td').index();
                                let next_row = row.prev('tr');
                                if (next_row.length === 0) {
                                    next_row = row.closest('tbody').find('tr').last()
                                }
                                next_row.find('td').eq(this_index).find('input').focus().select();
                            }
                        });
                        cells.push($('<td>').append($(`<div class='note'>`).append(input)));
                        input_note_apply_style_and_fix(input);
                    }
                    if (consider_this)
                        style_consider_button(bu_consider, true);
                    return cells;
                }),
                sortable: false,
            });
            container.find('.table').css('width', 'unset');
        }
    });
}

function load_fehltage_table(container, klasse, edit_noten) {
    // for (let lesson_key of lesson_keys) {
    //     let info = kurs_info[lesson_key];
    //     console.log(info.fach);
    // }
    let path_array = [];
    path_array.push(['Schuljahr', ZEUGNIS_SCHULJAHR]);
    path_array.push(['Halbjahr', ZEUGNIS_HALBJAHR]);
    let liste = zeugnisliste_for_klasse[klasse];
    let items = ['VT', 'VT_UE', 'VS', 'VS_UE', 'VSP'];
    let emails = liste.schueler.map(function(x) { return x.email; });
    path_array.push(['Fehltage', items]);
    path_array.push(['Email', emails]);
    let t0 = Date.now();
    tresor_api_call('/jwt/get_many', {path_arrays: [path_array], key: 'Wert'}, function(data) {
        let t1 = Date.now();
        console.log(`request took ${t1 - t0} ms.`);
        if (data.success) {
            container.empty();
            let table = new SortableTable({
                element: container,
                xs: true,
                headers: (['Nr.', 'Nachname', 'Vorname', 'Klasse'].concat(items.map(function(fach) {
                    let fach_label = {
                        'VT': 'Versäumte<br />Tage',
                        'VT_UE': 'davon UE',
                        'VS': 'Versäumte<br />Stunden',
                        'VS_UE': 'davon UE',
                        'VSP': 'Verspätungen',
                    }[fach] ?? fach;
                    return `${fach_label}`;
                }))).map(function (x) {
                    let th = $('<th>').html(x);
                    if (x === 'Nachname') th.addClass('thsticky');
                    if (['Nr.', 'Nachname', 'Vorname', 'Klasse'].indexOf(x) < 0) th.css('text-align', 'center');
                    return th;
                }),
                rows: emails.map(function (email, index) {
                    let cells = [
                        email,
                        `<td style='text-align: right;'>${index + 1}.</td>`,
                        `<td class='tdsticky' style='max-width: 10em;'>${liste.schueler[index].last_name}</td>`,
                        `<td style='max-width: 10em;'>${liste.schueler[index].official_first_name}</td>`,
                        // `<td>${moment(liste.schueler[index].geburtstag).format('L')}</td>`,
                        `<td>${klassen_tr[klasse] ?? klasse}</td>`,
                    ];
                    for (let fi = 0; fi < items.length; fi++) {
                        let item = items[fi];
                        let input = $(`<input placeholder='--' class='form-control' style='width: 3em; text-align: center; height: calc(1.5em + 2px);'>`)
                        if (!edit_noten || ((!my_zeugnisliste[`${klasse}/${item}`]) && ('#{zeugnis_admin_logged_in?}' === 'false'))) {
                            input.prop('disabled', true);
                        }
                        input.val(data.results[0][0][0][fi][index]);
                        input.focus(function(e) {
                            input.select();
                            // input[0].scrollIntoView({behavior: 'instant', block: 'center', inline: 'center'});
                            container.find('tr').removeClass('focused');
                            input.closest('tr').addClass('focused');
                            $(e.target).data('old_value', $(e.target).val());
                        });
                        input.blur(function(e) {
                            container.find('tr').removeClass('focused');
                            let value = $(e.target).val().trim();
                            if (value !== $(e.target).data('old_value')) {
                                let path = `Schuljahr:${ZEUGNIS_SCHULJAHR}/Halbjahr:${ZEUGNIS_HALBJAHR}/Fehltage:${item}/Email:${email}`;
                                input_anzahl_apply_style_and_fix($(e.target), function(value) {
                                    input.closest('td').find('i.fa').remove();
                                    tresor_api_call('/jwt/store', {path: path, key: 'Wert', value: value}, function(data) {
                                        if (data.success) {
                                            $(e.target).data('old_value', value);
                                        } else {
                                            $(e.target).val($(e.target).data('old_value'));
                                            input_anzahl_apply_style_and_fix($(e.target), function(value) {
                                                let icon = $(`<i class='fa fa-times tresor_icon text-danger'>`);
                                                icon.appendTo(input.closest('td'));
                                            });
                                        }
                                    });
                                });
                            }
                        });
                        input.keydown(function(e) {
                            if (e.key === 'Enter' || e.key === 'ArrowDown') {
                                e.preventDefault();
                                e.stopPropagation();
                                let row = $(e.target).closest('tr');
                                let this_index = $(e.target).closest('td').index();
                                let next_row = row.next('tr');
                                if (next_row.length === 0) {
                                    next_row = row.closest('tbody').find('tr').first();
                                }
                                next_row.find('td').eq(this_index).find('input').focus().select();
                            }
                            if (e.key === 'ArrowUp') {
                                e.preventDefault();
                                e.stopPropagation();
                                let row = $(e.target).closest('tr');
                                let this_index = $(e.target).closest('td').index();
                                let next_row = row.prev('tr');
                                if (next_row.length === 0) {
                                    next_row = row.closest('tbody').find('tr').last()
                                }
                                next_row.find('td').eq(this_index).find('input').focus().select();
                            }
                        });
                        cells.push($('<td>').append($(`<div class='note'>`).append(input)));
                            input_anzahl_apply_style_and_fix(input);
                    }
                    return cells;
                }),
                sortable: false,
            });
            container.find('.table').css('width', 'unset');
        }
    });
}

function load_sozialverhalten_table(container, klasse, edit_noten) {
    // for (let lesson_key of lesson_keys) {
    //     let info = kurs_info[lesson_key];
    //     console.log(info.fach);
    // }
    let path_array = [];
    path_array.push(['Schuljahr', ZEUGNIS_SCHULJAHR]);
    path_array.push(['Halbjahr', ZEUGNIS_HALBJAHR]);
    let liste = zeugnisliste_for_klasse[klasse];
    let items = ['ZV', 'LLB', 'SSK', 'KF', 'SV'];
    let emails = liste.schueler.map(function(x) { return x.email; });
    let faecher = liste.faecher;
    path_array.push(['SV', items]);
    let my_faecher = [];
    for (let fach of faecher) {
        if (my_zeugnisliste[`${klasse}/${fach}`]) my_faecher.push(fach);
    }
    if (my_zeugnisliste[`${klasse}/VT`]) my_faecher.push('_KL');
    path_array.push(['Fach', my_faecher]);
    path_array.push(['Email', emails]);
    let t0 = Date.now();

    tresor_api_call('/jwt/get_many', {path_arrays: [path_array], key: 'Wert'}, function(data) {
        let t1 = Date.now();
        console.log(`request took ${t1 - t0} ms.`);
        if (data.success) {
            container.empty();
            let rows = [];
            for (let index = 0; index < emails.length; index++) {
                let email = emails[index];
                for (let fach_index = 0; fach_index < my_faecher.length; fach_index++) {
                    let fach = my_faecher[fach_index];
                    let cells = [email];
                    if (fach_index === 0) {
                        cells.push(`<td style='text-align: right;'>${index + 1}.</td>`);
                        cells.push(`<td class='tdsticky' style='max-width: 10em;'>${liste.schueler[index].last_name}</td>`);
                        cells.push(`<td style='max-width: 10em;'>${liste.schueler[index].official_first_name}</td>`);
                        cells.push(`<td>${klassen_tr[klasse] ?? klasse}</td>`);
                    } else {
                        cells.push(`<td></td>`);
                        cells.push(`<td></td>`);
                        cells.push(`<td></td>`);
                        cells.push(`<td></td>`);
                    }
                    if (fach === '_KL')
                        cells.push(`<td class='tdsticky' style='left: 5em;'>KL</td>`);
                    else
                        cells.push(`<td class='tdsticky' style='left: 5em;'>${fach}</td>`);
                    for (let fi = 0; fi < items.length; fi++) {
                        let item = items[fi];
                        let input = $(`<input placeholder='--' class='form-control' style='width: 3em; text-align: center; height: calc(1.5em + 2px);'>`)
                        if (!edit_noten || ((!my_zeugnisliste[`${klasse}/${item}/${fach}`]) && ('#{zeugnis_admin_logged_in?}' === 'false'))) {
                            input.prop('disabled', true);
                        }
                        input.val(data.results[0][0][0][fi][fach_index][index]);
                        input.focus(function(e) {
                            input.select();
                            // input[0].scrollIntoView({behavior: 'instant', block: 'center', inline: 'center'});
                            container.find('tr').removeClass('focused');
                            input.closest('tr').addClass('focused');
                            $(e.target).data('old_value', $(e.target).val());
                        });
                        input.blur(function(e) {
                            container.find('tr').removeClass('focused');
                            let value = $(e.target).val().trim();
                            if (value !== $(e.target).data('old_value')) {
                                let path = `Schuljahr:${ZEUGNIS_SCHULJAHR}/Halbjahr:${ZEUGNIS_HALBJAHR}/SV:${item}/Fach:${fach}/Email:${email}`;
                                input_tendenz_apply_style_and_fix($(e.target), function(value) {
                                    input.closest('td').find('i.fa').remove();
                                    tresor_api_call('/jwt/store', {path: path, key: 'Wert', value: value}, function(data) {
                                        if (data.success) {
                                            $(e.target).data('old_value', value);
                                        } else {
                                            $(e.target).val($(e.target).data('old_value'));
                                            input_tendenz_apply_style_and_fix($(e.target), function(value) {
                                                let icon = $(`<i class='fa fa-times tresor_icon text-danger'>`);
                                                    icon.appendTo(input.closest('td'));
                                                });
                                            }
                                        });
                                    });
                                }
                        });
                        input.keydown(function(e) {
                            if (e.key === 'Enter' || e.key === 'ArrowDown') {
                                e.preventDefault();
                                e.stopPropagation();
                                let row = $(e.target).closest('tr');
                                let this_index = $(e.target).closest('td').index();
                                let next_row = row.next('tr');
                                if (next_row.length === 0) {
                                    next_row = row.closest('tbody').find('tr').first();
                                }
                                next_row.find('td').eq(this_index).find('input').focus().select();
                            }
                            if (e.key === '1' || e.key === '2' || e.key === '3' || e.key === '4') {
                                e.preventDefault();
                                e.stopPropagation();
                                $(e.target).val({'1': '++', '2': '+', '3': 'o', '4': '-'}[e.key]);
                                let row = $(e.target).closest('tr');
                                let this_index = $(e.target).closest('td').index();
                                let next_row = row.next('tr');
                                if (next_row.length === 0) {
                                    next_row = row.closest('tbody').find('tr').first();
                                }
                                next_row.find('td').eq(this_index).find('input').focus().select();
                            }
                            if (e.key === 'ArrowUp') {
                                e.preventDefault();
                                e.stopPropagation();
                                let row = $(e.target).closest('tr');
                                let this_index = $(e.target).closest('td').index();
                                let next_row = row.prev('tr');
                                if (next_row.length === 0) {
                                    next_row = row.closest('tbody').find('tr').last()
                                }
                                next_row.find('td').eq(this_index).find('input').focus().select();
                            }
                        });
                        cells.push($('<td>').append($(`<div class='note'>`).append(input)));
                        input_tendenz_apply_style_and_fix(input);
                    }
                    rows.push(cells);
                }
            }
            let table = new SortableTable({
                element: container,
                xs: true,
                headers: (['Nr.', 'Nachname', 'Vorname', 'Klasse', 'Fach'].concat(items.map(function(fach) {
                    let fach_label = {
                        'ZV': 'Zuverlässigkeit',
                        'LLB': 'Leistungs- und<br />Lernbereitschaft',
                        'SSK': 'Selbständigkeit',
                        'KF': 'Kooperations-<br />fähigkeit',
                        'SV': 'Soziales<br />Verhalten',
                    }[fach] ?? fach;
                    return `${fach_label}`;
                }))).map(function (x) {
                    let th = $(`<th>`).html(x);
                    if (x === 'Nachname' || x === 'Fach') th.addClass('thsticky');
                    if (x === 'Fach') th.css('left', '5em');
                    if (['Nr.', 'Nachname', 'Vorname', 'Klasse'].indexOf(x) < 0) th.css('text-align', 'center');
                    return th;
                }),
                rows: rows,
                sortable: false,
            });
            container.find('.table').css('width', 'unset');
        }
    });
}

function load_angebote_bemerkungen_table(container, klasse, edit_noten) {
    // for (let lesson_key of lesson_keys) {
    //     let info = kurs_info[lesson_key];
    //     console.log(info.fach);
    // }
    let path_array = [];
    path_array.push(['Schuljahr', ZEUGNIS_SCHULJAHR]);
    path_array.push(['Halbjahr', ZEUGNIS_HALBJAHR]);
    let liste = zeugnisliste_for_klasse[klasse];
    let items = ['Versetzt', 'Angebote', 'Bemerkungen'];
    let emails = liste.schueler.map(function(x) { return x.email; });
    path_array.push(['AB', items]);
    path_array.push(['Email', emails]);
    let t0 = Date.now();
    tresor_api_call('/jwt/get_many', {path_arrays: [path_array], key: 'Wert'}, function(data) {
        let t1 = Date.now();
        console.log(`request took ${t1 - t0} ms.`);
        console.log(data);
        if (data.success) {
            container.empty();
            let table = new SortableTable({
                element: container,
                xs: true,
                headers: (['Nr.', 'Nachname', 'Vorname', 'Klasse'].concat(items.map(function(fach) {
                    return `${fach}`;
                }))).map(function (x) {
                    let th = $('<th>').html(x);
                    if (x === 'Nachname') th.addClass('thsticky');
                    if (['Nr.', 'Nachname', 'Vorname', 'Klasse'].indexOf(x) < 0) th.css('text-align', 'center');
                    return th;
                }),
                rows: emails.map(function (email, index) {
                    let cells = [
                        email,
                        `<td style='text-align: right;'>${index + 1}.</td>`,
                        `<td class='tdsticky' style='max-width: 10em;'>${liste.schueler[index].last_name}</td>`,
                        `<td style='max-width: 10em; user-select: all;'>${liste.schueler[index].official_first_name}</td>`,
                        // `<td>${moment(liste.schueler[index].geburtstag).format('L')}</td>`,
                        `<td>${klassen_tr[klasse] ?? klasse}</td>`,
                    ];
                    for (let fi = 0; fi < items.length; fi++) {
                        let item = items[fi];
                        let input = null;
                        if (item === 'Versetzt') {
                            let fach = item;
                            input = $(`<input placeholder='--' class='form-control' style='width: 4em; text-align: center; height: calc(1.5em + 2px);'>`)
                            if (!edit_noten) {
                                input.prop('disabled', true);
                            }
                            let value = data.results[0][0][0][fi][index];
                            console.log(email, value);
                            if (value === null) value = 'ja';
                            input.val(value);
                            input.focus(function(e) {
                                input.select();
                                // input[0].scrollIntoView({behavior: 'instant', block: 'center', inline: 'center'});
                                container.find('tr').removeClass('focused');
                                input.closest('tr').addClass('focused');
                                $(e.target).data('old_value', $(e.target).val());
                            });
                            input.blur(function(e) {
                                container.find('tr').removeClass('focused');
                                let value = $(e.target).val().trim();
                                if (value !== $(e.target).data('old_value')) {
                                    let path = `Schuljahr:${ZEUGNIS_SCHULJAHR}/Halbjahr:${ZEUGNIS_HALBJAHR}/AB:${item}/Email:${email}`;
                                    input_versetzt_apply_style_and_fix($(e.target), function(value) {
                                        input.closest('td').find('i.fa').remove();
                                        tresor_api_call('/jwt/store', {path: path, key: 'Wert', value: value}, function(data) {
                                            if (data.success) {
                                                $(e.target).data('old_value', value);
                                            } else {
                                                $(e.target).val($(e.target).data('old_value'));
                                                input_versetzt_apply_style_and_fix($(e.target), function(value) {
                                                    let icon = $(`<i class='fa fa-times tresor_icon text-danger'>`);
                                                    icon.appendTo(input.closest('td'));
                                                });
                                            }
                                        });
                                    });
                                }
                            });
                            input.keydown(function(e) {
                                if (e.key === 'Enter' || e.key === 'ArrowDown') {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    let row = $(e.target).closest('tr');
                                    let this_index = $(e.target).closest('td').index();
                                    let next_row = row.next('tr');
                                    if (next_row.length === 0) {
                                        next_row = row.closest('tbody').find('tr').first();
                                    }
                                    next_row.find('td').eq(this_index).find('input').focus().select();
                                }
                                if (e.key === 'ArrowUp') {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    let row = $(e.target).closest('tr');
                                    let this_index = $(e.target).closest('td').index();
                                    let next_row = row.prev('tr');
                                    if (next_row.length === 0) {
                                        next_row = row.closest('tbody').find('tr').last()
                                    }
                                    next_row.find('td').eq(this_index).find('input').focus().select();
                                }
                            });
                            cells.push($('<td>').append($(`<div class='note'>`).append(input)));
                            input_versetzt_apply_style_and_fix(input);
                        } else {
                            input = $(`<textarea placeholder='--' class='form-control' style='width: 100%; height: 10em;' ${edit_noten ? '' : 'disabled readonly'}>`);
                            input.val(data.results[0][0][0][fi][index]);
                            input.focus(function(e) {
                                // input.select();
                                // input[0].scrollIntoView({behavior: 'instant', block: 'center', inline: 'center'});
                                container.find('tr').removeClass('focused');
                                input.closest('tr').addClass('focused');
                                $(e.target).data('old_value', $(e.target).val());
                            });
                            input.blur(function(e) {
                                container.find('tr').removeClass('focused');
                                let value = $(e.target).val().trim();
                                if (value !== $(e.target).data('old_value')) {
                                    let path = `Schuljahr:${ZEUGNIS_SCHULJAHR}/Halbjahr:${ZEUGNIS_HALBJAHR}/AB:${item}/Email:${email}`;
                                    input.closest('td').find('i.fa').remove();
                                    tresor_api_call('/jwt/store', {path: path, key: 'Wert', value: value}, function(data) {
                                        if (data.success) {
                                            $(e.target).data('old_value', value);
                                        } else {
                                            $(e.target).val($(e.target).data('old_value'));
                                            let icon = $(`<i class='fa fa-times tresor_icon text-danger'>`);
                                            icon.appendTo(input.closest('td'));
                                        }
                                    });
                                }
                            });
                            input.on('keyup blur', function(e) {
                                let text = input.val();
                                console.log(text);
                                text = text.replace(RegExp(/\(NAME\)/g), liste.schueler[index].official_first_name);
                                input.val(text);
                            });
                            cells.push($(`<td style='${item !== 'Versetzt' ? 'width: 50%;' : ''}'>`).append($(`<div>`).append(input)));
                        }
                    }
                    return cells;
                }),
                sortable: false,
            });
            container.find('.table').css('width', 'unset');
        }
    });
}

function open_pdf(data, name) {
    open_pdf_with_filename(data, `Zeugnis ${name}.pdf`);
}

function open_pdf_with_filename(data, filename) {
    let s = atob(data);
    let bytes = new Uint8Array(s.length);
    for (let i = 0; i < s.length; i++) {
        bytes[i] = s.charCodeAt(i);
    }
    let blob = new Blob([bytes], {type: "application/pdf"})
    console.log(blob);
    // var url = window.URL.createObjectURL(blob);
    // console.log(url);
    // window.open(url, '_blank');
    let a = document.createElement('a');
    a.href = window.URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}

function open_docx(data, name) {
    let s = atob(data);
    let bytes = new Uint8Array(s.length);
    for (let i = 0; i < s.length; i++) {
        bytes[i] = s.charCodeAt(i);
    }
    let blob = new Blob([bytes], {type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"})
    console.log(blob);
    let a = document.createElement('a');
    a.href = window.URL.createObjectURL(blob);
    a.download = `Zeugnis ${name}.docx`;
    a.click();
}

</script>