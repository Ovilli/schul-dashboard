#{this_is_a_page_for_logged_in_teachers}
<style>
    .safari_volume_indicator {
        display: block;
        position: fixed;
        right: 4px;
        bottom: 4px;
        width: 45px;
        height: 45px;
        z-index: 100000;
        padding-top: 5px;
        border: 1px solid rgba(0,0,0,0.2);
        border-radius: 100%;
        box-shadow: rgb(0 0 0 / 20%) 0px -1px 10px;
        font-size: 145%;
        text-align: center;
    }

    .api_messages {
        position: absolute;
        top: 60px;
        width: 80%;
        left: 10%;
        display: none;
    }

    body {
        /* background: none; */
        /* background-color: white; */
        /* padding-top: 120px; */
        background-attachment: fixed;
    }

    .api_messages {
        position: fixed;
        z-index: 101;
    }

    #submenu {
        position: fixed;
        top: 57px;
        z-index: 100;
        border-bottom: 1px solid #bbb;
    }

    .submenu a {
        white-space: nowrap;
    }

    .submenu {
        overflow-x: auto;
    }

    .container {
        padding-top: 15px;
    }

    .bib_management_only {
        min-height: 50px;
        border-top: 1px dashed #ddd;
        padding: 10px;
        background: linear-gradient(#eee 0px, #fff 50px);
        margin-left: -15px;
        margin-right: -15px;
        margin-top: 15px;
        padding-top: 30px;
        display: none;
    }

    body {
        #{@session_device ? 'padding-top: 0;' : '' }
    }

    .navbar {
        #{@session_device ? 'display: none;' : '' }
    }

    #device_navbar {
        #{@session_device ? '' : 'display: none;' }
        background-color: white;
        border-radius: 0;
        padding: 10px 15px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        white-space: nowrap;
        overflow-x: auto;
    }

    @media (max-width: 575px) {
        ._barcode_widget > div:first-child {
            height: 120px!important;
        }

        ._barcode_widget {
            border-radius: 0!important;
            margin: 0px -15px 15px -15px!important;
            border: none!important;
            border-bottom: 1px solid #ddd!important;
        }
    }

    .sandbox-hint {
        text-align: center;
        background-color: #fce94f;
        border-radius: 0;
        padding: 5px 15px;
        border-top: 1px solid rgba(0,0,0,0.1);
        border-bottom: 1px solid rgba(0,0,0,0.1);
        white-space: nowrap;
        overflow-x: auto;
    }

    .sandbox-hint::-webkit-scrollbar {
        display: none;
    }

    .sandbox-hint {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .container, .container-lg, .container-md, .container-sm, .container-xl {
        /* max-width: calc(100% - 30px); */
    }

    #bu-refresh-second-factor {
        transition: background 1s ease;
    }
    #bu-refresh-second-factor .fa {
        transition: color 1s ease;
    }

    tr.focused {
        background-color: #fce98d;
    }
    div.note {
        position: relative;
        /* font-family: 'IBM Plex Sans'; */
        /* font-size: 90%; */
    }
    div.note:after {
        position: absolute;
        width: 1.5em;
        height: 1.5em;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 100%;
        content: '';
        pointer-events: none;
    }
    div.note.empty input {
        background-color: rgba(225, 177, 20, 0.481);
    }
    div.note.marked:after {
        outline: 2px solid #d5291a;
        background-color: rgba(213, 41, 26, 0.1);
    }
    div.note input {
        margin-left: auto;
        margin-right: auto;
    }
    div.note input:disabled {
        background: none;
        border: none;
        padding: 0;
        width: 2em!important;
    }

    .container, .container-lg, .container-md, .container-sm, .container-xl {
        max-width: 1500px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }

    .extra-padding {
        padding-top: 72px;
    }

    .form-control:disabled {
        opacity: 1.0;
    }

    @tailwind base;
    @tailwind components;
    @tailwind utilities;
</style>

<div class='api_messages'></div>
<div id="device_navbar" class="container">
    <img src='#{NEXTCLOUD_URL}/index.php/avatar/#{@session_user[:nc_login]}/256}' class='avatar-md'/>
    <span style="display: inline-block; margin-left: 5px; position: relative; top: 2px;">#{@session_user[:display_name]}</span>
    <button id='bu_logout' class="pull-right btn btn-sm btn-danger"><i class='fa fa-sign-out'></i>&nbsp;&nbsp;Abmelden</button>
</div>
<div id='submenu' class='container' style='padding: 0; display: flex; background: white; border-radius: 0; display: #{second_factor_time_left.nil? ? 'none' : 'block'};'>
    <section class="w-full" style="height: 51px; display: #{second_factor_time_left.nil? ? 'none' : 'block'};">
        <ul class="submenu flex bg-white px-2.5 py-2"
            style="border-bottom: 1px solid #eee; left: 0px; right: 0px; z-index: 100;">
            <li class="mx-1" style="display: #{zeugnis_admin_logged_in? ? 'unset' : 'none'};">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3"
                    href="/zeugnisformulare"><i class='fa fa-file-word-o'></i>&nbsp;&nbsp;Zeugnisformulare</a>
            </li>
            <li class="mx-1">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3"
                    href="/zeugnislisten"><i class='fa fa-table'></i>&nbsp;&nbsp;Zeugnislisten</a>
            </li>
            <li class="mx-1" style="display: #{((!@session_user[:klassenleitung].nil?) || zeugnis_admin_logged_in?) ? 'unset' : 'none'};">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3"
                    href="/zeugnis_fehltage"><i class='fa fa-clock-o'></i>&nbsp;&nbsp;Fehltage #{(@session_user[:klassenleitung] || []).map { |x| tr_klasse(x) }.join(', ')}</a>
            </li>
            <li class="mx-1" style="display: #{((!@session_user[:klassenleitung].nil?) || zeugnis_admin_logged_in?) ? 'unset' : 'none'};">
                <a class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3"
                    href="/zeugnisdruck"><i class='fa fa-print'></i>&nbsp;&nbsp;Zeugnisdruck</a>
            </li>
            <li style="border-left: 1px solid #ccc; height: 52px; margin: -10px 10px -10px 10px; margin-left: auto;">
            </li>
            <li class="mx-1">
                <button id='bu-refresh-second-factor' style='white-space: nowrap;' class="inline-block bg-slate-900 border border-blue-500 rounded py-1 px-3"><i class='text-slate-600 fa fa-clock-o'></i>&nbsp;&nbsp;<span style='display: inline-block; width: 3em;' id="sf-time-left"></span></button>
            </li>
            <li class="mx-1">
                <button id='bu-delete-second-factor' style='white-space: nowrap;' class="inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3"><i class='text-slate-600 fa fa-sign-out'></i>&nbsp;&nbsp;Abmelden</button>
            </li>
        </ul>
    </section>
</div>
<div id='subsubmenu' class='container'
    style='padding: 0; display: flex; background: white; border-radius: 0; display: none;'>
    <section class="w-full" style="height: 51px;">
        <ul class="submenu flex bg-stone-900 px-2.5 py-2"
            style="border-bottom: 1px solid #eee; left: 0px; right: 0px; z-index: 100;">
            <li id='sub_menu_extra' style='margin-left: auto;'></li>
        </ul>
    </section>
</div>

<script>
var second_factor_expires = Math.round((Date.now() / 1000.0) + #{second_factor_time_left || 0});
var edit_enabled = false;

function update_edit_button() {
    let button = $('#bu_toggle_edit');
    if (edit_enabled) {
        button.html(`<i class='fa fa-unlock'></i>&nbsp;&nbsp;Tabelle für Bearbeitung schließen`);
        button.removeClass('btn-secondary').addClass('btn-success');
    } else {
        button.html(`<i class='fa fa-lock'></i>&nbsp;&nbsp;Tabelle für Bearbeitung öffnen`);
        button.removeClass('btn-success').addClass('btn-secondary');
    }
}

function update_time_left() {
    if ('#{second_factor_time_left.nil?}' === 'true') {
        $('.bg-white').removeClass('extra-padding');
    }
    let seconds_left = Math.round(second_factor_expires - (Date.now() / 1000.0));
    if (seconds_left <= 0 && ('#{second_factor_time_left.nil?}' !== 'true')) {
        window.location.href = '/tresor';
        return;
    }
    let minutes = Math.floor(seconds_left / 60.0);
    let seconds = (seconds_left - minutes * 60);
    $('#sf-time-left').text(`${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);

    if (seconds_left <= 60) {
        $('#bu-refresh-second-factor').removeClass('bg-slate-900 bg-amber-300').addClass('bg-red-400');
        $('#bu-refresh-second-factor .fa').removeClass('text-slate-600 bg-amber-600').addClass('text-red-600');
    } else if (seconds_left <= 120) {
        $('#bu-refresh-second-factor').removeClass('bg-slate-900 bg-red-400').addClass('bg-amber-300');
        $('#bu-refresh-second-factor .fa').removeClass('text-slate-600 text-red-600').addClass('text-amber-600');
    } else {
        $('#bu-refresh-second-factor').removeClass('bg-red-400 bg-amber-300').addClass('bg-slate-900');
        $('#bu-refresh-second-factor .fa').removeClass('text-red-600 text-amber-600').addClass('text-slate-600');
    }
}

window.addEventListener('load', function () {
    $('.bg-white').addClass('extra-padding');
    tresor_api_call_no_jwt('/public/ping', {}, function(data) {
        console.log(data);
        if (!data.success) {
            if (window.location.pathname !== '/tresor')
                window.location.href = '/tresor';
            $('#connection-failed').show();
            $('.api_messages').hide();
            $('#submenu').hide();
            $('#subsubmenu').hide();
            $('.bg-white').removeClass('extra-padding');
        } else {
            $('#connection-established').show();
        }
    });
    update_time_left();
    setInterval(function() {
        update_time_left();
    }, 1000);
    $('#bu-refresh-second-factor').click(function(e) {
        api_call('/api/refresh_second_factor', {}, function(data) {
            if (data.success) {
                second_factor_expires = Math.round((Date.now() / 1000.0) + data.time_left);
                update_time_left();
            }
        });
    })
    $('#bu-delete-second-factor').click(function(e) {
        api_call('/api/delete_second_factor', {}, function(data) {
            if (data.success) {
                window.location.href = '/tresor';
                localStorage.setItem('tresor_jwt_token', null);
            }
        });
    })
    for (let x of $('.submenu a')) {
        let href = $(x).attr('href');
        if (window.location.pathname === href) {
            $(x).removeClass('bg-white').addClass('font-bold shadow-md outline outline-1 outline-blue-500 bg-white');
        }
    }
});

let noten_allowed_values = [
    '1+', '1', '1-',
    '2+', '2', '2-',
    '3+', '3', '3-',
    '4+', '4', '4-',
    '5+', '5', '5-',
    '6', 'n.e.', 'o.B.',
];

let noten_mark = ['4-', '5+', '5', '5-', '6'];

function input_note_apply_style_and_fix(input, callback) {
    let value = $(input).val().trim();
    let original_value = `${value}`;
    if (value.toLowerCase().replace(/[\.\s]+/g, '') == 'ne') value = 'n.e.';
    if (value.toLowerCase().replace(/[\.\s]+/g, '') == 'ob') value = 'o.B.';
    if (noten_allowed_values.indexOf(value) < 0) value = '';
    if (value === '') 
        $(input).closest('.note').addClass('empty');
    else
        $(input).closest('.note').removeClass('empty');

    if (original_value !== value) {
        $(input).val(value);
        input_note_apply_style_and_fix($(input), callback);
        return;
    } else {
        if (noten_mark.indexOf(value) >= 0)
            $(input).closest('.note').addClass('marked');
        else
            $(input).closest('.note').removeClass('marked');
        if (typeof(callback) !== 'undefined') callback(value);
    }
}

function input_anzahl_apply_style_and_fix(input, callback) {
    let value = $(input).val().trim();
    let original_value = `${value}`;
    let number = parseInt(value);
    if (isNaN(number)) number = '';
    if (number < 0) number = '';
    if (number === '')
        $(input).closest('.note').addClass('empty');
    else
        $(input).closest('.note').removeClass('empty');
    value = `${number}`;

    if (original_value !== value) {
        $(input).val(value);
        input_anzahl_apply_style_and_fix($(input), callback);
        return;
    } else {
        if (typeof(callback) !== 'undefined') callback(value);
    }
}

function load_noten_table(container, klasse, edit_noten) {
    // for (let lesson_key of lesson_keys) {
    //     let info = kurs_info[lesson_key];
    //     console.log(info.fach);
    // }
    let path_array = [];
    path_array.push(['Schuljahr', ZEUGNIS_SCHULJAHR]);
    path_array.push(['Halbjahr', ZEUGNIS_HALBJAHR]);
    let liste = zeugnisliste_for_klasse[klasse];
    let faecher = liste.faecher;
    let emails = liste.schueler.map(function(x) { return x.email; });
    path_array.push(['Fach', faecher]);
    path_array.push(['Email', emails]);
    let t0 = Date.now();
    tresor_api_call('/jwt/get_many', {path_arrays: [path_array], key: 'Wert'}, function(data) {
        let t1 = Date.now();
        console.log(`request took ${t1 - t0} ms.`);
        if (data.success) {
            container.empty();
            let table = new SortableTable({
                element: container,
                xs: true,
                headers: (['Nr.', 'Nachname', 'Vorname', 'Klasse'].concat(faecher.map(function(fach) { 
                    let fach_label = fach;
                    if (liste.wahlfach[fach]) fach_label = `(${fach})`;
                    let lehrer_liste = liste.lehrer_for_fach[fach];
                    if (lehrer_liste.length === 0) lehrer_liste = ['--'];
                    return `${fach_label}<br /><span style='font-size: 85%; font-weight: normal;'>(${lehrer_liste.join(', ')})</span>`; 
                }))).map(function (x) {
                    let th = $('<th>').html(x);
                    if (['Nr.', 'Nachname', 'Vorname', 'Klasse'].indexOf(x) < 0) th.css('text-align', 'center');
                    return th;
                }),
                rows: emails.map(function (email, index) {
                    let cells = [
                        email,
                        `<td style='text-align: right;'>${index + 1}.</td>`,
                        `<td style='max-width: 10em;'>${liste.schueler[index].last_name}</td>`,
                        `<td style='max-width: 10em;'>${liste.schueler[index].official_first_name}</td>`,
                        // `<td>${moment(liste.schueler[index].geburtstag).format('L')}</td>`,
                        `<td>${klassen_tr[klasse] ?? klasse}</td>`,
                    ];
                    for (let fi = 0; fi < faecher.length; fi++) {
                        let fach = faecher[fi];
                        let input = $(`<input placeholder='--' class='form-control' style='width: 3em; text-align: center; height: calc(1.5em + 2px);'>`)
                        if (!edit_noten || ((!my_zeugnisliste[`${klasse}/${fach}`]) && ('#{zeugnis_admin_logged_in?}' === 'false'))) {
                            input.prop('disabled', true);
                        }
                        input.val(data.results[0][0][0][fi][index]);
                        input.focus(function(e) {
                            input.select();
                            container.find('tr').removeClass('focused');
                            input.closest('tr').addClass('focused');
                            $(e.target).data('old_value', $(e.target).val());
                        });
                        input.blur(function(e) {
                            container.find('tr').removeClass('focused');
                            let value = $(e.target).val().trim();
                            if (value !== $(e.target).data('old_value')) {
                                let path = `Schuljahr:${ZEUGNIS_SCHULJAHR}/Halbjahr:${ZEUGNIS_HALBJAHR}/Fach:${fach}/Email:${email}`;
                                input_note_apply_style_and_fix($(e.target), function(value) {
                                    $(e.target).data('old_value', value);
                                    tresor_api_call('/jwt/store', {path: path, key: 'Wert', value: value}, function(data) {
                                    });
                                });
                            }
                        });
                        input.keydown(function(e) {
                            if (e.key === 'Enter' || e.key === 'ArrowDown') {
                                e.preventDefault();
                                e.stopPropagation();
                                let row = $(e.target).closest('tr');
                                let this_index = $(e.target).closest('td').index();
                                let next_row = row.next('tr');
                                if (next_row.length === 0) {
                                    next_row = row.closest('tbody').find('tr').first();
                                }
                                next_row.find('td').eq(this_index).find('input').focus().select();
                            }
                            if (e.key === 'ArrowUp') {
                                e.preventDefault();
                                e.stopPropagation();
                                let row = $(e.target).closest('tr');
                                let this_index = $(e.target).closest('td').index();
                                let next_row = row.prev('tr');
                                if (next_row.length === 0) {
                                    next_row = row.closest('tbody').find('tr').last()
                                }
                                next_row.find('td').eq(this_index).find('input').focus().select();
                            }
                        });
                        cells.push($('<td>').append($(`<div class='note'>`).append(input)));
                        input_note_apply_style_and_fix(input);
                    }
                    return cells;
                }),
                sortable: false,
            });
            container.find('.table').css('width', 'unset');
        }
    });
}

function load_fehltage_table(container, klasse, edit_noten) {
    // for (let lesson_key of lesson_keys) {
    //     let info = kurs_info[lesson_key];
    //     console.log(info.fach);
    // }
    let path_array = [];
    path_array.push(['Schuljahr', ZEUGNIS_SCHULJAHR]);
    path_array.push(['Halbjahr', ZEUGNIS_HALBJAHR]);
    let liste = zeugnisliste_for_klasse[klasse];
    let items = ['VT', 'VT_UE', 'VS', 'VS_UE', 'VSP'];
    let emails = liste.schueler.map(function(x) { return x.email; });
    path_array.push(['Fehltage', items]);
    path_array.push(['Email', emails]);
    let t0 = Date.now();
    tresor_api_call('/jwt/get_many', {path_arrays: [path_array], key: 'Wert'}, function(data) {
        let t1 = Date.now();
        console.log(`request took ${t1 - t0} ms.`);
        if (data.success) {
            container.empty();
            let table = new SortableTable({
                element: container,
                xs: true,
                headers: (['Nr.', 'Nachname', 'Vorname', 'Klasse'].concat(items.map(function(fach) {
                    let fach_label = {
                        'VT': 'Versäumte<br />Tage',
                        'VT_UE': 'davon UE',
                        'VS': 'Versäumte<br />Stunden',
                        'VS_UE': 'davon UE',
                        'VSP': 'Verspätungen',
                    }[fach] ?? fach;
                    return `${fach_label}`;
                }))).map(function (x) {
                    let th = $('<th>').html(x);
                    if (['Nr.', 'Nachname', 'Vorname', 'Klasse'].indexOf(x) < 0) th.css('text-align', 'center');
                    return th;
                }),
                rows: emails.map(function (email, index) {
                    let cells = [
                        email,
                        `<td style='text-align: right;'>${index + 1}.</td>`,
                        `<td style='max-width: 10em;'>${liste.schueler[index].last_name}</td>`,
                        `<td style='max-width: 10em;'>${liste.schueler[index].official_first_name}</td>`,
                        // `<td>${moment(liste.schueler[index].geburtstag).format('L')}</td>`,
                        `<td>${klassen_tr[klasse] ?? klasse}</td>`,
                    ];
                    for (let fi = 0; fi < items.length; fi++) {
                        let item = items[fi];
                        let input = $(`<input placeholder='--' class='form-control' style='width: 3em; text-align: center; height: calc(1.5em + 2px);'>`)
                        if (!edit_noten || ((!my_zeugnisliste[`${klasse}/${item}`]) && ('#{zeugnis_admin_logged_in?}' === 'false'))) {
                            input.prop('disabled', true);
                        }
                        input.val(data.results[0][0][0][fi][index]);
                        input.focus(function(e) {
                            input.select();
                            container.find('tr').removeClass('focused');
                            input.closest('tr').addClass('focused');
                            $(e.target).data('old_value', $(e.target).val());
                        });
                        input.blur(function(e) {
                            container.find('tr').removeClass('focused');
                            let value = $(e.target).val().trim();
                            if (value !== $(e.target).data('old_value')) {
                                let path = `Schuljahr:${ZEUGNIS_SCHULJAHR}/Halbjahr:${ZEUGNIS_HALBJAHR}/Fehltage:${item}/Email:${email}`;
                                input_anzahl_apply_style_and_fix($(e.target), function(value) {
                                    $(e.target).data('old_value', value);
                                    tresor_api_call('/jwt/store', {path: path, key: 'Wert', value: value}, function(data) {
                                    });
                                });
                            }
                        });
                        input.keydown(function(e) {
                            if (e.key === 'Enter' || e.key === 'ArrowDown') {
                                e.preventDefault();
                                e.stopPropagation();
                                let row = $(e.target).closest('tr');
                                let this_index = $(e.target).closest('td').index();
                                let next_row = row.next('tr');
                                if (next_row.length === 0) {
                                    next_row = row.closest('tbody').find('tr').first();
                                }
                                next_row.find('td').eq(this_index).find('input').focus().select();
                            }
                            if (e.key === 'ArrowUp') {
                                e.preventDefault();
                                e.stopPropagation();
                                let row = $(e.target).closest('tr');
                                let this_index = $(e.target).closest('td').index();
                                let next_row = row.prev('tr');
                                if (next_row.length === 0) {
                                    next_row = row.closest('tbody').find('tr').last()
                                }
                                next_row.find('td').eq(this_index).find('input').focus().select();
                            }
                        });
                        cells.push($('<td>').append($(`<div class='note'>`).append(input)));
                            input_anzahl_apply_style_and_fix(input);
                    }
                    return cells;
                }),
                sortable: false,
            });
            container.find('.table').css('width', 'unset');
        }
    });
}

</script>