#{this_is_a_page_for_logged_in_teachers}
<style>
    #stage {
        text-align: center;
    }
    .sus-frame {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        position: relative;
        border-radius: 1vw;
        /* border: 1px solid red; */
        overflow: hidden;
        width: min(32vw, 20vh);
        height: calc(1.5 * min(32vw, 20vh));
        border: 0.3em solid white;
        box-shadow: 0 0 0.5em 0 rgba(0,0,0,0.2), inset 0 0 1em 0 rgba(0,0,0,0.5);
        margin: 0.5em;
    }
    .sus-foto {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        object-fit: cover;
        object-position: 50% 10%;
        box-shadow: 0 0 1em 0 rgba(0,0,0,0.5), inset 0 0 1em 0 rgba(0,0,0,0.5);
    }
    .sus-label {
        width: 100%;
        position: absolute;
        bottom: 0;
        font-size: calc(min(80vw, 50vh) * 0.04);
        background-color: rgba(255, 255, 255, 0.9);
        box-shadow: 0 0 1em rgba(0, 0, 0, 0.5);
        /* font-weight: bold; */
        color: #000;
        padding: 0.2em;
        padding-top: 0.3em;
        line-height: 110%;
    }
    .sus-label.nodata {
        color: #cc3729;
    }
    .sus-edit {
        width: 100%;
        position: absolute;
        bottom: 0;
        font-size: calc(min(80vw, 50vh) * 0.04);
        padding: 0.2em;
        font-size: 12pt;
    }
    .sus-foto-sm {
        background-color: white;
        width: min(32vw, 20vh);
        height: calc(1.5 * min(32vw, 20vh));
        object-fit: cover;
        object-position: 50% 5%;
        box-shadow: 0 0 0.1em 0 rgba(0,0,0,0.5), inset 0 0 0.1em 0 rgba(0,0,0,0.5);
        /* border: 0.1em solid white; */
    }
    #quiz-curtain {
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background-color: #f8f8f8;
        z-index: 1000;
        padding-top: 60px;
        color: #111;
        display: none;
    }
</style>
<div class='container-fluid'>
    <div class='row'>
        <div class="col-md-8 offset-md-4">
            <form id='form' autocomplete='off'>
                <div class="input-group mb-3">
                    <input type="password" autocomplete="off" id='password' class="form-control" placeholder="Bitte gib das Passwort ein, um das Klassenmemory zu starten" style="text-align: center; max-width: 30em;">
                    <div class="input-group-append">
                        <button id='submit_password' class="btn btn-primary" type="submit">Passwort absenden</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="col-md-12">
            <div id="klassen-div" style="display: none; text-align: center; padding-bottom: 1em;">
            </div>
            <div id='stage' style='display: none; margin-bottom: 30px;'>
                <div id="sus_here">
                </div>
            </div>
        </div>
    </div>
</div>

<div id="quiz-curtain">
    <h1>Hello</h1>
    <h1>Hello</h1>
    <h1>Hello</h1>
</div>

<datalist id="current_names">
</datalist>

<script>

var passphrase = '';
var FOTO_PASSWORD = #{FOTO_PASSWORD.to_json};
var KLASSEN_ORDER = #{KLASSEN_ORDER.to_json};
var KLASSEN_TR = #{KLASSEN_TR.to_json};
var schueler_for_klasse = #{@@schueler_for_klasse.to_json};
var user_info = #{@@user_info.to_json};
var email_for_foto_paths = #{get_emails_for_foto_paths().to_json};
var email_for_foto_paths_rev = {};
var email_for_foto_paths_emails = Object.values(email_for_foto_paths);

async function decryptData(encryptedData, password) {
    const enc = new TextEncoder();
    const salt = base64ToBytes(encryptedData.salt);
    const iv = base64ToBytes(encryptedData.iv);
    const ciphertext = base64ToBytes(encryptedData.data);
    const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password),
        {name: "PBKDF2", "hash": "SHA-1"}, false, ["deriveBits", "deriveKey"]);

    const key = await window.crypto.subtle.deriveKey({name: "PBKDF2", salt: salt,
        iterations: 20000, hash: "SHA-1", length: "256"}, keyMaterial, {name: "AES-CBC",
        hash: "SHA-1", length: 256}, true, ["encrypt", "decrypt"]);

    const decryptedData = await window.crypto.subtle.decrypt({name: "AES-CBC", iv: iv.buffer}, key, ciphertext.buffer);
    return new TextDecoder().decode(decryptedData);
}

function base64ToBytes(base64) {
    const binaryString = window.atob(base64);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes;
}

var current_klasse = '5a';
var email_for_name = {};

/*
 ROOKIE: Klasse auswählen: Foto mit Name wird ausgewählt + 3 weitere Namen mit gleichem Geschlecht: der richtige Name muss ausgewählt werden
 NOVICE: Klassenstufe auswählen: Foto mit Name wird ausgewählt + 3 weitere Namen mit gleichem Geschlecht: der richtige Name muss ausgewählt werden
 EXPERT: ganze Schule, weitere Namen werden aus gleicher Klassenstufe +/- 1 ausgewählt
 wenn ein Foto korrekt erkannt wurde: DB: Eintrag mit Zeitstempel, verfällt nach einem Jahr
 wenn ein Foto nicht korrent erkannt wurde: DB-Eintrag wird entfernt
 HALL OF FAME: Liste der 10 besten Lehrkräfte (es zählen nur erkannte SuS, die noch an der Schule sind)
 */

function resetQuiz() {

}

window.addEventListener('load', function() {
    email_for_foto_paths_rev = {};
    for (let path in email_for_foto_paths) {
        let email = email_for_foto_paths[path];
        email_for_foto_paths_rev[email] = path;
    }
    $('#password').focus();
    $('#submit_password').on('click', function(e) {
        e.preventDefault();
        passphrase = $('#password').val().trim();
        $('#form').hide();
        $('#stage').show();
        $('#klassen-div').show();
        refresh();
    });
    if (FOTO_PASSWORD !== null) {
        $('#password').val(FOTO_PASSWORD);
        $('#submit_password').click();
    }
    for (let klasse of KLASSEN_ORDER) {
        if (klasse === '11') klasse = 'OS';
        if (klasse === '12') continue;
        let bu_klasse = $(`<button class='btn btn-sm ttc' style='margin: 0.2em;'>`).text(KLASSEN_TR[klasse] ?? klasse).data('klasse', klasse);
        bu_klasse.on('click', function(e) {
            $('.ttc').removeClass('active');
            $(e.target).closest('.ttc').addClass('active');
            current_klasse = $(e.target).closest('button').data('klasse');
            console.log(`refreshing ${klasse}!`);
            refresh();
        });
        $('#klassen-div').append(bu_klasse);
    }
    let bu_quiz = $(`<button class='btn btn-sm ttc' style='margin: 0.2em; width: 5em;'>`).html(`<i style='display: inline-block; margin: 0 0.2em 0 0.5em;' class='fa fa-play'></i>&nbsp;&nbsp;Quiz!`).data('quiz', 'yeah');
        bu_quiz.on('click', function(e) {
        resetQuiz();
        $('#quiz-curtain').fadeIn();
    });
    // $('#klassen-div').append(bu_quiz);
    function refresh_autocomplete() {
        $('#current_names').empty();
        email_for_name = {};
        for (let email of schueler_for_klasse[current_klasse] ?? schueler_for_klasse['11'].concat(schueler_for_klasse['12'])) {
            let name = `${user_info[email].display_first_name} ${user_info[email].last_name}`;
            email_for_name[name] = email;
            if (!(email in email_for_foto_paths_rev)) {
                $('#current_names').append($(`<option value='${name}'>`));
            }
        }
    }
    function refresh() {
        let url = `/api/fotos/2023-${current_klasse}-0.json`;
        console.log(url);
        $('#sus_here').empty();
        refresh_autocomplete();
        api_call(`/api/get_fotos/${current_klasse}`, {}, function(data) {
            if (data.success) {
                for (let path of data.paths) {
                    let url = `/api/fotos/${path}`;
                    $.get(url, function(data) {
                        decryptData(data, passphrase).then(function(decrypted) {
                            let frame = $(`<div class='sus-frame'>`);
                            let photo = $('<img class="sus-foto-sm">').attr('src', 'data:image/jpeg;base64,' + decrypted);
                            let div = $(`<div style='display: inline-block;'>`);
                            div.append(frame);
                            frame.append(photo);
                            let label = $(`<div class='sus-label'>`).text('(kein Name zugeordnet)').addClass('nodata');
                            if (path in email_for_foto_paths) {
                                let email = email_for_foto_paths[path];
                                let name = `${user_info[email].display_first_name} ${user_info[email].last_name}`;
                                label.text(name).removeClass('nodata');
                            }
                            frame.append(label);
                            let ti_name = $(`<input class='sus-edit' type='text' list='current_names' class='form-control' style='text-align: center;' placeholder='Bitte geben Sie einen Namen ein'>`);
                            frame.append(ti_name);
                            $('#sus_here').append(div);
                            ti_name.hide();
                            ti_name.on('keydown', function(e) {
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    $(e.target).trigger('change');
                                }
                            });
                            ti_name.on('change', function(e) {
                                let name = $(e.target).val().trim();
                                let email = email_for_name[name] ?? '';
                                api_call('/api/assign_name_to_foto', {email: email, path: path}, function(data) {
                                    if (data.success) {
                                        let frame = $(e.target).closest('.sus-frame');
                                        let label = frame.find('.sus-label');
                                        let ti_name = frame.find('.sus-edit');
                                        ti_name.hide();
                                        label.show();
                                        if (email.length === 0) {
                                            delete email_for_foto_paths[path];
                                            email_for_foto_paths_emails = Object.values(email_for_foto_paths);
                                            email_for_foto_paths_rev = {};
                                            for (let path in email_for_foto_paths) {
                                                let email = email_for_foto_paths[path];
                                                email_for_foto_paths_rev[email] = path;
                                            }
                                            label.text('(kein Name zugeordnet)').addClass('nodata');
                                        } else {
                                            email_for_foto_paths[path] = email;
                                            email_for_foto_paths_emails = Object.values(email_for_foto_paths);
                                            email_for_foto_paths_rev = {};
                                            for (let path in email_for_foto_paths) {
                                                let email = email_for_foto_paths[path];
                                                email_for_foto_paths_rev[email] = path;
                                            }
                                            label.text(name).removeClass('nodata');
                                        }
                                        refresh_autocomplete();
                                    }
                                });
                            });
                            ti_name.on('blur', function(e) {
                                let frame = $(e.target).closest('.sus-frame');
                                let label = frame.find('.sus-label');
                                let ti_name = frame.find('.sus-edit');
                                ti_name.hide();
                                label.show();
                            });
                            label.on('click', function(e) {
                                let frame = $(e.target).closest('.sus-frame');
                                let label = frame.find('.sus-label');
                                let ti_name = frame.find('.sus-edit');
                                label.hide();
                                ti_name.show().focus();
                            });
                        }).catch(err => console.error(err));
                    });
                }
            }
        });
    }
});
</script>
