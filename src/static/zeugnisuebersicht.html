#{this_is_a_page_for_logged_in_zeugnis_admins}
#{File.read('/static/_tresor_public_template.html')}
<div class='container bg-white'>
    <div class="w-full">
        <h3>Zeugnis√ºbersicht #{ZEUGNIS_SCHULJAHR.sub('_', '/')} (#{ZEUGNIS_HALBJAHR}. Halbjahr)</h3>
        <div id="zeugnisuebersicht-here"></div>
    </div>
</div>

<style>
    #zeugnisuebersicht-here th, #zeugnisuebersicht-here td {
        text-align: center;
        width: 1cm;
    }
    #zeugnisuebersicht-here td .ramp {
        color: #fff;
        padding: 0.2em 0.4em;
        border-radius: 4px;
    }
</style>

<script>
var ZEUGNIS_SCHULJAHR = "#{ZEUGNIS_SCHULJAHR}";
var ZEUGNIS_HALBJAHR = "#{ZEUGNIS_HALBJAHR}";
var zeugnis_klassen_order = #{ZEUGNIS_KLASSEN_ORDER.to_json};
var klassen_tr = #{KLASSEN_TR.to_json};
var zeugnisliste_for_klasse = #{@@zeugnisliste_for_klasse.to_json};

window.addEventListener('load', function () {

    let fach_order = [];
    for (let klasse of zeugnis_klassen_order) {
        for (let fach of zeugnisliste_for_klasse[klasse].faecher) {
            if (fach_order.indexOf(fach) < 0)
                fach_order.push(fach);
        }
    }
    let path_arrays = [];
    for (let klasse of zeugnis_klassen_order) {
        let liste = zeugnisliste_for_klasse[klasse];
        let faecher = liste.faecher;
        let emails = liste.schueler.map(function(x) { return x.email; });
        {
            // add zeugnisnoten
            let path_array = [];
            path_array.push(['Schuljahr', ZEUGNIS_SCHULJAHR]);
            path_array.push(['Halbjahr', ZEUGNIS_HALBJAHR]);
            path_array.push(['Fach', faecher.concat([])]);
            path_array.push(['Email', emails]);
            path_arrays.push(path_array);
        }

        {
            // add sozialnoten
            let path_array = [];
            path_array.push(['Schuljahr', ZEUGNIS_SCHULJAHR]);
            path_array.push(['Halbjahr', ZEUGNIS_HALBJAHR]);
            let items = ['ZV', 'LLB', 'SSK', 'KF', 'SV'];
            path_array.push(['SV', items]);
            path_array.push(['Fach', faecher.concat(['_KL'])]);
            path_array.push(['Email', emails]);
            path_arrays.push(path_array);
        }
    }
    let div = $('#zeugnisuebersicht-here');
    // for (let x = 0; x <= 1.0; x += 0.1) {
    //     let span = $(`<span style='display: inline-block; width: 2em; height: 2em; border-radius: 50%; background-color: ${red_green_ramp(x)}; color: white; text-align: center; padding-top: 0.2em; margin-right: 0.5em;'>`).text(`${x.toFixed(1)}`);
    //     span.appendTo(div);
    // }
    // return;
    console.log(path_arrays);
    tresor_api_call('/jwt/get_many_present', {path_arrays: path_arrays, key: 'Wert'}, function(data) {
        // console.log(data);
        let counts = {};
        for (let klassen_index = 0; klassen_index < zeugnis_klassen_order.length; klassen_index++) {
            let klasse = zeugnis_klassen_order[klassen_index];
            let liste = zeugnisliste_for_klasse[klasse];
            let faecher = liste.faecher;
            for (let fach_index = 0; fach_index < faecher.length; fach_index++) {
                let fach = faecher[fach_index];
                let present_count = 0;
                let total_count = 0;
                for (let sus_index = 0; sus_index < liste.schueler.length; sus_index++) {
                    let email = liste.schueler[sus_index];
                    total_count++;
                    if (data.results[klassen_index * 2 + 0][0][0][fach_index][sus_index])
                        present_count++;
                }
                counts[`${klasse}/${fach}`] ??= [0, 0];
                counts[`${klasse}/${fach}`][0] += present_count;
                counts[`${klasse}/${fach}`][1] += total_count;
            }
            let faecher_and_kl = faecher.concat(['_KL']);
            for (let fach_index = 0; fach_index < faecher_and_kl.length; fach_index++) {
                let fach = faecher_and_kl[fach_index];
                for (let item_index = 0; item_index < 5; item_index++) {
                    let present_count = 0;
                    let total_count = 0;
                    for (let sus_index = 0; sus_index < liste.schueler.length; sus_index++) {
                        let email = liste.schueler[sus_index];
                        total_count++;
                        if (data.results[klassen_index * 2 + 1][0][0][item_index][fach_index][sus_index])
                            present_count++;
                    }
                    counts[`${klasse}/${fach}/SV`] ??= [0, 0];
                    counts[`${klasse}/${fach}/SV`][0] += present_count;
                    counts[`${klasse}/${fach}/SV`][1] += total_count;
                }
            }

            // console.log(counts);

            div.append($(`<h4>`).text(`Klasse ${klassen_tr[klasse] ?? klasse}`));
            let table = $(`<table class='table xs' style='width: unset;'>`);
            div.append(table);
            let row = $('<tr>').appendTo(table);
            row.append($(`<th>`));
            for (let fach_index = 0; fach_index < faecher.length; fach_index++) {
                let fach = faecher[fach_index];
                row.append($(`<th>`).text(fach));
            }
            row.append($(`<th>`).text('KL'));
            row = $('<tr>').appendTo(table);
            row.append($(`<th>`).text('Zeugnisnoten').css('text-align', 'left'));
            for (let fach_index = 0; fach_index < faecher.length; fach_index++) {
                let fach = faecher[fach_index];
                let present_count = counts[`${klasse}/${fach}`][0];
                let total_count = counts[`${klasse}/${fach}`][1];
                // if (present_count === 0)
                //     row.append($(`<td>`).append($(`<span>`).html(`<i class='fa fa-times'></i>`).css('color', '#888')));
                // else 
                if (present_count === total_count)
                    row.append($(`<td>`).append($(`<span>`).html(`<i class='fa fa-check-circle'></i>`).css('color', '#4aa03f')));
                else
                    row.append($(`<td>`).append($(`<span>`).text(`${present_count}/${total_count}`).css('background-color', red_green_ramp(present_count / total_count)).addClass('ramp')));
            }
            row.append($(`<td>`).html('&ndash;'));
            row = $('<tr>').appendTo(table);
            row.append($(`<th>`).text('Sozialverhalten').css('text-align', 'left'));

            for (let fach of faecher.concat(['_KL'])) {
                let present_count = counts[`${klasse}/${fach}/SV`][0];
                let total_count = counts[`${klasse}/${fach}/SV`][1];
                // if (present_count === 0)
                    // row.append($(`<td>`).append($(`<span>`).html(`<i class='fa fa-times'></i>`).css('color', '#888')));
                // else 
                if (present_count === total_count)
                    row.append($(`<td>`).append($(`<span>`).html(`<i class='fa fa-check-circle'></i>`).css('color', '#4aa03f')));
                else
                   row.append($(`<td>`).append($(`<span>`).text(`${present_count}/${total_count}`).css('background-color', red_green_ramp(present_count / total_count)).addClass('ramp')));
            }
        }
    });
    return;

});
</script>