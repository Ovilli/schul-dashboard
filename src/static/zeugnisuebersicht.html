#{this_is_a_page_for_logged_in_zeugnis_admins}
#{File.read('/static/_tresor_public_template.html')}
<div class='container bg-white'>
    <div class="w-full">
        <h3>Zeugnis√ºbersicht #{ZEUGNIS_SCHULJAHR.sub('_', '/')} (#{ZEUGNIS_HALBJAHR}. Halbjahr)</h3>
        <div id="zeugnisuebersicht-here"></div>
    </div>
</div>

<style>
    #zeugnisuebersicht-here th, #zeugnisuebersicht-here td {
        text-align: center;
        width: 1cm;
    }
    #zeugnisuebersicht-here td .dot {
        color: white;
        display: inline-block;
        width: 2em;
        height: 2em;
        border-radius: 50%;
        padding-top: 0.2em;

    }
</style>

<script>
var ZEUGNIS_SCHULJAHR = "#{ZEUGNIS_SCHULJAHR}";
var ZEUGNIS_HALBJAHR = "#{ZEUGNIS_HALBJAHR}";
var zeugnis_klassen_order = #{ZEUGNIS_KLASSEN_ORDER.to_json};
var klassen_tr = #{KLASSEN_TR.to_json};
var zeugnisliste_for_klasse = #{@@zeugnisliste_for_klasse.to_json};

window.addEventListener('load', function () {

    let fach_order = [];
    for (let klasse of zeugnis_klassen_order) {
        for (let fach of zeugnisliste_for_klasse[klasse].faecher) {
            if (fach_order.indexOf(fach) < 0)
                fach_order.push(fach);
        }
    }
    let path_arrays = [];
    for (let klasse of zeugnis_klassen_order) {
        let path_array = [];
        path_array.push(['Schuljahr', ZEUGNIS_SCHULJAHR]);
        path_array.push(['Halbjahr', ZEUGNIS_HALBJAHR]);
        let liste = zeugnisliste_for_klasse[klasse];
        let faecher = liste.faecher;
        let faecher_for_paths = [];
        for (let fach of faecher) {
            faecher_for_paths.push(fach);
            // if (FAECHER_SPRACHEN.indexOf(fach) >= 0) {
            //     faecher_for_paths.push(`${fach}_AT`);
            //     faecher_for_paths.push(`${fach}_SL`);
            // }
        }
        let emails = liste.schueler.map(function(x) { return x.email; });
        path_array.push(['Fach', faecher_for_paths]);
        path_array.push(['Email', emails]);
        path_arrays.push(path_array);
    }
    let div = $('#zeugnisuebersicht-here');
    // for (let x = 0; x <= 1.0; x += 0.1) {
    //     let span = $(`<span style='display: inline-block; width: 2em; height: 2em; border-radius: 50%; background-color: ${red_green_ramp(x)}; color: white; text-align: center; padding-top: 0.2em; margin-right: 0.5em;'>`).text(`${x.toFixed(1)}`);
    //     span.appendTo(div);
    // }
    // return;
    tresor_api_call('/jwt/get_many_present', {path_arrays: path_arrays, key: 'Wert'}, function(data) {
        // console.log(data);
        for (let klassen_index = 0; klassen_index < zeugnis_klassen_order.length; klassen_index++) {
            let klasse = zeugnis_klassen_order[klassen_index];
            div.append($(`<h4>`).text(`Klasse ${klassen_tr[klasse] ?? klasse}`));
            let table = $(`<table class='table xs' style='width: unset;'>`);
            div.append(table);
            let liste = zeugnisliste_for_klasse[klasse];
            let faecher = liste.faecher;
            let row = $('<tr>').appendTo(table);
            row.append($(`<th>`));
            for (let fach_index = 0; fach_index < faecher.length; fach_index++) {
                let fach = faecher[fach_index];
                row.append($(`<th>`).text(fach));
            }
            row = $('<tr>').appendTo(table);
            row.append($(`<th>`).text('Zeugnisnoten'));
            for (let fach_index = 0; fach_index < faecher.length; fach_index++) {
                let fach = faecher[fach_index];
                let present = [];
                let absent = [];
                for (let sus_index = 0; sus_index < liste.schueler.length; sus_index++) {
                    let email = liste.schueler[sus_index];
                    if (data.results[klassen_index][0][0][fach_index][sus_index])
                        present.push(email);
                    else
                        absent.push(email);
                }
                let present_count = present.length;
                let total_count = present.length + absent.length;
                let p = 0.0;
                if (total_count > 0)
                    p = present_count / total_count;
                row.append($(`<td>`).append($(`<span class='dot'>`).text(`${present.length}`).css('background-color', lerpColor(red_green_ramp(p), '#ffffff', 0.7)).css('color', lerpColor(red_green_ramp(p), '#000000', 0.8))));
            }
        }
    });
    return;

});
</script>