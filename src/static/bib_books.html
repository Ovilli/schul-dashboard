#{File.read('/static/_bib_public_template.html')}
#{require_user_who_can_manage_bib!}
<div class='container bg-white' style="padding-top: 15px;">
    <h3>Medien</h3>
    <div id='book_table'></div>
</div>
<script>
    function row_clicked(data) {
        window.location = `/bib_book/${data}`;
    }

    window.addEventListener('load', function () {
        bib_api_call('/jwt/get_books', {}, function (data) {
            if (data.success) {
                console.log(data);
                let div = $('<div>').appendTo($('#book_table'));
                new SortableTable({
                    element: div,
                    headers: ['Signaturstamm', 'Titel', 'Autor', 'Vorrätig', 'Ausgeliehen'].map(function (x) {
                        let th = $('<th>').text(x);
                        if (['Signaturstamm', 'Vorrätig', 'Ausgeliehen'].indexOf(x) >= 0) th.data('type', 'int');
                        return th;
                    }),
                    rows: data.books.map(function (entry) {
                        return [
                            entry.stem,
                            $('<td>').text(`${entry.stem}`).data('sort_value', entry.stem),
                            $('<td>').css('max-width', '300px').text(entry.title),
                            $('<td>').css('max-width', '200px').text(entry.author),
                            $('<td>').text(`${entry.stock_count || 0}`).data('sort_value', entry.stock_count || 0),
                            $('<td>').text(`${entry.ausleih_count || 0}`).data('sort_value', entry.ausleih_count || 0),
                        ];
                    }),
                    clickable_rows: true,
                    clickable_row_callback: row_clicked
                });
                // for (let row of data.exemplare) {
                //     let div = create_book_div(row.book, null, {
                //         exemplar: row.exemplar, clickable: true, callback: function (book) {
                //             window.location.href = `/bib_book/${book.stem}`;
                //         }
                //     }).data('book', row.book);
                //     $('#book_list').append(div);
                // }
            }
        });
    });
</script>