#{File.read('/static/_bib_public_template.html')}
<style>
    #book_subtitle,
    #book_verlag_jahr_seiten_preis {
        font-style: italic;
    }

    #book_details h5 {
        margin: 0;
    }

    #book_details {
        margin-bottom: 1em;
    }
</style>
<div class='container bg-white' style="padding-top: 15px;">
    <div id='book_here'>
        <div id='book_cover_container' class='pull-left mr-3 mb-3 bg-stone-800 shadow shadow-md' style="width: 250px;">
            <img id='book_cover' class=' text-center italic text-sm' style='width: 100%;' />
        </div>
        <div id='labels_here' class='pull-right'>
        </div>
        <h3 id='book_title'></h3>
        <h4 id='book_subtitle'></h4>
        <h5 id='book_author'></h5>
        <div id='book_details'></div>
        <p id='book_description'></p>
    </div>
    <div style="clear: both"></div>
    <div id='hint_scan_isbn' class='alert alert-warning relative' style="display: none; min-height: 70px;">
        <div style="float: left; font-size: 200%; margin-right: 0.5em;">üôÇ</div>
        <div style="padding-top: 10px;">Dieses Buch hat noch keine ISBN. Hilf uns, die Bibliothek zu verbessern, indem
            du die ISBN scannst.</div>
        <div style="text-align: center; margin-top: 10px;">
            <a id='hint_scan_isbn_link' class="btn btn-success" href="#"><i class='fa fa-barcode'></i>&nbsp;&nbsp;ISBN
                erfassen</a>
        </div>
    </div>
    <div id='hint_scan_isbn_thank_you' class='alert alert-warning relative' style="display: none; min-height: 70px;">
        <div style="float: left; font-size: 200%; margin-right: 0.5em;">ü§©</div>
        <div style="padding-top: 10px;">Danke, dass du uns die fehlende ISBN f√ºr dieses Buch √ºbermittelt hast! Wir
            k√ºmmern uns darum.</div>
    </div>
    <div id='checked_out_user'></div>
    <div class="bib_teacher_only">
        <hr />
        <div id='orders_placed_notice' class='alert alert-warning' style="display: none;">
            Du hast <span id='orders_placed_count'></span> dieses Buchs <a href='/bib_orders'>bestellt</a>.
        </div>
        <p>Wenn du dieses Buch im Unterricht verwenden m√∂chtest, kannst du es hier bestellen.</p>
        <button id='bu_order_overview' class="btn btn-success"><i class='fa fa-shopping-basket'></i>&nbsp;&nbsp;Buch
            bestellen</button>
        <div id="order_div" style='display: none; margin-top: 15px;'>
            <button id='bu_order_kurs' class='btn btn-outline-secondary mr-1'>
                <i class='fa fa-group'></i>&nbsp;&nbsp;Ich m√∂chte das Buch f√ºr eine Klasse oder einen Kurs bestellen.
            </button>
            <button id='bu_order_private' class='btn btn-outline-secondary mr-1'>
                <i class='fa fa-user'></i>&nbsp;&nbsp;Ich m√∂chte das Buch f√ºr mich bestellen.
            </button>
            <div id="order_kurs_div" style='display: none; margin-top: 15px;'>
                <div class='row'>
                    <div class='col-md-6'>
                        <div id="kurs_list_div"></div>
                    </div>
                    <div class='col-md-6' id="order_kurs_div_confirm" style="display: none;">
                        <div>
                            <table id='order_kurs_div_table' class='xs table table-sm table-condensed narrow'></table>
                        </div>
                        Ich m√∂chte <span class='font-bold' id="label_order_kurs_count"></span> f√ºr meinen Kurs <span class='font-bold' id="label_kurs_name"></span> bestellen.
                        <div class='mt-3' style='text-align: right;'>
                            <button id='bu_place_order_kurs' class='btn btn-success' style="display: none;"><i class='fa fa-send'></i>&nbsp;&nbsp;Bestellung aufgeben</button>
                        </div>
                        <div id='bu_place_order_kurs_success' class='alert alert-success' style='display: none; margin-top: 15px;'>Deine Bestellung wurde aufgenommen. Du kannst den Status deiner Bestellung unter <a href='/bib_orders'>¬ªBestellungen¬´</a> einsehen.</div>
                    </div>
                </div>
            </div>
            <div id="order_private_div" style='display: none; margin-top: 15px;'>
                Ich m√∂chte <input id='ti_order_private_count' class='form-control' type='number' min='1' max='100' value='1' style='display: inline-block; width: 50px; text-align: center; margin: 0 10px;' /> Exemplar<span id='private_order_exemplare_suffix'></span> f√ºr mich bestellen.
                <div class='mt-3'>
                    <button id='bu_place_order_private' class='btn btn-success'><i class='fa fa-send'></i>&nbsp;&nbsp;Bestellung aufgeben</button>
                    <div id='bu_place_order_private_success' class='alert alert-success' style='display: none; margin-top: 15px;'>Deine Bestellung wurde aufgenommen. Du kannst den Status deiner Bestellung unter <a href='/bib_orders'>¬ªBestellungen¬´</a> einsehen.</div>
                </div>
            </div>
            <hr />
        </div>
    </div>
    <div class="bib_management_only">
        <div id='stock_overview'></div>
        <div id='checked_out_all'></div>
        <div id='in_stock_all'></div>
    </div>
</div>
<script>

    var kurse = #{ Hash[(@@lessons_for_shorthand[@session_user[:shorthand]] || []).map do | x |
        y = @@lessons[:lesson_keys][x]
        [x, {:fach => y[:pretty_folder_name] || x, :sus => (@@schueler_for_lesson[x] || [])}]
    end].to_json};
    var lehrmittelverein_state_cache = #{@@lehrmittelverein_state_cache.to_json};
    var book_response = null;
    var clicked_lesson_key = null;
    var stem = null;

    function row_clicked(data) {
        window.location = `/bib_user/${encodeURIComponent(data)}`;
    }

    function kurs_row_clicked(lesson_key) {
        clicked_lesson_key = lesson_key;
        let details = calculate_kurs_order_list(lesson_key, stem);
        $('#label_kurs_name').text(kurse[lesson_key].fach);
        $('#order_kurs_div_table').empty();
        $('<tr>').append($(`<td>`).text('Sch√ºler:innen, die den Kurs besuchen')).append($(`<td>`).css('text-align', 'right').text(`${kurse[lesson_key].sus.length}`)).appendTo($('#order_kurs_div_table'));
        if (details.already_have_book_sus.length > 0) {
            $('<tr>').append($(`<td>`).css('white-space', 'unset').html(`Sch√ºler:innen, die dieses Buch bereits haben<br /><em>${details.already_have_book_sus.map(function(email) {return (db_user_info[email] || {}).display_name || email; }).join(', ')}</em>`)).append($(`<td>`).css('text-align', 'right').text(`-${details.already_have_book_sus.length}`)).appendTo($('#order_kurs_div_table'));
        }
        if (details.no_verein_sus.length > 0) {
            $('<tr>').append($(`<td>`).css('white-space', 'unset').html(`Sch√ºler:innen, die nicht im Lehrmittelverein sind<br /><em>${details.no_verein_sus.map(function(email) {return (db_user_info[email] || {}).display_name || email; }).join(', ')}</em>`)).append($(`<td>`).css('text-align', 'right').text(`-${details.no_verein_sus.length}`)).appendTo($('#order_kurs_div_table'));
        }
        if (details.teacher_has_this_book)
            $('<tr>').append($(`<td>`).text('Exemplar f√ºr mich (bereits vorhanden)')).append($(`<td>`).css('text-align', 'right').html(`+0`)).appendTo($('#order_kurs_div_table'));
        else {
            $('<tr>').append($(`<td>`).text('Exemplar f√ºr mich')).append($(`<td>`).css('text-align', 'right').text(`+1`)).appendTo($('#order_kurs_div_table'));
        }
        let total_count = Object.keys(details.list).length;
        $('<tr>').append($(`<th>`).text('Gesamt')).append($(`<th>`).css('text-align', 'right').text(`${total_count}`)).appendTo($('#order_kurs_div_table'));
        $('#bu_place_order_kurs').show();
        $('#bu_place_order_kurs').prop('disabled', total_count <= 0);

        $('#order_kurs_div_confirm').slideDown();
        $('#label_order_kurs_count').text(`${total_count} Exemplar${total_count === 1 ? '' : 'e'}`);
    }

    window.addEventListener('load', function () {
        $('#bu_order_overview').click(function (e) {
            $('#bu_order_overview').prop('disabled', true);
            $('#order_div').slideDown();
        });
        $('#bu_order_kurs').click(function(e) {
            $('#bu_order_kurs').removeClass('btn-outline-secondary').addClass('btn-success');
            $('#bu_order_private').addClass('btn-outline-secondary').removeClass('btn-success');
            $('#order_kurs_div').slideDown();
            $('#order_private_div').slideUp();
        });
        $('#bu_order_private').click(function(e) {
            $('#bu_order_private').removeClass('btn-outline-secondary').addClass('btn-success');
            $('#bu_order_kurs').addClass('btn-outline-secondary').removeClass('btn-success');
            $('#order_private_div').slideDown();
            $('#order_kurs_div').slideUp();
        });
        $('#ti_order_private_count').keyup(function(e) {
            let count = parseInt($('#ti_order_private_count').val());
            $('#private_order_exemplare_suffix').text(count === 1 ? '' : 'e');
        });
        $('#bu_place_order_private').click(function(e) {
            let count = parseInt($('#ti_order_private_count').val());
            bib_api_call('/jwt/place_order_private', { stem: stem, count: count }, function (data) {
                if (data.success) {
                    $('#bu_place_order_private').prop('disabled', true);
                    $('#bu_place_order_private_success').slideDown();
                }
            });
        });
        $('#bu_place_order_kurs').click(function(e) {
            bib_api_call('/jwt/place_order_kurs', { stem: stem, lesson_key: clicked_lesson_key }, function (data) {
                if (data.success) {
                    $('#bu_place_order_kurs').prop('disabled', true);
                    $('#bu_place_order_kurs_success').slideDown();
                }
            });
        });
        let stem_s = window.location.pathname.replace('/bib_book/', '');
        stem = parseInt(stem_s);
        if ('#{can_manage_bib_logged_in?}' === 'true') {
            $(`<li class='mx-1 py-1 px-1.5' style='white-space: nowrap;'><i class='fa fa-barcode'></i>&nbsp;&nbsp;${stem}</li>`).insertBefore($('#sub_menu_extra'));
            $(`<li class='mx-1'><a class='inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3' href='/bib_book_edit/${stem}'><i class='fa fa-pencil'></i>&nbsp;&nbsp;Metadaten bearbeiten</a></li>`).insertAfter($('#sub_menu_extra'));
            $(`<li class='mx-1'><a class='inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3' href='#'><i class='fa fa-print'></i>&nbsp;&nbsp;Label drucken</a></li>`).insertAfter($('#sub_menu_extra'));
            $('#subsubmenu').show();
        }

        bib_api_call('/jwt/get_book', { stem: stem }, function (data) {
            if (data.success) {
                book_response = data;
                book_response.ordering_teacher_email = "#{@session_user[:email]}";
                book_response.ordering_teacher_has_this_book = book_response.logged_in_teacher_has_this_book;
                console.log(data);
                let book = data.book;
                $('#book_title').text(book.title);
                $('#book_subtitle').text(book.subtitle);
                $('#book_author').text(book.author);
                let parts = [];
                if (book.verlag) parts.push(book.verlag)
                if (book.published) parts.push(`${book.published}`)
                if (parts.length > 0)
                    $('#book_details').append($('<h5>').text(parts.join(', ')));
                parts = [];
                if (book.page_count) parts.push(`${book.page_count} Seiten`)
                if (parts.length > 0)
                    $('#book_details').append($('<h5>').text(parts.join(', ')));
                parts = [];
                if (book.isbn) parts.push(`ISBN: ${book.isbn}`);
                if (parts.length > 0)
                    $('#book_details').append($('<h5>').text(parts.join(', ')));
                parts = [];
                if (book.waehrung && book.preis) parts.push(`Preis: ${currency_string(book.preis, book.waehrung)}`);
                if (parts.length > 0)
                    $('#book_details').append($('<h5>').text(parts.join(', ')));
                $('#book_description').text(book.description);
                let cover = $('#book_cover');
                if (book.has_cover) {
                    cover.attr('src', `${BIB_HOST}/gen/covers/${book.stem}-400.jpg`);
                } else {
                    $('#book_cover_container').hide();
                }
                if (data.labels) {
                    for (let label of data.labels) {
                        $('#labels_here').append($(`<span class='bg-stone-500 text-gray-800 text-sm mr-2 px-2.5 py-0.5 rounded dark:bg-gray-700 dark:text-gray-300'>${label.value}</span>`));
                    }
                }
                if (data.locations) {
                    for (let location of data.locations) {
                        $('#labels_here').append($(create_location_span(location)));
                    }
                }
                if (data.checked_out_user.length > 0) {
                    if ((book.isbn || '').length === 0) {
                        if (data.proposed_isbn.length > 0) {
                            $('#hint_scan_isbn_thank_you').show();
                        } else {
                            $('#hint_scan_isbn_link').attr('href', `/bib_scan_isbn/${book.stem}`);
                            $('#hint_scan_isbn').show();
                        }
                    }
                    let x = ['keine', 'ein', 'zwei', 'drei', 'vier', 'f√ºnf'];
                    let div = $("<div>").text(`Du hast ${x[data.checked_out_user.length] || data.checked_out_user.length} Exemplar${data.checked_out_user.length === 1 ? '' : 'e'} dieses Buchs ausgeliehen.`);
                    $('#checked_out_user').append(div);
                    let table_div = $(`<div class="table-responsive" style="max-width: 100%; overflow-x: auto;">`);
                    let table = $("<table class='table table-sm mt-3 table-condensed narrow'>");
                    table.append($("<tr><th>Signatur</th><th>Ausgeliehen</th><th>Best√§tigt</th></tr>"));
                    table_div.append(table);
                    div.append(table_div);
                    for (let entry of data.checked_out_user) {
                        let row = $('<tr>');
                        row.append($('<td>').text(`${book.stem}-${entry.e.bnr}`));
                        row.append($('<td>').text(`${moment.unix(entry.r.ts_checked_out).format('L')}`));
                        if (entry.r.ts_confirmed) {
                            row.append($('<td>').text(moment.unix(entry.r.ts_confirmed).format('L')));
                        } else {
                            row.append($('<td>').html("<i class='text-stone-400 fa fa-exclamation-triangle'></i>&nbsp;&nbsp;(noch nicht best√§tigt) <a class='btn btn-success btn-xs ml-3' href='/bib_confirm'>Jetzt best√§tigen</a>"));
                        }
                        table.append(row);
                    }
                }
                // if (data.checked_out_all && data.in_stock_all) {
                //     let div = $("<div>");
                //     $('#stock_overview').append($(`<h3>Bestand</h3>`));
                //     $('#stock_overview').append(div);
                //     div.append(`Best√§tigte Exemplare: `);
                //     div.append(`davon ausgeliehen: `);
                //     div.append(`davon vorr√§tig: `);
                // }
                if (data.checked_out_all) {
                    let div = $("<div>");
                    $('#checked_out_all').append($(`<h3>Ausgeliehene Exemplare</h3>`));
                    $('#checked_out_all').append(div);
                    if (data.checked_out_all.length > 0) {
                        new SortableTable({
                            element: div,
                            xs: true,
                            headers: ['Signatur', 'Nachname', 'Vorname', 'Klasse', 'Ausleihdatum', 'Best√§tigt'].map(function (x) {
                                let th = $('<th>').text(x);
                                if (['Signatur', 'Klasse', 'Ausleihdatum', 'Best√§tigt'].indexOf(x) >= 0) th.data('type', 'int');
                                return th;
                            }),
                            rows: data.checked_out_all.map(function (entry) {
                                return [
                                    // entry.e.bnr,
                                    entry.u.email,
                                    $('<td>').text(`${book.stem}-${entry.e.bnr}`).data('sort_value', entry.e.bnr),
                                    create_user_td_span(entry.u.email),
                                    $('<td>').html((db_user_info[entry.u.email] || {}).klasse || '&ndash;').data('sort_value', (db_user_info[entry.u.email] || {}).klassen_order),
                                    $('<td>').text(`${moment.unix(entry.r.ts_checked_out).format('L')}`).data('sort_value', entry.r.ts_checked_out),
                                    entry.r.ts_confirmed
                                        ? $('<td>').text(moment.unix(entry.r.ts_confirmed).format('L')).data('sort_value', entry.r.ts_confirmed)
                                        : $('<td>').html("<i class='text-stone-400 fa fa-exclamation-triangle'></i>&nbsp;&nbsp;(noch nicht best√§tigt)").data('sort_value', NaN)
                                ];
                            }),
                            clickable_rows: true,
                            clickable_row_callback: row_clicked
                        });
                    } else {
                        div.append($(`<div class='alert alert-warning'>keine Exemplare ausgeliehen</div>`));
                    }
                }
                if (data.in_stock_all) {
                    let div = $("<div>");
                    $('#in_stock_all').append($(`<h3>Vorr√§tige Exemplare</h3>`));
                    $('#in_stock_all').append(div);
                    $('#in_stock_all').append($(`<p class='text-muted font-italic'>Es kann sein, dass mehr Exemplare im Regal liegen, als hier angegeben ist. In diesem Fall sind die Exemplare noch nicht gescannt worden, z. B. durch einen Labeldruck, eine Ausleihe oder eine R√ºckgabe.</p>`));
                    if (data.in_stock_all.length > 0) {
                        new SortableTable({
                            element: div,
                            xs: true,
                            headers: ['Signatur', 'Ausgemustert'].map(function (x) {
                                let th = $('<th>').text(x);
                                if (['Signatur', 'Ausgemustert'].indexOf(x) >= 0) th.data('type', 'int');
                                return th;
                            }),
                            rows: data.in_stock_all.map(function (entry) {
                                return [
                                    entry['e.bnr'],
                                    $('<td>').text(`${stem}-${entry['e.bnr']}`).data('sort_value', entry['e.bnr']),
                                    entry['e.ts_discarded']
                                        ? $('<td>').html(`<i class='text-stone-400 fa fa-trash'></i>&nbsp;&nbsp;${moment.unix(entry['e.ts_discarded']).format('L')}`).data('sort_value', entry['e.ts_discarded'])
                                        : $('<td>').html("&ndash;").data('sort_value', NaN)
                                ];
                            })
                        });
                    } else {
                        div.append($(`<div class='alert alert-warning'>keine Exemplare vorr√§tig</div>`));
                    }
                }
                let orders_placed_parts = [];
                if (data.orders_placed && data.orders_placed > 0) {
                    orders_placed_parts.push(`${data.orders_placed} Exemplar${data.orders_placed === 1 ? '' : 'e'} privat`);
                }
                if (data.kurs_orders_placed && data.kurs_orders_placed.length > 0) {
                    for (let lesson_key of data.kurs_orders_placed) {
                        if (kurse[lesson_key]) {
                            let count = calculate_kurs_order_count(lesson_key, stem);
                            orders_placed_parts.push(`${count} Exemplar${count === 1 ? '' : 'e'} f√ºr deinen Kurs ${kurse[lesson_key].fach}`);
                        }
                    }
                }
                if (orders_placed_parts.length > 0) {
                    $('#orders_placed_count').text(join_with_sep(orders_placed_parts, ', ', ' und '));
                    $('#orders_placed_notice').show();
                }
            }
        });
        if (Object.keys(kurse).length > 0) {
            new SortableTable({
                element: $('#kurs_list_div'),
                xs: true,
                headers: ['Kurs', 'Sch√ºler'].map(function (x) {
                    let th = $('<th>').text(x);
                    if (['Sch√ºler'].indexOf(x) >= 0) th.data('type', 'int');
                    return th;
                }),
                rows: Object.keys(kurse).map(function (lesson_key) {
                    let kurs = kurse[lesson_key];
                    return [
                        lesson_key,
                        $('<td>').text(kurs.fach),
                        $('<td>').text(`${kurs.sus.length}`).data('sort_value', kurs.sus.length),
                    ];
                }),
                clickable_rows: true,
                clickable_row_callback: kurs_row_clicked,
            });
        } else {
            $('#bu_order_kurs').prop('disabled', true);
        }
    });
</script>