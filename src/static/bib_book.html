#{File.read('/static/_bib_public_template.html')}
<style>
    #book_subtitle,
    #book_verlag_jahr_seiten_preis {
        font-style: italic;
    }

    #book_details h5 {
        margin: 0;
    }

    #book_details {
        margin-bottom: 1em;
    }
</style>
<div class='container bg-white' style="padding-top: 15px;">
    <div id='book_here'>
        <div id='book_cover_container' class='pull-left mr-3 mb-3 bg-stone-800 shadow shadow-md' style="width: 250px;">
            <img id='book_cover' class=' text-center italic text-sm' style='width: 100%;' />
        </div>
        <div id='labels_here' class='pull-right'>
        </div>
        <h3 id='book_title'></h3>
        <h4 id='book_subtitle'></h4>
        <h5 id='book_author'></h5>
        <div id='book_details'></div>
        <p id='book_description'></p>
    </div>
    <div style="clear: both"></div>
    <div id='hint_scan_isbn' class='alert alert-warning relative' style="display: none; min-height: 70px;">
        <div style="float: left; font-size: 200%; margin-right: 0.5em;">üôÇ</div>
        <div style="padding-top: 10px;">Dieses Buch hat noch keine ISBN. Hilf uns, die Bibliothek zu verbessern, indem
            du die ISBN scannst.</div>
        <div style="text-align: center; margin-top: 10px;">
            <a id='hint_scan_isbn_link' class="btn btn-success" href="#"><i class='fa fa-barcode'></i>&nbsp;&nbsp;ISBN
                erfassen</a>
        </div>
    </div>
    <div id='hint_scan_isbn_thank_you' class='alert alert-warning relative' style="display: none; min-height: 70px;">
        <div style="float: left; font-size: 200%; margin-right: 0.5em;">ü§©</div>
        <div style="padding-top: 10px;">Danke, dass du uns die fehlende ISBN f√ºr dieses Buch √ºbermittelt hast! Wir
            k√ºmmern uns darum.</div>
    </div>
    <div id='checked_out_user'></div>
    <div class="bib_teacher_only">
        <hr />
        <p>Wenn du dieses Buch im Unterricht verwenden m√∂chtest, kannst du es hier bestellen.</p>
        <button class="btn btn-success"><i class='fa fa-shopping-basket'></i>&nbsp;&nbsp;Buch bestellen</button>
    </div>
    <div class="bib_management_only">
        <div id='checked_out_all'></div>
    </div>
</div>
<script>
    window.addEventListener('load', function () {
        let stem_s = window.location.pathname.replace('/bib_book/', '');
        let stem = parseInt(stem_s);
        if ('#{can_manage_bib_logged_in?}' === 'true') {
            $(`<li class='mx-1 py-1 px-1.5' style='white-space: nowrap;'><i class='fa fa-barcode'></i>&nbsp;&nbsp;${stem}</li>`).insertBefore($('#sub_menu_extra'));
            $(`<li class='mx-1'><a class='inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3' href='/bib_book_edit/${stem}'><i class='fa fa-pencil'></i>&nbsp;&nbsp;Metadaten bearbeiten</a></li>`).insertAfter($('#sub_menu_extra'));
            $(`<li class='mx-1'><a class='inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3' href='#'><i class='fa fa-print'></i>&nbsp;&nbsp;Label drucken</a></li>`).insertAfter($('#sub_menu_extra'));
            $('#subsubmenu').show();
        }

        bib_api_call('/jwt/get_book', { stem: stem }, function (data) {
            if (data.success) {
                let book = data.book;
                console.log(data);
                $('#book_title').text(book.title);
                $('#book_subtitle').text(book.subtitle);
                $('#book_author').text(book.author);
                let parts = [];
                if (book.verlag) parts.push(book.verlag)
                if (book.published) parts.push(`${book.published}`)
                if (parts.length > 0)
                    $('#book_details').append($('<h5>').text(parts.join(', ')));
                parts = [];
                if (book.page_count) parts.push(`${book.page_count} Seiten`)
                if (parts.length > 0)
                    $('#book_details').append($('<h5>').text(parts.join(', ')));
                parts = [];
                if (book.isbn) parts.push(`ISBN: ${book.isbn}`);
                if (parts.length > 0)
                    $('#book_details').append($('<h5>').text(parts.join(', ')));
                parts = [];
                if (book.waehrung && book.preis) parts.push(`Preis: ${currency_string(book.preis, book.waehrung)}`);
                if (parts.length > 0)
                    $('#book_details').append($('<h5>').text(parts.join(', ')));
                $('#book_description').text(book.description);
                let cover = $('#book_cover');
                if (book.has_cover) {
                    cover.attr('src', `${BIB_HOST}/gen/covers/${book.stem}-400.jpg`);
                } else {
                    $('#book_cover_container').hide();
                }
                if (data.labels) {
                    for (let label of data.labels) {
                        $('#labels_here').append($(`<span class='bg-stone-500 text-gray-800 text-sm mr-2 px-2.5 py-0.5 rounded dark:bg-gray-700 dark:text-gray-300'>${label.value}</span>`));
                    }
                }
                if (data.checked_out_user.length > 0) {
                    if ((book.isbn || '').length === 0) {
                        if (data.proposed_isbn.length > 0) {
                            $('#hint_scan_isbn_thank_you').show();
                        } else {
                            $('#hint_scan_isbn_link').attr('href', `/bib_scan_isbn/${book.stem}`);
                            $('#hint_scan_isbn').show();
                        }
                    }
                    let x = ['keine', 'ein', 'zwei', 'drei', 'vier', 'f√ºnf'];
                    let div = $("<div>").text(`Du hast ${x[data.checked_out_user.length] || data.checked_out_user.length} Exemplar${data.checked_out_user.length === 1 ? '' : 'e'} dieses Buchs ausgeliehen.`);
                    $('#checked_out_user').append(div);
                    let table_div = $(`<div class="table-responsive" style="max-width: 100%; overflow-x: auto;">`);
                    let table = $("<table class='table table-sm mt-3 table-condensed narrow'>");
                    table.append($("<tr><th>Signatur</th><th>Ausgeliehen</th><th>Best√§tigt</th></tr>"));
                    table_div.append(table);
                    div.append(table_div);
                    for (let entry of data.checked_out_user) {
                        let row = $('<tr>');
                        row.append($('<td>').text(`${book.stem}-${entry.e.bnr}`));
                        row.append($('<td>').text(`${moment.unix(entry.r.ts_checked_out).format('L')}`));
                        if (entry.r.ts_confirmed) {
                            row.append($('<td>').text(moment.unix(entry.r.ts_confirmed).format('L')));
                        } else {
                            row.append($('<td>').html("<i class='text-stone-400 fa fa-exclamation-triangle'></i>&nbsp;&nbsp;(noch nicht best√§tigt) <a class='btn btn-success btn-xs ml-3' href='/bib_confirm'>Jetzt best√§tigen</a>"));
                        }
                        table.append(row);
                    }
                }
                if (data.checked_out_all && data.checked_out_all.length > 0) {
                    let div = $("<div>");
                    $('#checked_out_all').append($(`<h3>Ausgeliehene Exemplare</h3>`));
                    $('#checked_out_all').append(div);
                    new SortableTable({
                        element: div,
                        headers: ['Signatur', 'Nachname', 'Vorname', 'Klasse', 'Ausleihdatum', 'Best√§tigt'].map(function (x) {
                            let th = $('<th>').text(x);
                            if (['Signatur', 'Klasse', 'Ausleihdatum', 'Best√§tigt'].indexOf(x) >= 0) th.data('type', 'int');
                            return th;
                        }),
                        rows: data.checked_out_all.map(function (entry) {
                            return [
                                $('<td>').text(`${book.stem}-${entry.e.bnr}`).data('sort_value', entry.e.bnr),
                                create_user_td_span(entry.u.email),
                                $('<td>').html((db_user_info[entry.u.email] || {}).klasse || '&ndash;').data('sort_value', (db_user_info[entry.u.email] || {}).klassen_order),
                                $('<td>').text(`${moment.unix(entry.r.ts_checked_out).format('L')}`).data('sort_value', entry.r.ts_checked_out),
                                entry.r.ts_confirmed
                                    ? $('<td>').text(moment.unix(entry.r.ts_confirmed).format('L')).data('sort_value', entry.r.ts_confirmed)
                                    : $('<td>').html("<i class='text-stone-400 fa fa-exclamation-triangle'></i>&nbsp;&nbsp;(noch nicht best√§tigt)").data('sort_value', NaN)
                            ];
                        })
                    });
                }
            }
        });
    });
</script>