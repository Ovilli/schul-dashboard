#{this_is_a_page_for_logged_in_users}
<div class='container'>
    <div class='row'>
        <div class='col-md-12'>
            <h2 style='margin-bottom: 30px;'>Projekttage #{Date.today.year}</h2>
            <div class="alert mono-alert" style="#{schueler_logged_in? && (@session_user[:klassenstufe] || 7) >= 5 && (@session_user[:klassenstufe] || 7) <= 9 && projekttage_phase() < 3 ? '' : 'display: none;'}">
                Zum Ende des Schuljahres, vom <b>11. bis 15. Juli</b>, finden wieder die Projekttage statt.
                Hier siehst du, welche Projekte angeboten werden.
                Am <b>Montag, den 3. Juni</b> gibt es eine Vorstellung der Projekte in der 7. Stunde. Du kannst dir dann drei
                Projektvorstellungen anschauen und anschließend hier deine Lieblingsprojekte wählen.
            </div>
            <div class="alert mono-alert" style="#{user_eligible_for_projektwahl? ? '' : 'display: none;'}">
                <h3>Wähle deine Lieblingsprojekte!</h3>
                <p>
                    Wähle mindestens drei Projekte, die dich interessieren.
                    Du kannst sie später noch ändern. Falls du weniger als
                    drei Projekte wählst, werden wir weitere zufällige Projekte
                    für dich wählen, damit es insgesamt mindestens drei Projekte
                    sind, mit denen du in die Auslosung gehst. Du kannst dich
                    natürlich auch für mehr als drei Projekte anmelden.
                </p>
                <p id="text_vote_summary"></p>
            </div>
        </div>
    </div>
    <div class='row projekte-here'>
    </div>
</div>

<style>
    .mono-alert {
        background-color: rgba(255, 255, 255, 0.8);
    }
    body.dark .mono-alert {
        background-color: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .card {
        background-color: #f8f9fa;
        border: 1px solid #bebfc1;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        min-height: 280px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        position: relative;
        display: block;
        overflow: hidden;
    }
    .emojis {
        margin: 0.5em 0;
    }
    .emojis img {
        margin-right: 5px;
        border: 1px dashed rgba(0, 0, 0, 0.5);
        padding: 5px;
        border-radius: 8px;
        width: 40px;
        opacity: 0.5;
        cursor: pointer;
    }
    .emojis img.active {
        opacity: 1;
        border: 1px solid rgba(0, 0, 0, 0.5);
        background-color: #fff;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
    body.dark .emojis img {
        border: 1px dashed rgba(255, 255, 255, 0.5);
    }
    body.dark .emojis img.active {
        border: 1px solid rgba(255, 255, 255, 1);
        background-color: #111!important;
        box-shadow: 0 0 10px #fff;
    }
    hr.dashed {
        border-top: 1px dashed rgba(0,0,0,0.3);
    }
    body.dark hr.dashed {
        border-top: 1px dashed rgba(255, 255, 255, 0.3);
    }
</style>

<script>
var choice_level_label = [
    'Ich habe kein Interesse an diesem Projekt.',
    'Ich könnte mir vorstellen, an diesem Projekt teilzunehmen.',
    'Ich würde mich freuen, an diesem Projekt teilzunehmen.',
    'Ich würde wirklich sehr gern an diesem Projekt teilnehmen.',
];
var display_name_for_email = #{Hash[@@user_info.map { |email, info| [email, info[:teacher] ? info[:display_name_official] : info[:display_name]] }].to_json};
var this_klasse = #{@session_user[:klassenstufe] || 7};
var projekte = {};
var vote_for_project = {};
var codepoints = [0x1fae5, 0x1f914, 0x1f60d, 0x1f525];

function update_vote_summary() {
    console.log('updating summary');
    let buckets = {1: [], 2: [], 3: []};
    for (let nr in vote_for_project) {
        let vote = vote_for_project[nr];
        if (vote > 0)
            buckets[vote].push(nr);
    }
    let items = [];
    for (let i = 3; i >= 1; i--) {
        if (buckets[i].length > 0) {
            items.push([i, buckets[i]]);
        }
    }
    $('#text_vote_summary').empty();
    if (items.length === 0)
        $('#text_vote_summary').append($(`<p>`).html(`<em>Du hast bisher keine Projekte gewählt.</em>`));
    else {
        $('#text_vote_summary').append($(`<p>`).html(`<em>Du hast bisher folgende Projekte gewählt:</em>`));
        for (let item of items) {
            let vote = item[0];
            let projects = item[1];
            for (let project of projects) {
                let polaroid = $(`<div class="polaroid" style="position: relative; display: inline-block; float: none; width: 150px; height: 180px; margin-right: 10px; transform: none;"></div>`).css('background-image', `url(/api/get_sus_photo/${projekte[project].photo}-512.jpg)`).appendTo($('#text_vote_summary'));
                polaroid.append($(`<p style="font-size: 0.8em; margin-top: 120px; text-align: center; margin-left: -10px; margin-right: -10px; white-space: nowrap; overflow-x: clip; text-overflow: ellipsis;">`).text(projekte[project].title));
                polaroid.append($(`<p style="box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); background-color: #fff; border-radius: 50%; width: 1.5em; height: 1.5em; text-align: center; padding-top: 0.05em; font-size: 1.5em; transform: rotate(5deg); position: absolute; top: -15px; right: -15px;">`).text(String.fromCodePoint(codepoints[vote])));
            }
        }
        // $('#text_vote_summary').html(`<p>Du hast bisher folgende Projekte gewählt:</p><ul>${items.map(function(x) {return '<li>' + x + '</li>';}).join('')}</ul>`);
    }
    let i = items.length;
    while (i < 3) {
        i += 1;
        let polaroid = $(`<div class="polaroid" style="position: relative; display: inline-block; float: none; width: 150px; height: 180px; margin-right: 10px; transform: none;"></div>`).css('background-image', `url(/api/get_sus_photo/-512.jpg)`).appendTo($('#text_vote_summary'));
        polaroid.append($(`<p style="font-size: 0.8em; margin-top: 120px; text-align: center; margin-left: -10px; margin-right: -10px; white-space: nowrap; overflow-x: clip; text-overflow: ellipsis;">`).text('Überraschungs-Projekt'));
        polaroid.append($(`<p style="text-align: center; font-size: 2em; transform: rotate(-8deg); position: absolute; top: 40px; left: 40px; opacity: 0.6;">`).text('?'));
        polaroid.append($(`<p style="text-align: center; font-size: 3em; transform: rotate(2deg); position: absolute; top: 20px; left: 55px; opacity: 0.6;">`).text('?'));
        polaroid.append($(`<p style="text-align: center; font-size: 2em; transform: rotate(12deg); position: absolute; top: 40px; left: 80px; opacity: 0.6;">`).text('?'));
    }
    if (items.length > 0) {
        $('#text_vote_summary').append($(`<p class='mt-3'>`).html(`Wenn alle ihre Projekte gewählt haben, entscheidet das Los, welches Projekt du bekommst.`));
    }
}

document.addEventListener('DOMContentLoaded', function() {
    api_call('/api/get_projekte', {}, function(data) {
        if (data.success) {
            for (let projekt of data.projekte) {
                projekte[projekt.nr] = projekt;
                console.log(projekt);
                if (projekt.min_klasse === null)
                    continue;
                let scaffold = $(`<div class='col-md-12'>`);
                let photo = $(`<div class='polaroid' style='width: 200px; height: 240px; margin-left: 10px;'>`);
                if (projekt.photo)
                    photo.css('background-image', `url(/api/get_sus_photo/${projekt.photo}-512.jpg)`);
                let card = $(`<div class='card'>`);
                card.append(photo);
                card.append($(`<h4>`).text(projekt.title));
                let div = $(`<div style='position: relative; top: -5px;'>`).appendTo(card);
                for (let cat of projekt.categories)
                    div.append($(`<span class='badge badge-success' style='margin-right: 5px;'>`).text(cat));
                if (projekt.min_klasse === projekt.max_klasse) {
                    div.append($(`<span class='badge badge-warning' style='margin-right: 5px;'>`).text(`nur Klasse ${projekt.min_klasse}`));
                } else {
                    div.append($(`<span class='badge badge-warning' style='margin-right: 5px;'>`).text(`Klasse ${projekt.min_klasse} – ${projekt.max_klasse}`));
                }
                card.append($(`<p style='font-style: italic;'>`).text(`${projekt.organized_by.map(function(x) { return display_name_for_email[x]; }).join(', ')}`));
                card.append($(`<p>`).text(projekt.description ?? '(noch keine Beschreibung vorhanden)'));
                if ('#{user_eligible_for_projektwahl?}' === 'true') {
                    $(`<hr class='dashed'>`).appendTo(card);
                    if (this_klasse >= projekt.min_klasse && this_klasse <= projekt.max_klasse) {
                        vote_for_project[projekt.nr] = projekt.session_user_vote;
                        $(`<p>`).text(`Teile uns hier mit, wie sehr du dich für dieses Projekt interessierst:`).appendTo(card);
                        div = $(`<div class='emojis'>`).appendTo(card);
                        for (let i = 0; i < codepoints.length; i++) {
                            let codepoint = codepoints[i];
                            let img = $(`<img src='/images/emoji_u${codepoint.toString(16)}.png'>`).data('index', i);
                            if (i === projekt.session_user_vote) img.addClass('active');
                            div.append(img);
                            img.on('click', function() {
                                let self = this;
                                let index = $(this).data('index');
                                api_call('/api/vote_for_project', {nr: projekt.nr, vote: index}, function(data) {
                                    if (data.success) {
                                        $(self).parent().find('img').removeClass('active');
                                        $(self).addClass('active');
                                        $(self).closest('.card').find('._verdict').text(`»${choice_level_label[index]}«`);
                                        vote_for_project[projekt.nr] = index;
                                        update_vote_summary();
                                    }
                                });
                            });
                        }
                        let verdict = $(`<p class='_verdict' style='font-style: italic;'>`).text(`»${choice_level_label[0]}«`);
                        verdict.appendTo(card);
                    } else {
                        card.append($(`<p style='font-style: italic;'>`).text(`Du kannst dieses Projekt leider nicht wählen, da es nicht für deine Klassenstufe vorgesehen ist.`));
                    }
                }
                if ('#{teacher_logged_in?}' === 'true') {
                    $(`<hr style='border-top: 1px dashed rgba(0,0,0,0.3);'>`).appendTo(card);
                    if (projekt.exkursion_hint) {
                        card.append($(`<p style='font-style: italic;'>`).text(projekt.exkursion_hint).prepend($(`<strong>Exkursionen: </strong>`)));
                    } else {
                        card.append($(`<p style='font-style: italic;' class='text-muted'>`).text(`Exkursionen: keine Informationen vorhanden`));
                    }
                    if (projekt.extra_hint) {
                        card.append($(`<p style='font-style: italic;'>`).text(projekt.extra_hint).prepend($(`<strong>Tablets: </strong>`)));
                    } else {
                        card.append($(`<p style='font-style: italic;' class='text-muted'>`).text(`Tablets: keine Informationen vorhanden`));
                    }
                }
                // photo.css('transform', `rotate(${Math.random() * 10 - 5}deg)`);
                scaffold.append(card);
                $('.projekte-here').append(scaffold);
            }
            update_vote_summary();
        }
    });
});
</script>
