#{this_is_a_page_for_logged_in_teachers}
#{File.read('/static/_tresor_public_template.html')}
<div class='container bg-white'>
    <div class="w-full">
        <h3>Zeugniskonferenz #{ZEUGNIS_SCHULJAHR.sub('_', '/')} (#{ZEUGNIS_HALBJAHR}. Halbjahr)</h3>
        <div id="klassen_buttons_here"></div>
        <hr />
        <div id="zeugnisse_here"></div>
    </div>
</div>

<script>
var ZEUGNIS_SCHULJAHR = "#{ZEUGNIS_SCHULJAHR}";
var ZEUGNIS_HALBJAHR = "#{ZEUGNIS_HALBJAHR}";
var zeugnis_klassen_order = #{ZEUGNIS_KLASSEN_ORDER.to_json};
var klassen_tr = #{KLASSEN_TR.to_json};
var zeugnisliste_for_klasse = #{@@zeugnisliste_for_klasse.to_json};
var sesb_for_email = #{Hash[@@user_info.keys.map { |x| [x, @@user_info[x][:sesb]]}].to_json};
var zeugnis_formular_fehler = #{Hash[FAECHER_FOR_ZEUGNIS[ZEUGNIS_SCHULJAHR][ZEUGNIS_HALBJAHR].keys.map { |key| [key, @@zeugnisse[:formulare][key][:formular_fehler]] }].to_json};

window.addEventListener('load', function () {
    for (let klasse of zeugnis_klassen_order) {
        let button = $(`<button style='white-space: nowrap;' class='inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3 mr-1 mb-1'>${klassen_tr[klasse] ?? klasse}</button>`);
        $('#klassen_buttons_here').append(button);
        button.click(function(e) {
            load_zeugnis_table($('#zeugnisse_here'), klasse);
        });
    }
});

function load_zeugnis_table(container, klasse, edit_noten) {
    container.empty();
    let liste = zeugnisliste_for_klasse[klasse];
    let faecher = liste.faecher;
    let emails = liste.schueler.map(function(x) { return x.email; });

    let table = new SortableTable({
        element: container,
        xs: true,
        headers: ['Nr.', 'Nachname', 'Vorname', 'Geburtsdatum', 'Geschlecht', 'Klasse', 'Bildungsgang', 'Zeugnis'].map(function (x) {
            let th = $('<th>').html(x);
            return th;
        }),
        rows: emails.map(function (email, index) {
            let cells = [
                email,
                `<td style='text-align: right;'>${index + 1}.</td>`,
                `<td style='max-width: 10em;'>${liste.schueler[index].last_name}</td>`,
                `<td style='max-width: 10em;'>${liste.schueler[index].official_first_name}</td>`,
                `<td>${moment(liste.schueler[index].geburtstag).format('L')}</td>`,
                `<td>${liste.schueler[index].geschlecht}</td>`,
                `<td>${klassen_tr[klasse] ?? klasse}</td>`,
                `<td>${sesb_for_email[email] ? 'SESB' : 'altsprachlich'}</td>`,
            ];
            let zeugnis_key = liste.schueler[index].zeugnis_key;
            console.log(zeugnis_key);
            if (zeugnis_formular_fehler[zeugnis_key] === null) {
                let bu_zeugnis_pdf = $("<button class='btn btn-xs btn-success'>").html("<i class='fa fa-file-pdf-o'></i>&nbsp;&nbsp;Zeugnis</i>");
                cells.push($('<td>').append(bu_zeugnis_pdf));
                bu_zeugnis_pdf.click(function(e) {
                    let path_array = [];
                    path_array.push(['Schuljahr', ZEUGNIS_SCHULJAHR]);
                    path_array.push(['Halbjahr', ZEUGNIS_HALBJAHR]);
                    let liste = zeugnisliste_for_klasse[klasse];
                    let faecher = liste.faecher;
                    path_array.push(['Fach', faecher]);
                    path_array.push(['Email', [email]]);
                    tresor_api_call('/jwt/get_many', {path_arrays: [path_array], key: 'Note'}, function(data) {
                        api_call('/api/print_zeugnis', {schueler: [`${klasse}/${index}`], paths: path_array, values: data.results[0]}, function(data2) {
                            if (data2.success) {
                                window.open(data2.pdf_path, '_blank');
                            }
                        });
                    });
                });
            } else {
                cells.push($(`<td style='color: #888; font-size: 90%;'>`).html('Formular unvollst√§ndig'));
            }
            return cells;
        }),
        sortable: false,
    });
    container.find('.table').css('width', 'unset');
}

</script>