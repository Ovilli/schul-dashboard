#{require_user_who_can_manage_bib!}
#{File.read('/static/_bib_template.html')}
<style>
    #barcode_scanner_div {
        border: 1px solid #aaa;
        position: relative;
        width: 100%;
        /* padding-top: 133%; */
        overflow: hidden;
        height: 50vh;
        border-radius: 15px;
        background-color: #222;
    }

    #barcode_scanner_div video {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
    }

    #shelf_label {
        position: absolute;
        top: 0;
        left: 0;
        font-size: 48px;
        background-color: rgba(255, 255, 255, 0.5);
        padding: 0 0.2em;
    }

    #frame_canvas {
        width: 100%;
    }

    #current_photo {
        width: 100%;
    }

    #frame_canvas {
        display: none;
    }

    p {
        margin-bottom: 0.2em;
    }

    #shelf_items_list div {
        display: inline-block;
    }

    .button_container {
        position: absolute;
        right: 5px;
        bottom: 5px;
    }
</style>
<div class="modal" id="discard_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true"
    style='z-index: 200000;'>
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Buch ausmustern
                </h5>
            </div>
            <div class="modal-body">
                Bist du sicher, dass du dieses Buch ausmustern möchtest?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal"><i
                        class='fa fa-times'></i>&nbsp;&nbsp;Abbrechen</button>
                <button id='bu_confirm_discard' type="button" class="btn btn-danger"><i
                        class='fa fa-trash'></i>&nbsp;&nbsp;Ausmustern</button>
            </div>
        </div>
    </div>
</div>
<div id="barcode_scanner_div">
    <video id="barcode_scanner_video"></video>
    <div id="shelf_label"></div>
    <div class="button_container">
        <button id='bu-reset-shelf' style='margin-bottom: 5px; display: none;' class='btn btn-danger'><i
                class='fa fa-times'></i>&nbsp;&nbsp;Regal beenden</button>
        <button id='bu-add-photo' style='margin-bottom: 5px; display: none;' class='btn btn-success'><i
                class='fa fa-camera'></i>&nbsp;&nbsp;Foto hochladen</button>
    </div>
</div>
<div id="book_div" style="margin-top: 15px;"></div>
<hr />
<button id='bu_discard_exemplar' type="button" class="btn btn-outline-secondary" style='display: block; width: 100%;'
    disabled><i class='fa fa-trash'></i>&nbsp;&nbsp;Exemplar <span id='exemplar_here'></span> ausmustern</button>
<hr />
<p><strong>Schritt 1.</strong> Barcode im Buch scannen</p>
<p><strong>Schritt 2.</strong> Ausmusterung bestätigen</p>
<!-- <hr /> -->
<!-- <button id='bu_download_discarded_list' type="button" class="btn btn-success" style='display: block; width: 100%;'><i class='fa fa-file-o-pdf'></i>&nbsp;&nbsp;Liste herunterladen</button> -->
</section>
</div>

<script type="text/javascript" src="/include/zxing.min.js"></script>
<script>
    var beep0 = new Audio('/beep0.mp3');
    var beep1 = new Audio('/beep1.mp3');
    var beep2 = new Audio('/beep2.mp3');

    var signature_to_discard = null;

    function reset() {
        $('#book_div').empty();
        $('#bu_discard_exemplar').removeClass('btn-danger').addClass('btn-outline-secondary').prop('disabled', true);
        $('#exemplar_here').text('');
        signature_to_discard = null;
    }

    function on_scan(code) {
        if (code.match(/^\d{4}\/\d{3}$/) !== null)
            code = code.replace('/', '-');
        if (code.match(/^\d{4}\/0\d{3}$/) !== null)
            code = code.replace('/0', '-');
        if (code.match(/^\d{4}\-\d{3}$/) !== null) {
            reset();
            let signature = code;
            let stem = parseInt(signature.split('-')[0]);
            let bnr = parseInt(signature.split('-')[1]);
            bib_api_call('/jwt/get_book', { stem: stem, bnr: bnr }, function (data) {
                if (data.success) {
                    stem_book = data.book;
                    console.log(data);
                    let exemplar = (data.exemplar || {}).e;
                    $('#book_div').append(create_book_div(data.book, null, { bnr: bnr, exemplar: exemplar, bnr: bnr }));
                    $('#bu_discard_exemplar').removeClass('btn-outline-secondary').addClass('btn-danger');
                    if (exemplar && exemplar.ts_discarded)
                        $('#bu_discard_exemplar').prop('disabled', true);
                    else
                        $('#bu_discard_exemplar').prop('disabled', false);
                    $('#exemplar_here').text(`${bnr}`);
                    signature_to_discard = signature;
                }
            });

            console.log(`signature: ${signature}`);
            beep0.play();
        }
    }

    window.addEventListener('load', function () {

        const codeReader = new ZXing.BrowserMultiFormatReader()
        codeReader.decodeFromVideoDevice(null, 'barcode_scanner_video', (result, err) => {
            if (result) on_scan(result.text);
        });

        $('#bu_discard_exemplar').click(function (e) {
            $('#discard_modal').modal('show');
        });

        $('#bu_confirm_discard').click(function (e) {
            let signature = signature_to_discard;
            console.log(`discarding ${signature}`);
            $('#discard_modal').modal('hide');
            bib_api_call('/jwt/discard_exemplar', { signature: signature }, function (data) {
                if (data.success) {
                    reset();
                }
            });
        });

        $('#bu_download_discarded_list').click(function(e) {
            bib_api_call('/jwt/discarded_exemplare_pdf', { }, function (data) {
                if (data.success) {
                    console.log(data);
                    // reset();
                }
            });
        });

        // setTimeout(function () {
        //     on_scan('3558-048');
        // }, 0);
    });
</script>