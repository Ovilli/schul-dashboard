#{this_is_a_page_for_logged_in_teachers}
#{File.read('/static/_tresor_public_template.html')}
<style>
    tr.focused {
        background-color: #fce98d;
    }
</style>
<div class='container bg-white'>
    <div class="w-full">
        <h3>Klassen</h3>
        <div id="klassen_buttons_here"></div>
        <h3>Kurse</h3>
        <div id="kurs_buttons_here"></div>
        <hr />
        <div id="noten_here"></div>
    </div>
</div>

<script>
var SCHULJAHR = '2022_23';
var HALBJAHR = '1';
var kurse = #{(@@lessons_for_shorthand[@session_user[:shorthand]] || []).map { |x| @@lessons[:lesson_keys][x].merge({:lesson_key => x}) }.to_json};
var sus_for_kurs = #{Hash[(@@lessons_for_shorthand[@session_user[:shorthand]] || []).map { |x| [x, @@schueler_for_lesson[x]] }].to_json};
var klassen_order = #{KLASSEN_ORDER.to_json};
var klassen_tr = #{KLASSEN_TR.to_json};
var user_info = #{@@user_info.to_json};
var kurse_for_klasse = #{Hash[KLASSEN_ORDER.map { |klasse| [klasse, @@lessons_for_klasse[klasse].map { |x| @@lessons[:lesson_keys][x].merge({:lesson_key => x})}]}].to_json};
var kurs_info = #{@@lessons[:lesson_keys].to_json};
var schueler_for_klasse = #{@@schueler_for_klasse.to_json};

window.addEventListener('load', function () {
    for (let klasse of klassen_order) {
        if (klasse === '11' || klasse === '12') continue;
        let button = $(`<button style='white-space: nowrap;' class='inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3 mr-1 mb-1'>${klassen_tr[klasse] ?? klasse}</button>`);
        $('#klassen_buttons_here').append(button);
        button.click(function(e) {
            load_noten_table($('#noten_here'), kurse_for_klasse[klasse].map(function(x) { return x.lesson_key }), schueler_for_klasse[klasse]);
        });
    }

    for (let kurs of kurse) {
        let button = $(`<button style='white-space: nowrap;' class='inline-block bg-slate-900 border border-blue-500 hover:bg-slate-200 rounded py-1 px-3 mr-1 mb-1'>${kurs.pretty_folder_name}</button>`);
        $('#kurs_buttons_here').append(button);
        button.click(function(e) {
            let lesson_key = kurs.lesson_key;
            load_noten_table($('#noten_here'), [lesson_key], sus_for_kurs[lesson_key]);
        });
    }
});

function load_noten_table(container, lesson_keys, emails) {
    let path_array = [];
    path_array.push(['Schuljahr', SCHULJAHR]);
    path_array.push(['Halbjahr', HALBJAHR]);
    path_array.push(['Fach', lesson_keys]);
    path_array.push(['Email', emails]);
    container.empty();
    let t0 = Date.now();
    tresor_api_call('/jwt/get_many', {path_array: path_array, key: 'Note'}, function(data) {
        let t1 = Date.now();
        console.log(`request took ${t1 - t0} ms.`);
        if (data.success) {
            let table = new SortableTable({
                element: container,
                xs: true,
                headers: (['Nr.', 'Nachname', 'Vorname', 'Klasse'].concat(lesson_keys.map(function(lk) { let kurs = kurs_info[lk]; return `${kurs.fach}<br /><span style='font-size: 85%; font-weight: normal;'>(${kurs.lehrer.join(', ')})</span>`; }))).map(function (x) {
                    let th = $('<th>').html(x);
                    return th;
                }),
                rows: emails.map(function (email, index) {
                    let cells = [
                        email,
                        `<td style='text-align: right;'>${index + 1}.</td>`,
                        `<td>${user_info[email].last_name}</td>`,
                        `<td>${user_info[email].official_first_name}</td>`,
                        // `<td>${moment(user_info[email].geburtstag).format('L')}</td>`,
                        `<td>${klassen_tr[user_info[email].klasse] ?? user_info[email].klasse}</td>`,
                    ];
                    for (let lki = 0; lki < lesson_keys.length; lki++) {
                        let lesson_key = lesson_keys[lki];
                        let input = $(`<input class='form-control' style='width: 3em; text-align: center; height: calc(1.5em + 2px);'>`)
                        input.val(data.results[0][0][lki][index]);
                        input.focus(function(e) {
                            input.select();
                            container.find('tr').removeClass('focused');
                            input.closest('tr').addClass('focused');
                            $(e.target).data('old_value', $(e.target).val());
                        });
                        input.blur(function(e) {
                            container.find('tr').removeClass('focused');
                            let value = $(e.target).val().trim();
                            if (value !== $(e.target).data('old_value')) {
                                let path = `Schuljahr:${SCHULJAHR}/Halbjahr:${HALBJAHR}/Fach:${lesson_key}/Email:${email}`;
                                tresor_api_call('/jwt/store', {path: path, key: 'Note', value: value}, function(data) {
                                });
                            }
                        });
                        input.keydown(function(e) {
                            if (e.key === 'Enter' || e.key === 'ArrowDown') {
                                e.preventDefault();
                                e.stopPropagation();
                                let row = $(e.target).closest('tr');
                                let this_index = $(e.target).closest('td').index();
                                let next_row = row.next('tr');
                                if (next_row.length === 0) {
                                    next_row = row.closest('tbody').find('tr').first();
                                }
                                next_row.find('td').eq(this_index).find('input').focus().select();
                            }
                            if (e.key === 'ArrowUp') {
                                e.preventDefault();
                                e.stopPropagation();
                                let row = $(e.target).closest('tr');
                                let this_index = $(e.target).closest('td').index();
                                let next_row = row.prev('tr');
                                if (next_row.length === 0) {
                                    next_row = row.closest('tbody').find('tr').last()
                                }
                                next_row.find('td').eq(this_index).find('input').focus().select();
                            }
                        });
                        cells.push($('<td>').append(input));
                    }
                    return cells;
                }),
                sortable: false,
            });
            container.find('.table').css('width', 'unset');
        }
    });
}
</script>