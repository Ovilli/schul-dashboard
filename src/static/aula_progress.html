#{require_user_who_can_manage_tablets!}
<div class='container-fluid' style='padding-top: 30px; background-color: #000; color: #fff;'>
    <div class='row'>
        <div class="col-md-12">
            <h2 style='margin-bottom: 30px;'>Aula Ablauf</h2>
            <hr>
            <button class='btn btn-light bu-new-event'><i class='fa fa-list'></i>&nbsp;&nbsp;Neuer Eintrag</button>
            <button class='btn btn-danger bu-clear-list pull-right'><i class='fa fa-trash'></i>&nbsp;&nbsp;Liste leeren</button>
            <hr>
            <div class='aula-events-container' style='max-width: 100%; overflow-x: auto;'>
                <table class='table table-striped narrow' style='width: unset; min-width: 100%; color: #fff;'>
                    <thead>
                        <tr>
                            <th style='width: 100px;'>Reihenfolge</th>
                            <th style='width: 150px;'>Zeitunkt</th>
                            <th style='min-width: 150px;'>Beschreibung</th>
                            <!-- <th style='min-width: 150px;'>Licht</th> 
                            <th style='width: 120px;'>Bearbeiten</th>  -->
                            <th style='width: 120px;'>Fertig</th> 
                            <th style='width: 120px;'>Löschen</th>
                        </tr>
                    </thead>
                    <tbody class='events-here'>
                    </tbody>
                </table>
            </div>
            <br>
            <a href='/api/aula_event_pdf' target='_blank' class='btn btn-primary'><i class='fa fa-file-pdf-o'></i>&nbsp;&nbsp;Download</a>
        </div>
    </div>
</div>

<script>
    function refresh_events() {
        api_call('/api/get_aula_events', {}, function (data) {
            $('.events-here').empty();
            if (data.success) {
                for (let entry of data.events) {
                    let row = $('<tr>');
                    row.data('id', entry.id);
                    let cell;
                    let ti_number = $("<input>").attr('type', 'number').addClass('form-control').val(entry.number);
                    cell = $('<td>').append(ti_number);
                    row.append(cell);
                    let ti_time = $("<input>").attr('type', 'time').addClass('form-control').val(entry.time);
                    cell = $('<td>').append(ti_time);
                    row.append(cell);
                    let ti_title = $("<input>").attr('type', 'text').addClass('form-control').val(entry.title);
                    cell = $('<td>').append(ti_title);
                    row.append(cell);
                    let ti_light = $("<code>").text(entry.desk_array);
                    let bu_light = $('<button>').addClass('btn').addClass('btn-warning').html("<i class='fa fa-lightbulb-o'></i>&nbsp;&nbsp;Licht");
                    // row.append($('<td>').append(ti_light));
                    // row.append($('<td>').append(bu_light));
                    let bu_finished = $('<button>').addClass('btn').addClass('btn').addClass('btn-success').html("<i class='fa fa-check'></i>&nbsp;&nbsp;Fertig");
                    let bu_unfinished = $('<button>').addClass('btn').addClass('btn').addClass('btn-outline-success').html("<i class='fa fa-check'></i>&nbsp;&nbsp;Fertig");
                    if (entry.finished == false) {
                        row.append($('<td>').append(bu_unfinished));
                    } else {
                        row.append($('<td>').append(bu_finished));
                    }
                    let bu_delete = $('<button>').addClass('btn').addClass('btn').addClass('btn-danger').html("<i class='fa fa-trash'></i>&nbsp;&nbsp;Löschen");
                    row.append($('<td>').append(bu_delete));
                    $('.events-here').append(row);
                    bu_light.click(function (e) {
                        let id = $(e.target).closest('tr').data('id');
                        $('.bu-perform-set-light-aula-event').data('delete_id', id);
                        showTemplateModal('Lichter setzen',
                            'Hier kannst du belibige Lichter setzen, indem du alle Kanalnummern (nicht DMX!) durch Kommas getrennt angibst.<br><textarea class="form-control" type id="desk-array"></textarea>',
                            "<i class='fa fa-save'></i>&nbsp;&nbsp;Speichern", 'btn-success',
                            'Abbrechen', 'btn-secondary', function () {
                                let desk_array = $('#desk-array').val();
                                api_call('/api/set_light_aula_event', { id: id, desk_array: desk_array }, function (data) {
                                    refresh_events();
                                });
                            }
                        );
                    });
                    bu_unfinished.click(function (e) {
                        let id = $(e.target).closest('tr').data('id');
                        $('.bu-perform-finish-aula-event').data('finish_id', id);
                        api_call('/api/finish_aula_event', { id: id }, function (data) {
                            refresh_events();
                        });
                    });
                    bu_finished.click(function (e) {
                        let id = $(e.target).closest('tr').data('id');
                        $('.bu-perform-unfinish-aula-event').data('unfinish_id', id);
                        api_call('/api/unfinish_aula_event', { id: id }, function (data) {
                            refresh_events();
                        });
                    });
                    bu_delete.click(function (e) {
                        let id = $(e.target).closest('tr').data('id');
                        $('.bu-perform-delete-aula-event').data('delete_id', id);
                        api_call('/api/delete_aula_event', { id: id }, function (data) {
                            refresh_events();
                        });
                    });
                    ti_number.change(function (e) {
                        let id = $(e.target).closest('tr').data('id');
                        api_call('/api/change_aula_event_number', { id: id, number: $(e.target).val() }, function (data) {
                            refresh_events();
                        });
                    });
                    ti_time.change(function (e) {
                        let id = $(e.target).closest('tr').data('id');
                        api_call('/api/change_aula_event_time', { id: id, time: $(e.target).val() }, function (data) {
                            refresh_events();
                        });
                    });
                    ti_title.change(function (e) {
                        let id = $(e.target).closest('tr').data('id');
                        api_call('/api/change_aula_event_title', { id: id, title: $(e.target).val() }, function (data) {
                            refresh_events();
                        });
                    });
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        refresh_events();
        $('.bu-new-event').click(function (e) {
            api_call('/api/create_aula_event', {}, function (data) {
                refresh_events();
            });
        });
        $('.bu-clear-list').click(function (e) {
            showTemplateModal('Liste leeren',
                'Möchtest du die Liste wirklich unwiderruflich leeren?',
                "<i class='fa fa-trash'></i>&nbsp;&nbsp;Liste leeren", 'btn-danger',
                'Abbrechen', 'btn-secondary', function () {
                    api_call('/api/clear_aula_events', {}, function (data) {
                        refresh_events();
                    });
                });

        });;
        });
</script>
