#{require_user_who_can_manage_tablets!}
<div class='container-fluid' style='padding-top: 30px; background-color: #fff;'>
    <div class='row'>
        <div class="col-md-12">
            <h2 style="margin-bottom: 30px;">Technikamt (Admin)</h2>
            <hr>
            <p>
                Du bist #{(admin_logged_in?) ? 'Admin im Dashboard' : 'Teil des TechnikTeams'} und kannst deshalb hier Probleme mit Geräten aufnehmen und auch <b>schließen</b>. Auch kannst du dich als Tablet anmelden.  
            </p>
            <hr>
            <div class='row'>
                <div class='col-md-7'>
                    <div class="form-group">
                        <label>Problem</label>
                        <input type="text" class="form-control" placeholder="z.B. Das Gerät gibt kein Bild aus, wenn ..." id='tp_problem_description' />
                    </div>
                </div>
                <div class='col-md-3'>
                    <div class="form-group">
                        <label>Gerät</label>
                        <input type="text" class="form-control" placeholder="z.B. Computer 2 / C2 ..." id='tp_problem_device' />
                    </div>
                </div>
                <div class='col-md-2'>
                    <div class="form-group">
                        <label>Datum</label>
                        <input type="date" class="form-control" id='tp_date' value='#{Date.today.to_s}' />
                    </div>
                </div>
            </div>
            <div class='row' style='margin-bottom: 15px;'>
                <div class='col-md-12'>
                    <button id='tp_report_problem' class='btn btn-success pull-right' disabled><i class='fa fa-send'></i>&nbsp;&nbsp;Absenden</button>
                </div>
            </div>
            <div class='row'>                
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    <table class='table narrow table-striped' style='width: unset; min-width: 100%;'>
                    <thead><tr>
                    <th>Name</th>
                    <th>Klasse</th>
                    <th>Problem</th>
                    <th>Gerät</th>
                    <th>Datum</th>
                    <th style="width: 140px;">Behoben</th>
                    <th style="width: 140px;">Nicht Behoben</th>
                    <th style="width: 140px;">Kommentar</th>
                    <th style="width: 140px;">Technikamt</th>
                    <th style="width: 140px;">TechnikTeam</th>
                    <th style="width: 140px;">Löschen</th>
                    </tr></thead>
                    <tbody id='problems_here'>
                    </tbody>
                    </table>
                </div>
            </div>
            <div class='row' style='margin-bottom: 15px;'>
                <div class='col-md-12'>
                    <button class='bu-fixed-problems btn btn-primary'><i class='fa fa-eye'></i>&nbsp;&nbsp;Ausgeblendete Probleme</button>
                    <button class='bu-tablets btn btn-warning'><i class='fa fa-tablet'></i>&nbsp;&nbsp;Tablets</button>
                    <button class='bu-safe btn btn-success' style="display: none;"><i class='fa fa-laptop'></i>&nbsp;&nbsp;Geräte im Safe</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="composeFixed" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
       <div class="modal-header">
          <h5 class="modal-title">Ausgeblendete Probleme</h5>
        </div>
        <div class="modal-body">
            <div class='row'>
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    <table class='table narrow table-striped' style='width: unset; min-width: 100%;'>
                    <thead><tr>
                    <th>Name</th>
                    <th>Klasse</th>
                    <th>Problem</th>
                    <th>Gerät</th>
                    <th>Datum</th>
                    <th style="width: 140px;">Kommentar</th>
                    <th style="width: 140px;">Technikamt</th>
                    <th style="width: 140px;">TechnikTeam</th>
                    <th style="width: 140px;">Löschen</th>
                    </tr></thead>
                    <tbody id='fixed_problems_here'>
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
</div>

<div class="modal" id="composeTablets" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
       <div class="modal-header">
          <h5 class="modal-title">Tablets</h5>
        </div>
        <div class="modal-body">
            <div class='row'>
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    #{print_tablet_login()}
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
</div>

<div class="modal" id="composeSafe" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
       <div class="modal-header">
          <h5 class="modal-title">Geräte im Safe</h5>
        </div>
        <div class="modal-body">
            <div class='row'>
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    <div class="safe-devices">
                        <b>Aktuell sollte im Safe stehen:</b><br>
                        - 2 Computer<br>
                        - 3 Beamer<br>
                        - 6 Multi-Beamer<br>
                        - 4 DVD-Player
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
</div>

<script>

    function compose_fixed_problems() {
        $('#composeFixed').modal('show');
        refresh_fixed_tech_problems();
    }

    function compose_tablets() {
        $('#composeTablets').modal('show');
    }

    function compose_safe() {
        $('#composeSafe').modal('show');
    }

    function update_submit_button() {
        let problem = $('#tp_problem_description').val().trim();
        let date = $('#tp_date').val().trim();
        let device = $('#tp_problem_device').val();
        $('#tp_report_problem').prop('disabled', !(problem.length > 0 && device.length > 0));
    }

    function refresh_tech_problems() {
        api_call('/api/get_tech_problems_admin', {}, function(data) {
            if (data.success) {
                $('#problems_here').empty();
                for (let entry of data.tech_problems) {
                    if (entry.problem.fixed == false && entry.problem.not_fixed == false && entry.problem.hidden_admin == false) { 
                        let row = $('<tr>');
                        row.append($('<td>').html("<img src='#{NEXTCLOUD_URL}/index.php/avatar/" + entry.nc_login + "/256}' class='icon avatar-md'/>&nbsp;&nbsp;&nbsp;" + entry.display_name));
                        if (entry.klasse) {
                            row.append($('<td>').text(entry.klasse));
                        } else {
                            row.append($('<td>').html('<i class="fa fa-user-o"></i>'));
                        }
                        row.append($('<td>').text(entry.problem.problem));
                        row.append($('<td>').text('' + entry.problem.device));
                        row.append($('<td>').text(moment(entry.problem.date).format('ddd, D.M.Y')));

                        let tp_fixed = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-success').html("<i class='fa fa-check'></i>&nbsp;&nbsp;Behoben");
                        tp_fixed.data('token', entry.problem.token);
                        tp_fixed.click(function(e) {

                            api_call('/api/fix_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                                if (data.success)
                                    refresh_tech_problems();
                            });

                        });

                        let tp_not_fixed = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-warning').html("<i class='fa fa-times'></i>&nbsp;&nbsp;Nicht Behoben");
                        tp_not_fixed.data('token', entry.problem.token);
                        tp_not_fixed.click(function(e) {

                            api_call('/api/not_fix_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                                if (data.success)
                                    refresh_tech_problems();
                            });

                        });
                        row.append($('<td>').append(tp_fixed));
                        row.append($('<td>').append(tp_not_fixed));
                        
                        let tp_comment = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-primary').html("<i class='fa fa-plus'></i>&nbsp;&nbsp;Kommentar");
                        tp_comment.data('token', entry.problem.token);
                        tp_comment.click(function(e) {
                            let token = entry.problem.token
                            showTemplateModal('Kommentar hinzufügen', 
                                '<textarea type="text" id="tp_comment_input" class="form-control" placeholder="z.B. Danke für deinen Beitrag"></textarea>',
                                "<i class='fa fa-check'></i>&nbsp;&nbsp;Speichern", 'btn-success',
                                'Abbrechen', 'btn-secondary', function() {
                                    let comment = $('#tp_comment_input').val();
                                    api_call('/api/comment_tech_problem_admin', {token: token, comment: comment}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                    });
                                }
                            );
                        });

                        let tp_update_comment = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-primary').html("<i class='fa fa-pencil'></i>");
                        tp_update_comment.data('token', entry.problem.token);
                        tp_update_comment.click(function(e) {
                            let token = entry.problem.token
                            let old_comment = entry.problem.comment
                            showTemplateModal('Kommentar aktualisieren', 
                                '<textarea type="text" id="tp_comment_input" class="form-control" placeholder="z.B. Danke für deinen Beitrag (leer lassen, um den Kommentar zu löschen)">' + old_comment + '</textarea>',
                                "<i class='fa fa-check'></i>&nbsp;&nbsp;Speichern", 'btn-success',
                                'Abbrechen', 'btn-secondary', function() {
                                    let comment = $('#tp_comment_input').val();
                                    api_call('/api/comment_tech_problem_admin', {token: token, comment: comment}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                    });
                                }
                            );
                        });
                        

                        if (entry.problem.comment == false) {
                            row.append($('<td>').append(tp_comment));
                        } else {
                            row.append($('<td>').text('' + entry.problem.comment + ' ').append(tp_update_comment));
                        }


                        let tp_delete = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-danger').html("<i class='fa fa-trash'></i>&nbsp;&nbsp;Löschen");
                        tp_delete.data('token', entry.problem.token);
                        tp_delete.click(function(e) {
                            showTemplateModal('Problem löschen', 
                                'Bist Du sicher? Das Problem wird dabei unwiderrufbar gelöscht.',
                                "<i class='fa fa-trash'></i>&nbsp;&nbsp;Problem löschen", 'btn-danger',
                                'Abbrechen', 'btn-secondary', function() {
                                    api_call('/api/delete_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                            refresh_fixed_tech_problems();
                                    });
                                }
                            );
                        });

                        let tp_hide_admin = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-info').html("<i class='fa fa-wrench'></i>&nbsp;&nbsp;Eingeblendet");
                        tp_hide_admin.data('token', entry.problem.token);
                        tp_hide_admin.click(function(e) {
                            if (entry.problem.comment != "") {
                                api_call('/api/hide_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                                if (data.success)
                                    refresh_tech_problems();
                                });
                            } else {
                                showTemplateModal('Ausblenden nicht möglich',
                                'Bitte reagiere erst auf diese Meldung, indem du einen Kommentar schreibst und/oder das Problem als „behoben“ oder „nicht behoben“ markierst.',
                                '','',
                                'Schließen', 'btn-secondary'
                                )
                            }
                                                        

                        });

                        let tp_mail_count = entry.problem.mail_count

                        let tp_mail = $('<button>')
                            .addClass('btn btn-xs btn-success')
                            .html("<i class='fa fa-envelope'></i>&nbsp;&nbsp;(" + tp_mail_count + ")")
                            .data('token', entry.problem.token)
                            .click(function(e) {
                                let token = $(this).data('token');
                                api_call('/api/mail_tech_problem', {token: token}, function(data) {
                                    if (data.success)
                                        refresh_tech_problems();
                                });
                            });

                        if (entry.problem.hidden == false) {
                            let tp_hide = $('<button>')
                                .addClass('btn btn-xs btn-info')
                                .html("<i class='fa fa-eye'></i>")
                                .data('token', entry.problem.token)
                                .click(function(e) {
                                    let token = $(this).data('token');
                                    api_call('/api/hide_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                    });
                                });
                            row.append($('<td>').append(tp_hide).append('&nbsp;').append(tp_mail));
                            row.append($('<td>').append(tp_hide_admin));
                        } else {
                            let tp_hide = $('<button>')
                                .addClass('btn btn-xs btn-secondary')
                                .html("<i class='fa fa-eye-slash'></i>")
                                .data('token', entry.problem.token)
                                .click(function(e) {
                                    let token = $(this).data('token');
                                    api_call('/api/unhide_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                    });
                                });
                            row.append($('<td>').append(tp_hide).append('&nbsp;').append(tp_mail));
                            row.append($('<td>').append(tp_hide_admin));
                        }
                        row.append($('<td>').append(tp_delete));
                        $('#problems_here').append(row);
                    }
                }
            }
        });
    }

    function refresh_fixed_tech_problems() {
        api_call('/api/get_tech_problems_admin', {}, function(data) {
            if (data.success) {
                refresh_tech_problems();
                $('#fixed_problems_here').empty();
                for (let entry of data.tech_problems) {
                    if (entry.problem.fixed == true  || entry.problem.not_fixed == true || entry.problem.hidden_admin == true) { 
                        let row = $('<tr>');
                        row.append($('<td>').html("<img src='#{NEXTCLOUD_URL}/index.php/avatar/" + entry.nc_login + "/256}' class='icon avatar-md'/>&nbsp;&nbsp;&nbsp;" + entry.display_name));
                        row.append($('<td>').text(entry.klasse));
                        if (entry.problem.not_fixed == true) {
                            row.append($('<td>').addClass('text-danger').text(entry.problem.problem));
                        } else if (entry.problem.fixed == true) {
                            row.append($('<td>').addClass('text-success').text(entry.problem.problem));
                        } else {
                            row.append($('<td>').text(entry.problem.problem));
                        }
                        row.append($('<td>').text('' + entry.problem.device));
                        row.append($('<td>').text(moment(entry.problem.date).format('ddd, D.M.Y')));

                        // let tp_fixed = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-warning').html("<i class='fa fa-times'></i>&nbsp;&nbsp;In Bearbeitung");
                        // tp_fixed.data('token', entry.problem.token);
                        // tp_fixed.click(function(e) {

                        //     api_call('/api/unfix_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                        //         if (data.success)
                        //             refresh_fixed_tech_problems();
                        //             refresh_tech_problems();
                        //     });

                        // });
                        // row.append($('<td>').append(tp_fixed));

                        let tp_delete = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-danger').html("<i class='fa fa-trash'></i>&nbsp;&nbsp;Löschen");
                        tp_delete.data('token', entry.problem.token);
                        tp_delete.click(function(e) {
                            showTemplateModal('Problem löschen', 
                                'Bist Du sicher? Das Problem wird dabei unwiderrufbar gelöscht.',
                                "<i class='fa fa-trash'></i>&nbsp;&nbsp;Problem löschen", 'btn-danger',
                                'Abbrechen', 'btn-secondary', function() {
                                    api_call('/api/delete_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                                        if (data.success)
                                            refresh_fixed_tech_problems();
                                            refresh_tech_problems();
                                    });
                                }
                            );
                        });

                        let tp_comment = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-primary').html("<i class='fa fa-plus'></i>&nbsp;&nbsp;Kommentar");
                        tp_comment.data('token', entry.problem.token);
                        tp_comment.click(function(e) {
                            let token = entry.problem.token
                            showTemplateModal('Kommentar hinzufügen', 
                                '<textarea type="text" id="tp_comment_input" class="form-control" placeholder="z.B. Danke für deinen Beitrag"></textarea>',
                                "<i class='fa fa-check'></i>&nbsp;&nbsp;Speichern", 'btn-success',
                                'Abbrechen', 'btn-secondary', function() {
                                    let comment = $('#tp_comment_input').val();
                                    api_call('/api/comment_tech_problem_admin', {token: token, comment: comment}, function(data) {
                                        if (data.success)
                                            refresh_fixed_tech_problems();
                                    });
                                }
                            );
                        });

                        let tp_update_comment = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-primary').html("<i class='fa fa-pencil'></i>");
                        tp_update_comment.data('token', entry.problem.token);
                        tp_update_comment.click(function(e) {
                            let token = entry.problem.token
                            let old_comment = entry.problem.comment
                            showTemplateModal('Kommentar aktualisieren', 
                                '<div class="alert alert-warning">Falls das Problem nicht als „behoben“ oder „nicht behoben“ markiert ist, kannst du den Kommentar erst, nachdem du das Problem für das TechnikTeam wieder eingeblendet hast löschen.</div><textarea type="text" id="tp_comment_input" class="form-control" placeholder="z.B. Danke für deinen Beitrag (leer lassen, um den Kommentar zu löschen)">' + old_comment + '</textarea>',
                                "<i class='fa fa-check'></i>&nbsp;&nbsp;Speichern", 'btn-success',
                                'Abbrechen', 'btn-secondary', function() {
                                    let comment = $('#tp_comment_input').val();
                                    if (comment != "" || entry.problem.fixed || entry.problem.not_fixed) {
                                        api_call('/api/comment_tech_problem_admin', {token: token, comment: comment}, function(data) {
                                            if (data.success)
                                                refresh_fixed_tech_problems();
                                        });
                                    } else {
                                        // refresh_fixed_tech_problems();
                                        // showTemplateModal('Blende das Problem zuerst wieder ein',
                                        // 'Da das Problem nach dem Löschen des Kommentars unbeantwortet wäre musst du es erst wieder einblenden, um den Kommentar zu löschen.',
                                        // '','',
                                        // 'Schließen', 'btn-secondary'
                                        // )
                                        console.log("Test")
                                    }
                                }
                            );
                        });

                        if (entry.problem.comment == false) {
                            row.append($('<td>').append(tp_comment));
                        } else {
                            row.append($('<td>').text('' + entry.problem.comment + ' ').append(tp_update_comment));
                        }

                        let tp_hide_admin = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-secondary').html("<i class='fa fa-wrench'></i>&nbsp;&nbsp;Ausgeblendet");
                        tp_hide_admin.data('token', entry.problem.token);
                        tp_hide_admin.click(function(e) {
                            api_call('/api/unhide_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                                if (data.success)
                                    refresh_tech_problems();
                                    refresh_fixed_tech_problems();
                            });
                        });

                        let tp_mail_count = entry.problem.mail_count

                        let tp_mail = $('<button>')
                            .addClass('btn btn-xs btn-success')
                            .html("<i class='fa fa-envelope'></i>&nbsp;(" + tp_mail_count + ")")
                            .data('token', entry.problem.token)
                            .click(function(e) {
                                let token = $(this).data('token');
                                api_call('/api/mail_tech_problem', {token: token}, function(data) {
                                    if (data.success)
                                        refresh_fixed_tech_problems();
                                });
                            });

                        if (entry.problem.hidden == false) {
                            let tp_hide = $('<button>')
                                .addClass('btn btn-xs btn-info')
                                .html("<i class='fa fa-eye'></i>")
                                .data('token', entry.problem.token)
                                .click(function(e) {
                                    let token = $(this).data('token');
                                    api_call('/api/hide_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_fixed_tech_problems();
                                    });
                                });
                            row.append($('<td>').append(tp_hide).append('&nbsp;').append(tp_mail));
                            row.append($('<td>').append(tp_hide_admin));
                        } else {
                            let tp_hide = $('<button>')
                                .addClass('btn btn-xs btn-secondary')
                                .html("<i class='fa fa-eye-slash'></i>")
                                .data('token', entry.problem.token)
                                .click(function(e) {
                                    let token = $(this).data('token');
                                    api_call('/api/unhide_tech_problem', {token: token}, function(data) {
                                        if (data.success)
                                            refresh_fixed_tech_problems();
                                    });
                                });
                            row.append($('<td>').append(tp_hide).append('&nbsp;').append(tp_mail));
                            row.append($('<td>').append(tp_hide_admin));
                        }
                        row.append($('<td>').append(tp_delete));
                        $('#fixed_problems_here').append(row);
                    }
                }
            }
        });
    }


document.addEventListener('DOMContentLoaded', function() {
    moment.locale('de');
    update_submit_button();
    $('#tp_problem_description').keyup(function(e) { update_submit_button(); });
    $('#tp_problem_descriptione').change(function(e) { update_submit_button(); });
    $('#tp_date').change(function(e) { update_submit_button(); });
    $('#tp_problem_device').keyup(function(e) { update_submit_button(); });
    $('#tp_problem_device').change(function(e) { update_submit_button(); });
    $('#tp_report_problem').click(function(e) {
        let problem = $('#tp_problem_description').val().trim();
        let date = $('#tp_date').val().trim();
        let device = $('#tp_problem_device').val();
        api_call('/api/report_tech_problem', {problem: problem, date: date, device: device}, function(data) {
            console.log(data);
            refresh_tech_problems();
        });
    });
    refresh_tech_problems();
    $('.bu-fixed-problems').click(function(e) {
        compose_fixed_problems();
    });

    $('.bu-tablets').click(function(e) {
        compose_tablets();
    });

    $('.bu-safe').click(function(e) {
        compose_safe();
    });

    $('.btn-purge-session').click(function (e) {
        let scrambled_sid = $(e.target).data('scrambled-sid');
        let email = $(e.target).data('email');
        api_call('/api/purge_session_for_user', { email: email, scrambled_sid: scrambled_sid }, function (data) {
            if (data.success) {
                $(e.target).closest('tr').remove();
            }
        });
    });
    $('.bu_login_teacher_tablet').click(function (e) {
        api_call('/api/login_as_teacher_tablet', {}, function (data) {
            if (data.success) {
                window.location.href = '/';
            }
        });
    });
    $('.bu_login_kurs_tablet').click(function (e) {
        let selected_buttons = $('.btn-teacher-for-kurs-tablet-login.selected');
        let shorthands = [];
        for (let button of selected_buttons) {
            shorthands.push($(button).data('shorthand'));
        }
        api_call('/api/login_as_kurs_tablet', { shorthands: shorthands }, function (data) {
            if (data.success) {
                window.location.href = '/';
            }
        });
    });
    $('.btn-teacher-for-kurs-tablet-login').click(function (e) {
        let button = $(e.target);
        button.toggleClass('selected');
        let selected_buttons = $('.btn-teacher-for-kurs-tablet-login.selected');
        $('.bu_login_kurs_tablet').attr('disabled', selected_buttons.length === 0);
    });
    $('.btn-tablet-login').click(function (e) {
        api_call('/api/login_as_tablet', { id: `${$(e.target).data('id')}` }, function (data) {
            if (data.success) {
                window.location.href = '/';
            }
        });
    });
    })
</script>
