#{require_user_who_can_manage_tablets!}
<div class='container-fluid' style='padding-top: 30px; background-color: #fff;'>
    <div class='row'>
        <div class="col-md-12">
            <h2 style="margin-bottom: 30px;">Technikamt (Admin)</h2>
            <hr>
            <p>
                Du bist Teil des TechnikTeams (oder Admin im Dashboard) und kannst deshalb hier Probleme mit Geräten aufnehmen und auch <b>schließen</b>.   
            </p>
            <hr>
            <div class='row'>
                <div class='col-md-7'>
                    <div class="form-group">
                        <label>Problem</label>
                        <input type="text" class="form-control" placeholder="z.B. Das Gerät gibt kein Bild aus, wenn ..." id='tp_problem_description' />
                    </div>
                </div>
                <div class='col-md-3'>
                    <div class="form-group">
                        <label>Gerät</label>
                        <input type="text" class="form-control" placeholder="z.B. Computer 2 / C2 ..." id='tp_problem_device' />
                    </div>
                </div>
                <div class='col-md-2'>
                    <div class="form-group">
                        <label>Datum</label>
                        <input type="date" class="form-control" id='tp_date' value='#{Date.today.to_s}' />
                    </div>
                </div>
            </div>
            <div class='row' style='margin-bottom: 15px;'>
                <div class='col-md-12'>
                    <button id='tp_report_problem' class='btn btn-success pull-right' disabled><i class='fa fa-send'></i>&nbsp;&nbsp;Absenden</button>
                </div>
            </div>
            <div class='row'>
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    <table class='table narrow table-striped' style='width: unset; min-width: 100%;'>
                    <thead><tr>
                    <th>Datum</th>
                    <th>Name</th>
                    <th>Klasse</th>
                    <th>Problem</th>
                    <th>Gerät</th>
                    <th>Behoben</th>
                    <th>Löschen</th>
                    </tr></thead>
                    <tbody id='problems_here'>
                    </tbody>
                    </table>
                </div>
            </div>
            <div class='row' style='margin-bottom: 15px;'>
                <div class='col-md-12'>
                    <button class='bu-compose btn btn-primary'><i class='fa fa-eye'></i>&nbsp;&nbsp;Behobene Probleme</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="composeModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
       <div class="modal-header">
          <h5 class="modal-title">Behobene Probleme</h5>
        </div>
        <div class="modal-body">
            <div class='row'>
                <div class='col-md-12' style='max-width: 100%; overflow-x: auto;'>
                    <table class='table narrow table-striped' style='width: unset; min-width: 100%;'>
                    <thead><tr>
                    <th>Datum</th>
                    <th>Name</th>
                    <th>Klasse</th>
                    <th>Problem</th>
                    <th>Gerät</th>
                    <th>Nicht behoben</th>
                    <th>Löschen</th>
                    </tr></thead>
                    <tbody id='fixed_problems_here'>
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button id='bu_close_message_modal' type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
  </div>

<script>

    function compose_fixed_problems() {
        $('#composeModal').modal('show');
        refresh_fixed_tech_problems();
    }

    function update_submit_button() {
        let problem = $('#tp_problem_description').val().trim();
        let date = $('#tp_date').val().trim();
        let device = $('#tp_problem_device').val();
        $('#tp_report_problem').prop('disabled', !(problem.length > 0 && device.length > 0));
    }

    function refresh_tech_problems() {
        api_call('/api/get_tech_problems_admin', {}, function(data) {
            if (data.success) {
                $('#problems_here').empty();
                for (let entry of data.tech_problems) {
                    if (entry.problem.fixed == false) { 
                        let row = $('<tr>');
                        row.append($('<td>').text(moment(entry.problem.date).format('ddd, D.M.Y')));
                        row.append($('<td>').text(entry.display_name));
                        row.append($('<td>').text(entry.klasse));
                        row.append($('<td>').text(entry.problem.problem));
                        row.append($('<td>').text('' + entry.problem.device));

                        let tp_fixed = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-success').html("<i class='fa fa-check'></i>&nbsp;&nbsp;Behoben");
                        tp_fixed.data('token', entry.problem.token);
                        tp_fixed.click(function(e) {

                            api_call('/api/fix_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                                if (data.success)
                                    refresh_tech_problems();
                            });

                        });
                        row.append($('<td>').append(tp_fixed));

                        let tp_delete = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-danger').html("<i class='fa fa-trash'></i>&nbsp;&nbsp;Löschen");
                        tp_delete.data('token', entry.problem.token);
                        tp_delete.click(function(e) {
                            showTemplateModal('Problem löschen', 
                                'Bist Du sicher? Das Problem wird dabei unwiederrufbar gelöscht.',
                                "<i class='fa fa-trash'></i>&nbsp;&nbsp;Problem löschen", 'btn-danger',
                                'Abbrechen', 'btn-secondary', function() {
                                    api_call('/api/delete_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                    });
                                }
                            );
                        });
                        row.append($('<td>').append(tp_delete));
                        
                        $('#problems_here').append(row);
                    }
                }
            }
        });
    }

    function refresh_fixed_tech_problems() {
        api_call('/api/get_tech_problems_admin', {}, function(data) {
            if (data.success) {
                refresh_tech_problems();
                $('#fixed_problems_here').empty();
                for (let entry of data.tech_problems) {
                    if (entry.problem.fixed == true) { 
                        let row = $('<tr>');
                        row.append($('<td>').text(moment(entry.problem.date).format('ddd, D.M.Y')));
                        row.append($('<td>').text(entry.display_name));
                        row.append($('<td>').text(entry.klasse));
                        row.append($('<td>').text(entry.problem.problem));
                        row.append($('<td>').text('' + entry.problem.device));

                        let tp_fixed = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-warning').html("<i class='fa fa-times'></i>&nbsp;&nbsp;Nicht Behoben");
                        tp_fixed.data('token', entry.problem.token);
                        tp_fixed.click(function(e) {

                            api_call('/api/unfix_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                                if (data.success)
                                    refresh_fixed_tech_problems();
                                    refresh_tech_problems();
                            });

                        });
                        row.append($('<td>').append(tp_fixed));

                        let tp_delete = $('<button>').addClass('btn').addClass('btn-xs').addClass('btn-danger').html("<i class='fa fa-trash'></i>&nbsp;&nbsp;Löschen");
                        tp_delete.data('token', entry.problem.token);
                        tp_delete.click(function(e) {
                            showTemplateModal('Problem löschen', 
                                'Bist Du sicher? Das Problem wird dabei unwiederrufbar gelöscht.',
                                "<i class='fa fa-trash'></i>&nbsp;&nbsp;Problem löschen", 'btn-danger',
                                'Abbrechen', 'btn-secondary', function() {
                                    api_call('/api/delete_tech_problem_admin', {token: $(e.target).data('token')}, function(data) {
                                        if (data.success)
                                            refresh_tech_problems();
                                    });
                                }
                            );
                        });
                        row.append($('<td>').append(tp_delete));
                        
                        $('#fixed_problems_here').append(row);
                    }
                }
            }
        });
    }


document.addEventListener('DOMContentLoaded', function() {
    moment.locale('de');
    update_submit_button();
    $('#tp_problem_description').keyup(function(e) { update_submit_button(); });
    $('#tp_problem_descriptione').change(function(e) { update_submit_button(); });
    $('#tp_date').change(function(e) { update_submit_button(); });
    $('#tp_problem_device').keyup(function(e) { update_submit_button(); });
    $('#tp_problem_device').change(function(e) { update_submit_button(); });
    $('#tp_report_problem').click(function(e) {
        let problem = $('#tp_problem_description').val().trim();
        let date = $('#tp_date').val().trim();
        let device = $('#tp_problem_device').val();
        api_call('/api/report_tech_problem', {problem: problem, date: date, device: device}, function(data) {
            console.log(data);
            refresh_tech_problems();
        });
    });
    refresh_tech_problems();
    $('.bu-compose').click(function(e) {
        compose_fixed_problems();
    });
    })
</script>
