#{this_is_a_page_for_logged_in_teachers}
<style>
    #stage {
        text-align: center;
    }
    #sus-frame {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
    }
    .sus-foto {
        background-color: white;
        width: min(80vw, 50vh);
        height: calc(1.3 * min(80vw, 50vh));
        object-fit: cover;
        object-position: 50% 10%;
        border-radius: 3vw;
        box-shadow: 0 0 30px 0 rgba(0,0,0,1), inset 0 0 30px 0 rgba(0,0,0,0.5);
        border: 0.5em solid white;
    }
</style>
<div class='container-fluid' style='padding-top: 30px;'>
    <div class='row'>
        <div class="col-lg-2 col-md-12 side-panel">
        </div>
        <div class="col-lg-8 col-md-12">
            <form id='form' autocomplete='off'>
                <div class="input-group mb-3">
                    <input type="password" id='password' class="form-control" placeholder="Bitte gib das Passwort ein, um das Klassenmemory zu starten" style="text-align: center;">
                    <div class="input-group-append">
                        <button id='submit_password' class="btn btn-primary" type="submit">Passwort absenden</button>
                    </div>
                </div>
            </form>
            <div id='stage' style='display: none; margin-bottom: 30px;'>
                <div id="sus-frame">
                    <img id="sus-foto" class="sus-foto">
                </div>
                <div style="font-size: 2em;">LABEL</div>
            </div>
        </div>
        <div id="klassen-div" class="col-lg-2 col-md-12 side-panel timetable_chooser tablet_timetable_chooser">
        </div>
    </div>
</div>

<script>

var passphrase = '';
var FOTO_PASSWORD = #{FOTO_PASSWORD.to_json};
var KLASSEN_ORDER = #{KLASSEN_ORDER.to_json};
var KLASSEN_TR = #{KLASSEN_TR.to_json};

async function decryptData(encryptedData, password) {
    const enc = new TextEncoder();
    const salt = base64ToBytes(encryptedData.salt);
    const iv = base64ToBytes(encryptedData.iv);
    const ciphertext = base64ToBytes(encryptedData.data);
    const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password),
        {name: "PBKDF2", "hash": "SHA-1"}, false, ["deriveBits", "deriveKey"]);

    const key = await window.crypto.subtle.deriveKey({name: "PBKDF2", salt: salt,
        iterations: 20000, hash: "SHA-1", length: "256"}, keyMaterial, {name: "AES-CBC",
        hash: "SHA-1", length: 256}, true, ["encrypt", "decrypt"]);

    const decryptedData = await window.crypto.subtle.decrypt({name: "AES-CBC", iv: iv.buffer}, key, ciphertext.buffer);
    return new TextDecoder().decode(decryptedData);
}

function base64ToBytes(base64) {
    const binaryString = window.atob(base64);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes;
}

var foto_for_email = {};
var current_klasse = '5a';

window.addEventListener('load', function() {
    $('#password').focus();
    $('#submit_password').on('click', function(e) {
        e.preventDefault();
        passphrase = $('#password').val().trim();
        $('#form').hide();
        $('#stage').show();
        refresh();
    });
    if (FOTO_PASSWORD !== null) {
        $('#password').val(FOTO_PASSWORD);
        $('#submit_password').click();
    }
    for (let klasse of KLASSEN_ORDER) {
        let bu_klasse = $(`<button class='btn btn-sm ttc' style='margin: 0.2em;'>`).text(KLASSEN_TR[klasse] ?? klasse).data('klasse', klasse);
        bu_klasse.on('click', function(e) {
            current_klasse = $(e.target).closest('button').data('klasse');
            console.log(`refreshing ${klasse}!`);
            refresh();
        });
        $('#klassen-div').append(bu_klasse);
    }
    function refresh() {
        let url = `/api/fotos/2023-${current_klasse}-0.json`;
        console.log(url);
        $.get(url, function(data) {
            decryptData(data, passphrase).then(function(decrypted) {
                $('#sus-foto').attr('src', 'data:image/jpeg;base64,' + decrypted);
            }).catch(err => console.error(err));
        });
    }
});
</script>
