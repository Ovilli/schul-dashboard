#{File.read('/static/_bib_public_template.html')}
#{require_user_who_can_manage_bib!}
<style>
    #cover {
        box-shadow: 0 0 10px rgba(0,0,0,0.25);
        width: 100%;
        display: block;
    }
    #cover.none {
        padding-bottom: 130%;
    }
    #barcode_div {
        display: inline-block;
        width: calc(66% - 7px);
        margin-right: 7px;
        vertical-align: top;
    }
    #cover_div {
        display: inline-block;
        width: 33%;
        position: relative;
        left: 10px;
    }
    #author_div, #title_div {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    #stem_div {
        float: right;
        margin-left: 10px;
    }
    #title_div {
        font-weight: bold;
    }
    #author_div {
        margin-bottom: 10px;
    }
    ._barcode_widget {
        margin-bottom: 0px!important;
    }
    .thumb {
        width: calc((100vw - 30px) / 3.2);
        margin-right: 2px;
        margin-bottom: 2px;
        max-width: 150px;
    }
</style>
<div class='container bg-white'>
    <div class='row'>
        <div class="col-md-6">
            <div id="barcode_div">
                <div id='barcode_widget'></div>
            </div>
            <div id='cover_div'>
                <img id="cover"></img>
                <a id='cover_link' href='' class='btn btn-sm btn-success mt-1 w-100' style='display: none;'>Zum Buch…</a>
            </div>
        </div>
        <div class="col-md-6">
            <hr />
            <div id='unknown_book' style="display: none;">
                <div class="alert alert-danger">
                    Ein Buch mit der Stammsignatur <span id='unknown_stem'></span> befindet sich nicht im System.
                </div>
            </div>
            <div id='stem_div'></div>
            <div id='title_div'></div>
            <div id='author_div'></div>
            <div id='info_div' style="display: none;">
                <hr style='margin: 12px 0 5px 0;'/>
                <button id='bu_scan_isbn' class='pull-right btn btn-sm btn-success ml-1 mr-1'>ISBN scannen</button>
                <div id='info_isbn'></div>
                <hr style='margin: 12px 0 5px 0;'/>
                <button id='bu_set_shelf' style='display: none;' class='pull-right btn btn-sm btn-success ml-1 mr-1' disabled>Buch liegt in <span class="shelf_here"></span></button>
                <div id='info_shelf'></div>
                <hr style='margin: 12px 0 5px 0;'/>
                <button id='bu_take_photo' class='pull-right btn btn-sm btn-success ml-1 mr-1'>Cover fotografieren</button>
                <div id='info_cover'></div>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="photo_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style='z-index: 200000;'>
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Foto hochladen</h5>
        </div>
        <div class="modal-body">
            <img id="current_photo" />
            <div style="position: relative; width: 100%; text-align: center; top: -50px; margin-bottom: -40px;">
                <div id='bu_snapshot' class='btn bg-scarlet-500 shadow' style="border-radius: 100%; padding: 1px;">
                    <div class='btn bg-white' style="border-radius: 100%; padding: 1px;">
                        <div class='btn bg-scarlet-500 text-white' style="border-radius: 100%; width: 30px; height: 30px;">
                        </div>
                    </div>
                </div>
                <div id='bu_repeat_snapshot' class='btn bg-slate-900 shadow' style="border-radius: 100%; padding: 1px; display: none;">
                    <div class='btn bg-slate-800' style="border-radius: 100%; padding: 1px;">
                        <div class='btn bg-slate-900 text-slate-500' style="border-radius: 100%; width: 30px; height: 30px;">
                            <i class='fa fa-repeat' style="position: relative; left: -4px; top: -3px;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="button_container pull-right" style="margin-top: 15px;">
                <button id='bu_discard_photo' type="button" class="btn btn-secondary" data-dismiss="modal"><i class='fa fa-times'></i>&nbsp;&nbsp;Abbrechen</button>
                <button id='bu_submit_photo' type="button" class="btn btn-success"><i class='fa fa-send'></i>&nbsp;&nbsp;Hochladen</button>
            </div>
        </div>
      </div>
    </div>
</div>

<script>
    var divs_for_signature = {};
    var table = null;
    var scanning_isbn = false;
    var last_scanned_parts = null;
    var take_photo_interval = null;
    var current_image = null;
    var hold_photo = false;
    var current_shelf = null;

    function handle_scan_book(stem, data) {
        console.log(data);
        if (data.success) {
            $('#unknown_book').hide();
            $('#info_div').css('display', 'block');
            play_audio(beep1);
            let book = data.book;
            $('#stem_div').html(`<i class='fa fa-barcode'></i>&nbsp;&nbsp;${stem}`);
            let title = `${book.title}`;
            if (book.subtitle && book.subtitle.trim().length > 0)
                title += `– ${book.subtitle}`;
            $('#title_div').text(title);
            $('#author_div').text(book.author);
            if (book.isbn) {
                $('#info_isbn').html(`<i class='fa fa-check text-grass-500'></i>&nbsp;&nbsp;Buch hat eine ISBN`);
                $('#bu_scan_isbn').prop('disabled', true);
            } else {
                $('#info_isbn').html(`<i class='fa fa-times text-scarlet-500'></i>&nbsp;&nbsp;Buch hat keine ISBN`);
                $('#bu_scan_isbn').prop('disabled', false);
                if ((data.proposed_isbn || []).length > 0) {
                    $('#info_isbn').append(`, aber bereits Vorschläge: ${data.proposed_isbn.join(', ')}`);
                }
            }
            if (book.has_cover) {
                $('#cover').attr('src', `${BIB_HOST}/gen/covers/${book.stem}-400.jpg`).removeClass('none');
                $('#info_cover').html(`<i class='fa fa-check text-grass-500'></i>&nbsp;&nbsp;Buch hat ein Cover`);
                if ((data.book_photos || []).length > 0) {
                    $('#info_cover').append(`, aber es wurden Fotos hochgeladen:<br />`);
                }
            } else {
                $('#cover').attr('src', '').addClass('none');
                $('#info_cover').html(`<i class='fa fa-times text-scarlet-500'></i>&nbsp;&nbsp;Buch hat kein Cover`);
                if ((data.book_photos || []).length > 0) {
                    $('#info_cover').append(`, aber bereits Vorschläge:<br />`);
                }
            }
            if ((data.book_photos || []).length > 0) {
                $('#info_cover').append(`${data.book_photos.map(function(x) { return `<img class='thumb' src='${BIB_HOST}/gen/book-photos/${x.sha1}.jpg'></img>`;}).join('')}`);
            }
            $('#cover_link').attr('href', `/bib_book/${book.stem}`);
            $('#cover_link').show();
            if ((data.locations || []).length > 0) {
                $('#info_shelf').html(`<i class='fa fa-check text-grass-500'></i>&nbsp;&nbsp;Buch hat einen Lagerort: ${data.locations.map(function(x) { return create_location_span(x); }).join(' ')}`);
            } else {
                $('#info_shelf').html(`<i class='fa fa-times text-scarlet-500'></i>&nbsp;&nbsp;Buch hat keinen Lagerort`);
            }
        } else {
            play_audio(beep_fail);
            $('.api_messages').hide();
            $('#unknown_stem').text(stem);
            $('#unknown_book').show();
            $('#cover_link').hide();
        }
    }

    function on_scan(barcode, scanned) {
        if (scanning_isbn) {
            scanning_isbn = false;
            $('#bu_scan_isbn').prop('disabled', false);
            bib_api_call('/jwt/propose_isbn_for_stem', {stem: last_scanned_parts.stem, isbn: barcode}, function(data) {
                if (data.success) {
                    play_audio(beep1);
                    bib_api_call('/jwt/scan_book', last_scanned_parts, function (data) {
                        handle_scan_book(last_scanned_parts.stem, data);
                    });
                }
            });
            return;
        }
        if (barcode.indexOf('bib:') === 0) {
            current_shelf = barcode.replace('bib:', '');
            console.log(`current shelf: ${current_shelf}`);
            $('.shelf_here').text(current_shelf);
            $('#bu_set_shelf').show().prop('disabled', false);
            play_audio(beep1);
            return;
        }
        last_scanned_parts = null;
        let parts = fix_scanned_book_barcode(barcode);
        if (parts === null) {
            play_audio(beep_fail);
            return;
        }
        let data = {
            stem: parts.stem,
            bnr: parts.bnr
        };
        if (parts.checksum) data.checksum = parts.checksum;
        last_scanned_parts = parts;
        bib_api_call('/jwt/scan_book', data, function (data) {
            handle_scan_book(parts.stem, data);
        });
    }

    window.addEventListener('load', function () {
        let widget = new BarcodeWidget({
            element: $('#barcode_widget'),
            on_scan: on_scan
        });
        $('#bu_scan_isbn').click(function(e) {
            $('#bu_scan_isbn').prop('disabled', true);
            scanning_isbn = true;
        })
        $('#bu_take_photo').click(function(e) {
            take_photo_interval = setInterval(function() {
                if (hold_photo) return;
                let video = $('video')[0];
                let canvas = $('<canvas>');
                let width = video.videoWidth;
                let height = video.videoHeight;
                canvas.attr('width', width);
                canvas.attr('height', height);
                canvas[0].getContext('2d').drawImage(video, 0, 0, width, height);
                current_image = canvas[0].toDataURL('image/jpeg');
                $('#current_photo').attr('src', current_image);
            }, 20);
            hold_photo = false;
            $('#bu_submit_photo').prop('disabled', true);
            $('#bu_snapshot').show();
            $('#bu_repeat_snapshot').hide();
            $('#photo_modal').modal('show');
        });
        $('#bu_snapshot').click(function(e) {
            play_audio(beep2);
            hold_photo = true;
            $('#bu_snapshot').hide();
            $('#bu_repeat_snapshot').show();
            $('#bu_submit_photo').prop('disabled', false);
        });
        $('#bu_repeat_snapshot').click(function(e) {
            hold_photo = false;
            $('#bu_snapshot').show();
            $('#bu_repeat_snapshot').hide();
            $('#bu_submit_photo').prop('disabled', true);
        });
        $('#photo_modal').on('hidden.bs.modal', function() {
            clearInterval(take_photo_interval);
            take_photo_interval = null;
        });
        $('#bu_submit_photo').click(function(e) {
            $('#bu_submit_photo').attr('disabled', true);
            bib_api_call('/jwt/submit_photo_for_book', {stem: last_scanned_parts.stem, jpg: current_image}, function (data) {
                if (data.success) {
                    $('#bu_submit_photo').attr('disabled', false);
                    $('#photo_modal').modal('hide');
                    bib_api_call('/jwt/scan_book', last_scanned_parts, function (data) {
                        handle_scan_book(last_scanned_parts.stem, data);
                    });
                }
            });
        });
        $('#bu_set_shelf').click(function(e) {
            bib_api_call('/jwt/add_shelf_for_book', {stem: last_scanned_parts.stem, shelf: current_shelf}, function(data) {
                if (data.success) {
                    bib_api_call('/jwt/scan_book', last_scanned_parts, function (data) {
                        handle_scan_book(last_scanned_parts.stem, data);
                    });
                }
            });
        })
        if (#{DEVELOPMENT == '1'}) {
            // on_scan('bib:23F');
            // on_scan('3792-007');
        //     // on_scan('9999-016');
        //     // on_scan('1000-016');
        //     // on_scan('1053-016');
        }
        $('body').click(function() { play_audio(beep1);});
    });
</script>